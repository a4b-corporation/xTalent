$schema: "https://xtalent.io/schemas/workflow/v3"
$id: "xtalent:core:org-structure:update-business-unit"

workflow: UpdateBusinessUnit
module: CO
submodule: org-structure
version: "1.0"

description: |
  Updates business unit with SCD2 support and closure table management.
  Handles reorganizations and manager changes.

inputs:
  business_unit_id: {type: uuid, required: true}
  updates: {type: object, required: true}
  effective_date: {type: date, required: false, default: "today()"}
  reason: {type: string, required: true}

steps:
  - name: validate_updates
    type: validation
    validations:
      - check: "unit exists"
        query: "SELECT COUNT(*) FROM business_unit WHERE id = :business_unit_id AND is_current_flag = true"
        condition: "count = 1"
        
      - check: "new manager is active if provided"
        query: "SELECT COUNT(*) FROM employee WHERE id = :updates.manager_employee_id AND status_code = 'ACTIVE'"
        condition: "updates.manager_employee_id IS NULL OR count = 1"

  - name: check_scd2_fields
    type: computation
    logic: |
      scd2_fields = ['name', 'type_id', 'parent_id', 'path', 'manager_employee_id', 'legal_entity_code', 'status_code']
      needs_scd2 = any(field in updates for field in scd2_fields)

  - name: close_current_record
    type: database_operation
    condition: "needs_scd2 = true"
    operation: UPDATE
    table: org_bu.unit
    where: "id = :business_unit_id AND is_current_flag = true"
    data:
      effective_end_date: ":effective_date - 1 day"
      is_current_flag: false

  - name: create_new_version
    type: database_operation
    condition: "needs_scd2 = true"
    operation: INSERT
    table: org_bu.unit
    data:
      id: ":business_unit_id"
      # ... merge updates with current values
      effective_start_date: ":effective_date"
      is_current_flag: true

  - name: rebuild_closure_table_if_moved
    type: database_operation
    condition: "parent_id changed"
    operation: EXECUTE
    sql: "CALL rebuild_bu_hierarchy(:business_unit_id);"

  - name: emit_event
    type: event
    event: BusinessUnitUpdated
    payload:
      business_unit_id: ":business_unit_id"
      changes: ":updates"
      reason: ":reason"

authorization:
  required_roles: [HR_ADMIN, ORG_ADMIN]
  required_permissions: [business_unit.update]

metadata:
  created_at: "2025-12-25"
  transaction: true
