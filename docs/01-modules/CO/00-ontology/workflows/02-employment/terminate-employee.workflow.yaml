$schema: "https://xtalent.io/schemas/workflow/v3"
$id: "xtalent:core:employment:terminate-employee"

workflow: TerminateEmployee
module: CO
submodule: employment
version: "1.0"

description: "Terminates employee and ends all active relationships"

inputs:
  employee_id: {type: uuid, required: true}
  termination_date: {type: date, required: true}
  termination_reason: {type: string, required: true}

steps:
  - name: validate_employee
    type: validation
    validations:
      - check: "employee is active"
        query: "SELECT status_code FROM employee WHERE id = :employee_id"
        condition: "status_code IN ('ACTIVE', 'SUSPENDED', 'ON_LEAVE')"

  - name: update_employee_status
    type: database_operation
    operation: UPDATE
    table: employment.employee
    where: "id = :employee_id"
    data:
      status_code: "TERMINATED"
      termination_date: ":termination_date"

  - name: end_active_contracts
    type: database_operation
    operation: UPDATE
    table: employment.contract
    where: "employee_id = :employee_id AND end_date IS NULL"
    data:
      end_date: ":termination_date"

  - name: end_active_assignments
    type: database_operation
    operation: UPDATE
    table: employment.assignment
    where: "employee_id = :employee_id AND effective_end_date IS NULL"
    data:
      effective_end_date: ":termination_date"
      is_current_flag: false

  - name: emit_event
    type: event
    event: EmployeeTerminated
    payload:
      employee_id: ":employee_id"
      termination_date: ":termination_date"
      reason: ":termination_reason"

authorization:
  required_roles: [HR_ADMIN]

metadata:
  created_at: "2025-12-25"
  transaction: true
