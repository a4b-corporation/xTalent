$schema: "https://xtalent.io/schemas/workflow/v3"
$id: "xtalent:core:employment:create-employee"

workflow: CreateEmployee
module: CO
submodule: employment
version: "1.0"

description: "Creates a new employee record linking Worker to Legal Entity"

inputs:
  worker_id: {type: uuid, required: true}
  legal_entity_code: {type: string, required: true}
  employee_code: {type: string, required: true}
  worker_category_code: {type: string, required: true}
  employee_class_code: {type: string, required: true}
  hire_date: {type: date, required: true}
  metadata: {type: object, required: false}

steps:
  - name: validate_inputs
    type: validation
    validations:
      - check: "worker exists"
        query: "SELECT COUNT(*) FROM worker WHERE id = :worker_id"
        condition: "count = 1"
      - check: "employee_code unique in legal entity"
        query: "SELECT COUNT(*) FROM employee WHERE legal_entity_code = :legal_entity_code AND employee_code = :employee_code"
        condition: "count = 0"

  - name: create_employee
    type: database_operation
    operation: INSERT
    table: employment.employee
    data:
      id: "gen_random_uuid()"
      worker_id: ":worker_id"
      legal_entity_code: ":legal_entity_code"
      employee_code: ":employee_code"
      worker_category_code: ":worker_category_code"
      employee_class_code: ":employee_class_code"
      status_code: "PENDING"
      hire_date: ":hire_date"
      metadata: ":metadata"
    outputs:
      - employee_id: uuid

  - name: emit_event
    type: event
    event: EmployeeCreated
    payload:
      employee_id: ":employee_id"
      worker_id: ":worker_id"

authorization:
  required_roles: [HR_ADMIN]
  required_permissions: [employee.create]

metadata:
  created_at: "2025-12-25"
  transaction: true
