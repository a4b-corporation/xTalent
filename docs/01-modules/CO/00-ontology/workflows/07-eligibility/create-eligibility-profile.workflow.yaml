$schema: "https://xtalent.io/schemas/workflow/v3"
$id: "xtalent:core:eligibility:create-eligibility-profile"

workflow: CreateEligibilityProfile
module: CO
submodule: eligibility
version: "1.0"

description: "Creates eligibility profile with rule validation"

inputs:
  code: {type: string, required: true}
  name: {type: string, required: true}
  domain: {type: string, required: true}
  rule_json: {type: jsonb, required: true}
  priority: {type: integer, required: false, default: 10}

steps:
  - name: validate_inputs
    type: validation
    validations:
      - check: "code unique in domain"
        query: "SELECT COUNT(*) FROM eligibility_profile WHERE domain = :domain AND code = :code AND is_current_flag = true"
        condition: "count = 0"
      - check: "valid domain"
        condition: "domain IN ('ABSENCE', 'BENEFITS', 'COMPENSATION', 'CORE')"
      - check: "valid rule_json"
        condition: "jsonb_typeof(:rule_json) = 'object'"

  - name: create_profile
    type: database_operation
    operation: INSERT
    table: eligibility.eligibility_profile
    data:
      id: "gen_random_uuid()"
      code: ":code"
      name: ":name"
      domain: ":domain"
      rule_json: ":rule_json"
      priority: ":priority"
      is_active: false
      effective_start_date: "today()"
      is_current_flag: true
    outputs:
      - profile_id: uuid

  - name: emit_event
    type: event
    event: EligibilityProfileCreated
    payload:
      profile_id: ":profile_id"
      code: ":code"
      domain: ":domain"

authorization:
  required_roles: [HR_ADMIN, BENEFITS_ADMIN]

metadata:
  created_at: "2025-12-25"
  transaction: true
