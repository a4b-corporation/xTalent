$schema: "https://xtalent.io/schemas/action/v3"
$id: "xtalent:core:org-structure:create-legal-entity"

action: CreateLegalEntity
module: CO
submodule: org-structure
version: "1.0"

description: "Creates a new legal entity record in the database"

# ----------------------------------------------------------------------------
# INPUTS
# ----------------------------------------------------------------------------
inputs:
  code: {type: string, required: true}
  name_vi: {type: string, required: true}
  name_en: {type: string, required: false}
  type_id: {type: uuid, required: true}
  parent_id: {type: uuid, required: false}
  path: {type: string, required: true}
  effective_start_date: {type: date, required: true}

# ----------------------------------------------------------------------------
# OUTPUTS
# ----------------------------------------------------------------------------
outputs:
  legal_entity_id: {type: uuid}
  legal_entity: {type: object}

# ----------------------------------------------------------------------------
# PRECONDITIONS
# ----------------------------------------------------------------------------
preconditions:
  - condition: "code is unique"
    check: "NOT EXISTS(SELECT 1 FROM legal_entity WHERE code = :code AND is_current_flag = true)"
  - condition: "type exists"
    check: "EXISTS(SELECT 1 FROM entity_type WHERE id = :type_id AND is_current_flag = true)"
  - condition: "parent exists if provided"
    check: "parent_id IS NULL OR EXISTS(SELECT 1 FROM legal_entity WHERE id = :parent_id AND is_current_flag = true)"

# ----------------------------------------------------------------------------
# EFFECTS
# ----------------------------------------------------------------------------
effects:
  database:
    - operation: INSERT
      table: org_legal.entity
      data:
        id: "gen_random_uuid()"
        code: ":code"
        name_vi: ":name_vi"
        name_en: ":name_en"
        type_id: ":type_id"
        parent_id: ":parent_id"
        path: ":path"
        effective_start_date: ":effective_start_date"
        effective_end_date: null
        is_current_flag: true
        created_at: "now()"
        created_by: ":current_user_id"
      returns: [id]
  
  events:
    - event: LegalEntityCreated
      payload:
        legal_entity_id: ":id"
        code: ":code"
  
  audit:
    - action: CREATE
      entity_type: LegalEntity
      entity_id: ":id"

# ----------------------------------------------------------------------------
# AUTHORIZATION
# ----------------------------------------------------------------------------
authorization:
  required_roles: [LEGAL_ADMIN, HR_ADMIN]
  required_permissions: [legal_entity.create]

# ----------------------------------------------------------------------------
# API MAPPING
# ----------------------------------------------------------------------------
api:
  rest:
    method: POST
    path: "/api/v1/legal-entities"
    request_body: inputs
    response: outputs
    status_code: 201

metadata:
  created_at: "2025-12-25"
  transaction: true
  idempotent: false
