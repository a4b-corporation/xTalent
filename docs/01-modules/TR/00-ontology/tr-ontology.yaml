# Total Rewards Module (TR) - Ontology
# Version: 2.0 - Enterprise Best Practices
# Last Updated: 2025-12-03
# Module: Total Rewards - Compensation, Benefits, Equity, Recognition
# Description: Comprehensive total rewards management including fixed/variable compensation,
#              benefits, equity grants, recognition programs, and offer packages

module: TotalRewards
code: TR
description: |
  Total Rewards module manages all aspects of employee compensation and benefits including:
  - Fixed compensation (base salary, allowances)
  - Variable compensation (bonuses, commissions, equity)
  - Benefits (health, retirement, wellness, perks)
  - Recognition and rewards programs
  - Total rewards statements and offer packages
  - Multi-country tax and social insurance calculation rules

# =============================================================================
# MODULE STRUCTURE
# =============================================================================

sub_modules:
  
  CoreCompensation:
    description: "Fixed pay, grades, ranges, and compensation cycles"
    entities:
      - SalaryBasis
      - PayComponentDefinition
      - SalaryBasisComponentMap
      - ComponentDependency
      - ProrationRule
      - GradeVersion
      - GradeLadder
      - GradeLadderGrade
      - GradeLadderStep
      - PayRange
      - CompensationPlan
      - CompensationCycle
      - CompensationAdjustment
      - EmployeeCompensationSnapshot
      - SalaryHistory
      - BudgetAllocation
  
  CalculationRules:
    description: "Tax, social insurance, overtime, and proration calculation rules"
    entities:
      - CalculationRuleDefinition
      - ComponentCalculationRule
      - BasisCalculationRule
      - TaxCalculationCache
      - CountryConfiguration
      - HolidayCalendar
  
  VariablePay:
    description: "Bonuses, equity grants, and commissions"
    entities:
      - BonusPlan
      - BonusCycle
      - BonusPool
      - BonusAllocation
      - EquityGrant
      - EquityVestingEvent
      - EquityTransaction
      - CommissionPlan
      - CommissionTier
      - CommissionTransaction
  
  Benefits:
    description: "Health, retirement, wellness, and other benefits"
    entities:
      - BenefitPlan
      - BenefitOption
      - EligibilityProfile
      - PlanEligibility
      - Enrollment
      - EnrollmentPeriod
      - LifeEvent
      - EmployeeDependent
      - BenefitBeneficiary
      - ReimbursementRequest
      - ReimbursementLine
      - HealthcareClaimHeader
      - HealthcareClaimLine
  
  Recognition:
    description: "Recognition programs, points, and perks"
    entities:
      - RecognitionEventType
      - PerkCategory
      - PerkCatalog
      - PointAccount
      - RecognitionEvent
      - RewardPointTransaction
      - PerkRedemption
  
  OfferManagement:
    description: "Total rewards offer packages for new hires and retention"
    entities:
      - OfferTemplate
      - OfferTemplateEvent
      - OfferPackage
      - OfferEvent
      - OfferAcceptance
  
  TaxableBridge:
    description: "Bridge to payroll for taxable benefits"
    entities:
      - TaxableItem
  
  TotalRewardsStatement:
    description: "Total rewards statements and analytics"
    entities:
      - StatementConfiguration
      - StatementSection
      - StatementJob
      - StatementLine
  
  Deductions:
    description: "Employee deductions (loans, garnishments, advances)"
    entities:
      - DeductionType
      - EmployeeDeduction
      - DeductionSchedule
      - DeductionTransaction
  
  TaxWithholding:
    description: "Tax withholding and declarations"
    entities:
      - TaxWithholding
      - TaxDeclaration
      - TaxAdjustment
  
  Audit:
    description: "Audit trail for compliance"
    entities:
      - AuditLog

# =============================================================================
# ENTITY DEFINITIONS
# =============================================================================

entities:

  # ===========================================================================
  # CORE COMPENSATION SCHEMA
  # ===========================================================================

  SalaryBasis:
    description: |
      Defines salary structure basis (e.g., monthly, hourly, annual).
      Determines which pay components are included and how they're calculated.
    attributes:
      id:
        type: UUID
        required: true
        description: "Primary key"
      code:
        type: string
        required: true
        maxLength: 50
        description: "Unique salary basis code (e.g., MONTHLY_VN, HOURLY_US)"
      name:
        type: string
        required: true
        maxLength: 200
        description: "Salary basis name"
      frequency:
        type: enum
        required: true
        values: [HOURLY, DAILY, WEEKLY, BIWEEKLY, SEMIMONTHLY, MONTHLY, ANNUAL]
        description: "Pay frequency"
      currency:
        type: string
        required: true
        maxLength: 3
        description: "ISO 4217 currency code (VND, USD, SGD)"
      allow_components:
        type: boolean
        default: true
        description: "Whether additional components can be added"
      metadata:
        type: jsonb
        description: "Additional configuration (country-specific rules, etc.)"
      effective_start_date:
        type: date
        required: true
      effective_end_date:
        type: date
        required: false
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      components:
        target: SalaryBasisComponentMap
        cardinality: "1:N"
        description: "Pay components in this basis"
      calculationRules:
        target: BasisCalculationRule
        cardinality: "1:N"
        description: "Calculation rules for this basis"
    constraints:
      - name: "uk_salary_basis_code"
        type: unique
        fields: [code]
    businessRules:
      - "Salary basis code must be unique"
      - "Frequency must match country standards"
      - "Currency must match legal entity currency"
    indexes:
      - name: "idx_salary_basis_code"
        columns: [code]
      - name: "idx_salary_basis_frequency"
        columns: [frequency]
      - name: "idx_salary_basis_effective"
        columns: [effective_start_date, effective_end_date]

  PayComponentDefinition:
    description: |
      Defines individual pay components (base salary, allowances, bonuses, deductions).
      Includes calculation methods, tax treatment, and social insurance rules.
    attributes:
      id:
        type: UUID
        required: true
      code:
        type: string
        required: true
        maxLength: 50
        description: "Unique component code (e.g., BASE_SALARY, LUNCH_ALLOWANCE)"
      name:
        type: string
        required: true
        maxLength: 200
      component_type:
        type: enum
        required: true
        values: [BASE, ALLOWANCE, BONUS, EQUITY, DEDUCTION, OVERTIME, COMMISSION]
        description: "Component category"
      frequency:
        type: enum
        required: true
        values: [HOURLY, DAILY, MONTHLY, QUARTERLY, ANNUAL, ONE_TIME]
      taxable:
        type: boolean
        default: true
        description: "Whether component is taxable"
      prorated:
        type: boolean
        default: true
        description: "Whether component is prorated for partial periods"
      default_currency:
        type: string
        maxLength: 3
        description: "Default currency for this component"
      formula_json:
        type: jsonb
        description: "Simple component-specific formula (for basic calculations)"
      calculation_method:
        type: enum
        values: [FIXED, FORMULA, PERCENTAGE, HOURLY, DAILY, RATE_TABLE]
        description: "How component amount is calculated"
      proration_method:
        type: enum
        values: [CALENDAR_DAYS, WORKING_DAYS, NONE]
        description: "Proration calculation method"
      tax_treatment:
        type: enum
        values: [FULLY_TAXABLE, TAX_EXEMPT, PARTIALLY_EXEMPT]
        description: "Tax treatment category"
      tax_exempt_threshold:
        type: decimal
        precision: [18, 4]
        description: "Tax-exempt amount threshold (e.g., 730,000 VND for lunch)"
      is_subject_to_si:
        type: boolean
        default: false
        description: "Subject to social insurance calculation"
      si_calculation_basis:
        type: enum
        values: [FULL_AMOUNT, CAPPED, EXCLUDED]
        description: "How SI is calculated for this component"
      display_order:
        type: integer
        description: "Display order on payslip"
      metadata:
        type: jsonb
      effective_start_date:
        type: date
        required: true
      effective_end_date:
        type: date
      is_active:
        type: boolean
        default: true
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      salaryBases:
        target: SalaryBasisComponentMap
        cardinality: "1:N"
        description: "Salary bases using this component"
      calculationRules:
        target: ComponentCalculationRule
        cardinality: "1:N"
        description: "Calculation rules for this component"
    constraints:
      - name: "uk_pay_component_code"
        type: unique
        fields: [code]
    businessRules:
      - "Component code must be unique"
      - "Tax-exempt threshold only applies to PARTIALLY_EXEMPT"
      - "SI calculation basis required if is_subject_to_si = true"
    indexes:
      - name: "idx_pay_component_code"
        columns: [code]
      - name: "idx_pay_component_type"
        columns: [component_type]
      - name: "idx_pay_component_active"
        columns: [is_active]
        where: "is_active = true"
      - name: "idx_pay_component_taxable"
        columns: [taxable]
      - name: "idx_pay_component_si"
        columns: [is_subject_to_si]

  SalaryBasisComponentMap:
    description: |
      Maps pay components to salary basis with specific rules.
      Allows component-level overrides for proration and calculation.
    attributes:
      salary_basis_id:
        type: UUID
        required: true
        description: "FK to SalaryBasis"
      component_id:
        type: UUID
        required: true
        description: "FK to PayComponentDefinition"
      mandatory_flag:
        type: boolean
        default: false
        description: "Whether component is mandatory for this basis"
      default_proration:
        type: boolean
        default: false
        description: "Legacy proration flag"
      sort_order:
        type: integer
        default: 0
        description: "Display order in basis"
      enable_proration:
        type: boolean
        description: "Override component's proration setting"
      proration_method:
        type: enum
        values: [CALENDAR_DAYS, WORKING_DAYS, NONE]
        description: "Override component's proration method"
      calculation_order:
        type: integer
        description: "Sequence in calculation flow (1=first, 2=second, etc.)"
      display_order:
        type: integer
        description: "Display order in this basis"
      custom_formula_json:
        type: jsonb
        description: "Basis-specific formula override"
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
    relationships:
      salaryBasis:
        target: SalaryBasis
        cardinality: "N:1"
      component:
        target: PayComponentDefinition
        cardinality: "N:1"
    constraints:
      - name: "uk_basis_component"
        type: unique
        fields: [salary_basis_id, component_id]
    businessRules:
      - "Each component can appear only once per salary basis"
      - "Calculation order determines execution sequence"
    indexes:
      - name: "idx_basis_component_basis"
        columns: [salary_basis_id]
      - name: "idx_basis_component_component"
        columns: [component_id]
      - name: "idx_basis_component_calc_order"
        columns: [salary_basis_id, calculation_order]

  GradeVersion:
    description: |
      Versioned grade definition using SCD Type 2.
      Maintains complete history of grade changes over time.
    attributes:
      id:
        type: UUID
        required: true
      grade_code:
        type: string
        required: true
        maxLength: 20
        description: "Grade code (e.g., G1, G2, M1, T5)"
      name:
        type: string
        required: true
        maxLength: 100
      description:
        type: text
      job_level:
        type: integer
        description: "Hierarchy level for ordering (1=entry, 10=executive)"
      sort_order:
        type: integer
        default: 0
      metadata:
        type: jsonb
      effective_start_date:
        type: date
        required: true
      effective_end_date:
        type: date
      version_number:
        type: integer
        default: 1
        description: "SCD Type 2 version number"
      previous_version_id:
        type: UUID
        description: "FK to previous version (SCD Type 2 chain)"
      is_current_version:
        type: boolean
        default: true
        description: "True for current version only"
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      previousVersion:
        target: GradeVersion
        cardinality: "N:1"
        description: "Previous version in SCD Type 2 chain"
      payRanges:
        target: PayRange
        cardinality: "1:N"
        description: "Pay ranges for this grade"
      ladderGrades:
        target: GradeLadderGrade
        cardinality: "1:N"
        description: "Ladder assignments"
    constraints:
      - name: "uk_grade_code_current"
        type: unique
        fields: [grade_code]
        where: "is_current_version = true"
    businessRules:
      - "Only one current version per grade_code"
      - "effective_end_date must be NULL for current version"
      - "New version's effective_start_date = previous version's effective_end_date + 1 day"
    indexes:
      - name: "idx_grade_code"
        columns: [grade_code, effective_start_date]
      - name: "idx_grade_current"
        columns: [grade_code]
        where: "is_current_version = true"
        unique: true
      - name: "idx_grade_job_level"
        columns: [job_level]
    audit:
      scd_type: 2
      version_field: version_number
      previous_version_field: previous_version_id
      current_flag_field: is_current_version

  GradeLadder:
    description: |
      Career ladder defining progression path through grades.
      Supports multiple ladder types (management, technical, specialist).
    attributes:
      id:
        type: UUID
        required: true
      code:
        type: string
        required: true
        maxLength: 50
      name:
        type: string
        required: true
        maxLength: 200
      description:
        type: text
      ladder_type:
        type: enum
        values: [MANAGEMENT, TECHNICAL, SPECIALIST, SALES, EXECUTIVE]
        description: "Career track type"
      metadata:
        type: jsonb
      effective_start_date:
        type: date
        required: true
      effective_end_date:
        type: date
      is_active:
        type: boolean
        default: true
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      grades:
        target: GradeLadderGrade
        cardinality: "1:N"
        description: "Grades in this ladder"
      steps:
        target: GradeLadderStep
        cardinality: "1:N"
        description: "Steps within grades"
    constraints:
      - name: "uk_grade_ladder_code"
        type: unique
        fields: [code]
    indexes:
      - name: "idx_grade_ladder_code"
        columns: [code]
      - name: "idx_grade_ladder_type"
        columns: [ladder_type]
      - name: "idx_grade_ladder_active"
        columns: [is_active]
        where: "is_active = true"

  GradeLadderGrade:
    description: |
      Associates grades with ladders in specific order.
      Defines progression sequence within a career track.
    attributes:
      id:
        type: UUID
        required: true
      ladder_id:
        type: UUID
        required: true
      grade_v_id:
        type: UUID
        required: true
        description: "FK to GradeVersion"
      sort_order:
        type: integer
        default: 0
        description: "Position in ladder (1=entry, higher=senior)"
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
    relationships:
      ladder:
        target: GradeLadder
        cardinality: "N:1"
      grade:
        target: GradeVersion
        cardinality: "N:1"
    constraints:
      - name: "uk_ladder_grade"
        type: unique
        fields: [ladder_id, grade_v_id]
    indexes:
      - name: "idx_ladder_grade_ladder"
        columns: [ladder_id, sort_order]
      - name: "idx_ladder_grade_grade"
        columns: [grade_v_id]

  GradeLadderStep:
    description: |
      Defines salary steps within a grade for progression.
      Allows incremental increases within same grade level.
    attributes:
      id:
        type: UUID
        required: true
      ladder_id:
        type: UUID
        required: true
      grade_v_id:
        type: UUID
        required: true
      step_number:
        type: integer
        required: true
        description: "Step number within grade (1, 2, 3...)"
      step_name:
        type: string
        maxLength: 100
        description: "Optional step name (e.g., Entry, Mid, Senior)"
      step_amount:
        type: decimal
        precision: [18, 4]
        description: "Salary amount for this step"
      currency:
        type: string
        maxLength: 3
      effective_start_date:
        type: date
        required: true
      effective_end_date:
        type: date
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      ladder:
        target: GradeLadder
        cardinality: "N:1"
      grade:
        target: GradeVersion
        cardinality: "N:1"
    constraints:
      - name: "uk_ladder_grade_step"
        type: unique
        fields: [ladder_id, grade_v_id, step_number, effective_start_date]
    indexes:
      - name: "idx_ladder_step_ladder"
        columns: [ladder_id, step_number]
      - name: "idx_ladder_step_grade"
        columns: [grade_v_id]

  PayRange:
    description: |
      Defines salary range (min/mid/max) for a grade.
      Supports multiple scopes: global, legal entity, business unit, position.
    attributes:
      id:
        type: UUID
        required: true
      grade_v_id:
        type: UUID
        required: true
      scope_type:
        type: enum
        required: true
        values: [GLOBAL, LEGAL_ENTITY, BUSINESS_UNIT, POSITION]
        description: "Scope of pay range applicability"
      scope_uuid:
        type: UUID
        required: true
        description: "ID of scope entity (legal_entity_id, business_unit_id, etc.)"
      currency:
        type: string
        required: true
        maxLength: 3
      min_amount:
        type: decimal
        required: true
        precision: [18, 4]
      mid_amount:
        type: decimal
        required: true
        precision: [18, 4]
      max_amount:
        type: decimal
        required: true
        precision: [18, 4]
      range_spread_pct:
        type: decimal
        precision: [5, 2]
        description: "Calculated: (max-min)/mid*100"
      metadata:
        type: jsonb
      effective_start_date:
        type: date
        required: true
      effective_end_date:
        type: date
      is_active:
        type: boolean
        default: true
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      grade:
        target: GradeVersion
        cardinality: "N:1"
    constraints:
      - name: "chk_pay_range_amounts"
        type: check
        expression: "min_amount < mid_amount AND mid_amount < max_amount"
    businessRules:
      - "min_amount < mid_amount < max_amount"
      - "range_spread_pct = (max_amount - min_amount) / mid_amount * 100"
      - "Currency must match scope entity currency"
    indexes:
      - name: "idx_pay_range_grade"
        columns: [grade_v_id, scope_type, scope_uuid, effective_start_date]
      - name: "idx_pay_range_scope"
        columns: [scope_type, scope_uuid]
      - name: "idx_pay_range_active"
        columns: [grade_v_id, is_active]
        where: "is_active = true"

  CompensationPlan:
    description: |
      Defines compensation review plan type and rules.
      Supports merit, promotion, market adjustment, and ad-hoc reviews.
    attributes:
      id:
        type: UUID
        required: true
      code:
        type: string
        required: true
        maxLength: 50
      name:
        type: string
        required: true
        maxLength: 200
      description:
        type: text
      plan_type:
        type: enum
        required: true
        values: [MERIT, PROMOTION, MARKET_ADJUSTMENT, NEW_HIRE, EQUITY_CORRECTION, AD_HOC]
      eligibility_rule:
        type: jsonb
        description: "Who is eligible for this plan (tenure, performance, etc.)"
      guideline_json:
        type: jsonb
        description: "Merit matrices, guidelines, approval thresholds"
      metadata:
        type: jsonb
      effective_start_date:
        type: date
        required: true
      effective_end_date:
        type: date
      is_active:
        type: boolean
        default: true
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      cycles:
        target: CompensationCycle
        cardinality: "1:N"
    constraints:
      - name: "uk_comp_plan_code"
        type: unique
        fields: [code]
    indexes:
      - name: "idx_comp_plan_code"
        columns: [code]
      - name: "idx_comp_plan_type"
        columns: [plan_type]
      - name: "idx_comp_plan_active"
        columns: [is_active]
        where: "is_active = true"

  CompensationCycle:
    description: |
      Specific instance of a compensation plan for a time period.
      Manages budget, workflow, and approval status.
    attributes:
      id:
        type: UUID
        required: true
      plan_id:
        type: UUID
        required: true
      code:
        type: string
        required: true
        maxLength: 50
        description: "Cycle identifier (e.g., MERIT_2025_Q1)"
      name:
        type: string
        required: true
        maxLength: 200
      description:
        type: text
      period_start:
        type: date
        required: true
        description: "Review period start"
      period_end:
        type: date
        required: true
        description: "Review period end"
      effective_date:
        type: date
        required: true
        description: "When adjustments take effect"
      budget_amount:
        type: decimal
        precision: [18, 4]
      budget_currency:
        type: string
        maxLength: 3
      workflow_state:
        type: jsonb
        description: "Current workflow state and history"
      status:
        type: enum
        default: DRAFT
        values: [DRAFT, OPEN, IN_REVIEW, APPROVED, CLOSED, CANCELLED]
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
      closed_date:
        type: timestamp
      closed_by:
        type: UUID
    relationships:
      plan:
        target: CompensationPlan
        cardinality: "N:1"
      adjustments:
        target: CompensationAdjustment
        cardinality: "1:N"
      budgetAllocations:
        target: BudgetAllocation
        cardinality: "1:N"
    constraints:
      - name: "uk_comp_cycle_code"
        type: unique
        fields: [code]
    businessRules:
      - "period_end must be after period_start"
      - "effective_date typically after period_end"
      - "Cannot reopen CLOSED cycle"
    indexes:
      - name: "idx_comp_cycle_plan"
        columns: [plan_id]
      - name: "idx_comp_cycle_code"
        columns: [code]
      - name: "idx_comp_cycle_status"
        columns: [status]
      - name: "idx_comp_cycle_period"
        columns: [period_start, period_end]
      - name: "idx_comp_cycle_effective"
        columns: [effective_date]

  CompensationAdjustment:
    description: |
      Individual compensation adjustment proposal within a cycle.
      Tracks current, proposed amounts and approval workflow.
    attributes:
      id:
        type: UUID
        required: true
      cycle_id:
        type: UUID
        required: true
      employee_id:
        type: UUID
        required: true
        description: "FK to Core.Employee"
      assignment_id:
        type: UUID
        required: true
        description: "FK to Core.Assignment (for grade context)"
      component_id:
        type: UUID
        required: true
      current_amount:
        type: decimal
        precision: [18, 4]
        description: "Current component amount"
      proposed_amount:
        type: decimal
        required: true
        precision: [18, 4]
        description: "Proposed new amount"
      increase_amount:
        type: decimal
        precision: [18, 4]
        description: "Computed: proposed - current"
      increase_pct:
        type: decimal
        precision: [7, 4]
        description: "Computed: (proposed - current) / current * 100"
      currency:
        type: string
        required: true
        maxLength: 3
      rationale_code:
        type: string
        maxLength: 50
        description: "Standardized reason code (MERIT, PROMOTION, MARKET, etc.)"
      rationale_text:
        type: text
        description: "Detailed rationale"
      approval_status:
        type: enum
        default: PENDING
        values: [DRAFT, PENDING, APPROVED, REJECTED, WITHDRAWN]
      workflow_state:
        type: jsonb
      submitted_date:
        type: timestamp
      submitted_by:
        type: UUID
      approver_emp_id:
        type: UUID
        description: "FK to Core.Employee (approver)"
      decision_date:
        type: timestamp
      decision_note:
        type: text
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      cycle:
        target: CompensationCycle
        cardinality: "N:1"
      employee:
        target: Core.Employee
        cardinality: "N:1"
      assignment:
        target: Core.Assignment
        cardinality: "N:1"
      component:
        target: PayComponentDefinition
        cardinality: "N:1"
      approver:
        target: Core.Employee
        cardinality: "N:1"
    businessRules:
      - "increase_amount = proposed_amount - current_amount"
      - "increase_pct = (proposed_amount - current_amount) / current_amount * 100"
      - "Cannot modify APPROVED adjustment"
    indexes:
      - name: "idx_comp_adj_cycle"
        columns: [cycle_id, employee_id]
      - name: "idx_comp_adj_status"
        columns: [cycle_id, approval_status]
      - name: "idx_comp_adj_employee"
        columns: [employee_id]
      - name: "idx_comp_adj_approver"
        columns: [approver_emp_id]
      - name: "idx_comp_adj_assignment"
        columns: [assignment_id]

  EmployeeCompensationSnapshot:
    description: |
      Point-in-time snapshot of employee compensation.
      Created from approved adjustments or offer packages.
      Uses effective dating for temporal tracking.
    attributes:
      id:
        type: UUID
        required: true
      employee_id:
        type: UUID
        required: true
      assignment_id:
        type: UUID
        required: true
      component_id:
        type: UUID
        required: true
      amount:
        type: decimal
        required: true
        precision: [18, 4]
      currency:
        type: string
        required: true
        maxLength: 3
      frequency:
        type: enum
        required: true
        values: [HOURLY, DAILY, MONTHLY, ANNUAL]
      status:
        type: enum
        required: true
        values: [PLANNED, ACTIVE, EXPIRED]
      source_type:
        type: enum
        values: [COMP_ADJUSTMENT, OFFER_PACKAGE, MASS_UPLOAD, MANUAL, PROMOTION, TRANSFER]
        description: "How this snapshot was created"
      source_ref:
        type: string
        maxLength: 100
        description: "Reference to source record (adjustment_id, offer_id, etc.)"
      effective_start_date:
        type: date
        required: true
      effective_end_date:
        type: date
      metadata:
        type: jsonb
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      employee:
        target: Core.Employee
        cardinality: "N:1"
      assignment:
        target: Core.Assignment
        cardinality: "N:1"
      component:
        target: PayComponentDefinition
        cardinality: "N:1"
    businessRules:
      - "Only one ACTIVE snapshot per employee+component at any time"
      - "effective_end_date must be NULL for ACTIVE status"
      - "New snapshot ends previous snapshot (SCD Type 2 pattern)"
    indexes:
      - name: "idx_emp_comp_employee"
        columns: [employee_id, component_id, effective_start_date]
      - name: "idx_emp_comp_active"
        columns: [employee_id, status, effective_start_date]
        where: "status = 'ACTIVE'"
      - name: "idx_emp_comp_component"
        columns: [component_id, status]
      - name: "idx_emp_comp_effective"
        columns: [effective_start_date, effective_end_date]
      - name: "idx_emp_comp_assignment"
        columns: [assignment_id]
      - name: "idx_emp_comp_source"
        columns: [source_type, source_ref]

  BudgetAllocation:
    description: |
      Budget allocation and tracking by organizational scope.
      Monitors budget utilization during compensation cycles.
    attributes:
      id:
        type: UUID
        required: true
      cycle_id:
        type: UUID
        required: true
      scope_type:
        type: enum
        required: true
        values: [GLOBAL, LEGAL_ENTITY, BUSINESS_UNIT, DEPARTMENT, TEAM]
      scope_uuid:
        type: UUID
        description: "ID of scope entity"
      allocated_amount:
        type: decimal
        required: true
        precision: [18, 4]
      utilized_amount:
        type: decimal
        default: 0
        precision: [18, 4]
      utilization_pct:
        type: decimal
        precision: [5, 2]
        description: "Computed: (utilized/allocated)*100"
      currency:
        type: string
        required: true
        maxLength: 3
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
    relationships:
      cycle:
        target: CompensationCycle
        cardinality: "N:1"
    constraints:
      - name: "uk_budget_allocation"
        type: unique
        fields: [cycle_id, scope_type, scope_uuid]
    businessRules:
      - "utilization_pct = (utilized_amount / allocated_amount) * 100"
      - "utilized_amount cannot exceed allocated_amount (warning)"
    indexes:
      - name: "idx_budget_alloc_cycle"
        columns: [cycle_id]
      - name: "idx_budget_alloc_scope"
        columns: [scope_type, scope_uuid]

# Continue in next message due to length...

  # NEW ENTITIES - Addressing Design Review Gaps

  ComponentDependency:
    description: |
      Defines calculation dependencies between pay components.
      Ensures components are calculated in correct order when one depends on another.
      Example: Overtime allowance depends on base salary being calculated first.
    attributes:
      id:
        type: UUID
        required: true
      component_id:
        type: UUID
        required: true
        description: "FK to PayComponentDefinition (dependent component)"
      depends_on_component_id:
        type: UUID
        required: true
        description: "FK to PayComponentDefinition (prerequisite component)"
      dependency_type:
        type: enum
        required: true
        values: [CALCULATION_ORDER, VALUE_REFERENCE, CONDITIONAL]
        description: "Type of dependency"
      dependency_rule:
        type: jsonb
        description: "Dependency logic (e.g., 'OT_ALLOWANCE = BASE_SALARY * OT_HOURS * 1.5')"
      is_active:
        type: boolean
        default: true
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      component:
        target: PayComponentDefinition
        cardinality: "N:1"
        description: "Dependent component"
      dependsOnComponent:
        target: PayComponentDefinition
        cardinality: "N:1"
        description: "Prerequisite component"
    constraints:
      - name: "uk_component_dependency"
        type: unique
        fields: [component_id, depends_on_component_id]
      - name: "chk_no_self_dependency"
        type: check
        expression: "component_id != depends_on_component_id"
    businessRules:
      - "Component cannot depend on itself"
      - "Circular dependencies are not allowed"
      - "Dependency chain must be acyclic (DAG)"
      - "Calculation order determined by topological sort of dependency graph"
    indexes:
      - name: "idx_comp_dep_component"
        columns: [component_id]
      - name: "idx_comp_dep_depends_on"
        columns: [depends_on_component_id]
      - name: "idx_comp_dep_active"
        columns: [is_active]
        where: "is_active = true"

  ProrationRule:
    description: |
      Structured proration rules for partial period calculations.
      Replaces metadata-based proration logic with explicit, auditable rules.
      Supports multiple proration methods per country/jurisdiction.
    attributes:
      id:
        type: UUID
        required: true
      code:
        type: string
        required: true
        maxLength: 50
        description: "Unique rule code (e.g., VN_CALENDAR_DAYS, US_WORKING_DAYS)"
      name:
        type: string
        required: true
        maxLength: 200
      proration_method:
        type: enum
        required: true
        values: [CALENDAR_DAYS, WORKING_DAYS, ACTUAL_HOURS, PERCENTAGE, NONE]
        description: "Proration calculation method"
      country_code:
        type: string
        maxLength: 2
        description: "ISO country code (VN, US, SG) - NULL for global"
      jurisdiction:
        type: string
        maxLength: 50
        description: "State/Province if applicable"
      formula_json:
        type: jsonb
        required: true
        description: |
          Proration formula:
          {
            "method": "CALENDAR_DAYS",
            "numerator": "days_worked",
            "denominator": "days_in_month",
            "exclude_holidays": true,
            "exclude_weekends": false,
            "rounding": "ROUND_HALF_UP",
            "decimal_places": 4
          }
      description:
        type: text
      legal_reference:
        type: text
        description: "Legal citation (e.g., 'Labor Code Article 97')"
      effective_start_date:
        type: date
        required: true
      effective_end_date:
        type: date
      is_active:
        type: boolean
        default: true
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      components:
        target: PayComponentDefinition
        cardinality: "1:N"
        description: "Components using this proration rule"
    constraints:
      - name: "uk_proration_rule_code"
        type: unique
        fields: [code]
    businessRules:
      - "Proration rule code must be unique"
      - "Country-specific rules override global rules"
      - "Formula must be valid JSON with required fields"
    indexes:
      - name: "idx_proration_rule_code"
        columns: [code]
      - name: "idx_proration_rule_method"
        columns: [proration_method]
      - name: "idx_proration_rule_country"
        columns: [country_code, jurisdiction]
      - name: "idx_proration_rule_active"
        columns: [is_active]
        where: "is_active = true"
    examples:
      - code: "VN_CALENDAR_DAYS"
        name: "Vietnam Calendar Days Proration"
        method: "CALENDAR_DAYS"
        formula:
          numerator: "days_worked"
          denominator: "days_in_month"
          exclude_holidays: true
          exclude_weekends: false
      - code: "US_WORKING_DAYS"
        name: "US Working Days Proration"
        method: "WORKING_DAYS"
        formula:
          numerator: "working_days_worked"
          denominator: "working_days_in_month"
          exclude_holidays: true
          exclude_weekends: true

  SalaryHistory:
    description: |
      Dedicated salary change history table for audit and reporting.
      Provides quick access to salary progression without querying snapshots.
      Complements EmployeeCompensationSnapshot with summary view.
    attributes:
      id:
        type: UUID
        required: true
      employee_id:
        type: UUID
        required: true
        description: "FK to Core.Employee"
      assignment_id:
        type: UUID
        required: true
        description: "FK to Core.Assignment"
      change_date:
        type: date
        required: true
        description: "Date when salary change became effective"
      change_type:
        type: enum
        required: true
        values: [NEW_HIRE, MERIT_INCREASE, PROMOTION, MARKET_ADJUSTMENT, TRANSFER, DEMOTION, CORRECTION, AD_HOC]
        description: "Type of salary change"
      previous_base_salary:
        type: decimal
        precision: [18, 4]
        description: "Base salary before change"
      new_base_salary:
        type: decimal
        required: true
        precision: [18, 4]
        description: "Base salary after change"
      increase_amount:
        type: decimal
        precision: [18, 4]
        description: "Computed: new_base_salary - previous_base_salary"
      increase_pct:
        type: decimal
        precision: [7, 4]
        description: "Computed: (new - previous) / previous * 100"
      previous_grade_id:
        type: UUID
        description: "FK to GradeVersion (grade before change)"
      new_grade_id:
        type: UUID
        description: "FK to GradeVersion (grade after change)"
      currency:
        type: string
        required: true
        maxLength: 3
      source_type:
        type: enum
        required: true
        values: [COMP_CYCLE, OFFER_PACKAGE, PROMOTION, TRANSFER, MANUAL]
        description: "Source of change"
      source_ref:
        type: string
        maxLength: 100
        description: "Reference to source record (cycle_id, offer_id, etc.)"
      rationale:
        type: text
        description: "Reason for salary change"
      approved_by:
        type: UUID
        description: "FK to Core.Employee (approver)"
      approved_date:
        type: timestamp
      metadata:
        type: jsonb
        description: "Additional context (performance rating, market data, etc.)"
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
    relationships:
      employee:
        target: Core.Employee
        cardinality: "N:1"
      assignment:
        target: Core.Assignment
        cardinality: "N:1"
      previousGrade:
        target: GradeVersion
        cardinality: "N:1"
      newGrade:
        target: GradeVersion
        cardinality: "N:1"
      approver:
        target: Core.Employee
        cardinality: "N:1"
    businessRules:
      - "increase_amount = new_base_salary - previous_base_salary"
      - "increase_pct = (new_base_salary - previous_base_salary) / previous_base_salary * 100"
      - "change_date must be >= employee hire date"
      - "NEW_HIRE type should have NULL previous_base_salary"
    indexes:
      - name: "idx_salary_history_employee"
        columns: [employee_id, change_date]
      - name: "idx_salary_history_assignment"
        columns: [assignment_id]
      - name: "idx_salary_history_change_type"
        columns: [change_type]
      - name: "idx_salary_history_change_date"
        columns: [change_date]
      - name: "idx_salary_history_source"
        columns: [source_type, source_ref]
      - name: "idx_salary_history_approver"
        columns: [approved_by]

# Continue in next message due to length...

  # ===========================================================================
  # CALCULATION RULES SCHEMA
  # ===========================================================================

  CalculationRuleDefinition:
    description: |
      Global calculation rules for tax, social insurance, overtime, proration, etc.
      Supports multi-country rules with versioning (SCD Type 2).
      Stores actual calculation logic in formula_json.
    attributes:
      id:
        type: UUID
        required: true
      code:
        type: string
        required: true
        maxLength: 50
        description: "Unique rule code (e.g., VN_PIT_2025, SG_CPF_2025, VN_OT_MULT_2019)"
      name:
        type: string
        required: true
        maxLength: 200
      rule_category:
        type: enum
        required: true
        values: [TAX, SOCIAL_INSURANCE, PRORATION, OVERTIME, ROUNDING, FOREX, ANNUALIZATION, GROSS_TO_NET]
        description: "Rule category"
      rule_type:
        type: enum
        required: true
        values: [FORMULA, LOOKUP_TABLE, CONDITIONAL, RATE_TABLE, PROGRESSIVE, TIERED]
        description: "Rule execution type"
      country_code:
        type: string
        maxLength: 2
        description: "ISO country code (VN, SG, US) - NULL for global rules"
      jurisdiction:
        type: string
        maxLength: 50
        description: "State/Province/City if applicable"
      formula_json:
        type: jsonb
        required: true
        description: |
          Actual calculation logic/data. Structure varies by rule_type:
          
          PROGRESSIVE (Tax brackets):
          {
            "brackets": [
              {"min": 0, "max": 5000000, "rate": 0.05},
              {"min": 5000001, "max": 10000000, "rate": 0.10}
            ],
            "personal_deduction": 15500000,
            "dependent_deduction": 6200000
          }
          
          RATE_TABLE (Social Insurance):
          {
            "employee": {"si_rate": 0.08, "hi_rate": 0.015, "ui_rate": 0.01},
            "employer": {"si_rate": 0.14, "hi_rate": 0.03, "ui_rate": 0.01},
            "min_base": 2340000,
            "max_base": 46800000
          }
          
          LOOKUP_TABLE (Overtime multipliers):
          {
            "weekday_normal": 1.5,
            "weekday_night": 1.95,
            "weekend": 2.0,
            "holiday": 3.0
          }
      description:
        type: text
      legal_reference:
        type: text
        description: "Legal citation (e.g., 'Article 107, Labor Code 2019')"
      effective_start_date:
        type: date
        required: true
      effective_end_date:
        type: date
        description: "NULL = still effective"
      version_number:
        type: integer
        default: 1
        description: "Version tracking"
      previous_version_id:
        type: UUID
        description: "FK to previous version (SCD Type 2 chain)"
      is_current_version:
        type: boolean
        default: true
      metadata:
        type: jsonb
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      previousVersion:
        target: CalculationRuleDefinition
        cardinality: "N:1"
        description: "Previous version in SCD Type 2 chain"
      componentRules:
        target: ComponentCalculationRule
        cardinality: "1:N"
        description: "Components using this rule"
      basisRules:
        target: BasisCalculationRule
        cardinality: "1:N"
        description: "Salary bases using this rule"
      cache:
        target: TaxCalculationCache
        cardinality: "1:N"
        description: "Cached calculations"
    constraints:
      - name: "uk_calc_rule_code"
        type: unique
        fields: [code]
      - name: "uk_calc_rule_code_current"
        type: unique
        fields: [code]
        where: "is_current_version = true"
    businessRules:
      - "Only one current version per code"
      - "Country-specific rules override global rules"
      - "formula_json structure must match rule_type"
      - "Legal reference required for tax and SI rules"
    indexes:
      - name: "idx_calc_rule_code"
        columns: [code]
      - name: "idx_calc_rule_category"
        columns: [rule_category]
      - name: "idx_calc_rule_type"
        columns: [rule_type]
      - name: "idx_calc_rule_country"
        columns: [country_code]
      - name: "idx_calc_rule_current"
        columns: [code, is_current_version]
        where: "is_current_version = true"
        unique: true
      - name: "idx_calc_rule_effective"
        columns: [effective_start_date, effective_end_date]
    audit:
      scd_type: 2
      version_field: version_number
      previous_version_field: previous_version_id
      current_flag_field: is_current_version
    examples:
      - code: "VN_PIT_2025"
        name: "Vietnam Personal Income Tax 2025"
        rule_category: TAX
        rule_type: PROGRESSIVE
        country_code: VN
        legal_reference: "Law on Personal Income Tax 2007, amended 2012"
      - code: "VN_SI_2025"
        name: "Vietnam Social Insurance 2025"
        rule_category: SOCIAL_INSURANCE
        rule_type: RATE_TABLE
        country_code: VN
        legal_reference: "Social Insurance Law 2014, amended 2024"
      - code: "VN_OT_MULT_2019"
        name: "Vietnam Overtime Multipliers"
        rule_category: OVERTIME
        rule_type: LOOKUP_TABLE
        country_code: VN
        legal_reference: "Labor Code 2019, Article 107"

  ComponentCalculationRule:
    description: |
      Links pay components to specific calculation rules.
      Allows component-specific rule application with execution order.
    attributes:
      id:
        type: UUID
        required: true
      component_id:
        type: UUID
        required: true
        description: "FK to PayComponentDefinition"
      rule_id:
        type: UUID
        required: true
        description: "FK to CalculationRuleDefinition"
      rule_scope:
        type: enum
        required: true
        values: [COMPONENT_CALC, TAX, PRORATION, VALIDATION, SI_CALCULATION, ROUNDING]
        description: "How rule applies to this component"
      execution_order:
        type: integer
        default: 0
        description: "When multiple rules apply to same component"
      override_params:
        type: jsonb
        description: "Component-specific parameter overrides"
      effective_start_date:
        type: date
        required: true
      effective_end_date:
        type: date
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      component:
        target: PayComponentDefinition
        cardinality: "N:1"
      rule:
        target: CalculationRuleDefinition
        cardinality: "N:1"
    constraints:
      - name: "uk_component_calc_rule"
        type: unique
        fields: [component_id, rule_id, effective_start_date]
    businessRules:
      - "execution_order determines calculation sequence"
      - "override_params can customize rule behavior per component"
    indexes:
      - name: "idx_comp_calc_rule_component"
        columns: [component_id, rule_scope]
      - name: "idx_comp_calc_rule_rule"
        columns: [rule_id]
      - name: "idx_comp_calc_rule_order"
        columns: [component_id, rule_scope, execution_order]
      - name: "idx_comp_calc_rule_effective"
        columns: [effective_start_date, effective_end_date]

  BasisCalculationRule:
    description: |
      Links salary basis to calculation rules.
      Defines which rules apply to entire basis (e.g., gross-to-net flow).
    attributes:
      id:
        type: UUID
        required: true
      salary_basis_id:
        type: UUID
        required: true
        description: "FK to SalaryBasis"
      rule_id:
        type: UUID
        required: true
        description: "FK to CalculationRuleDefinition"
      rule_scope:
        type: enum
        required: true
        values: [PRORATION, TAX, ROUNDING, ANNUALIZATION, SI_CALCULATION, GROSS_TO_NET]
        description: "How rule applies to this basis"
      execution_order:
        type: integer
        default: 0
        description: |
          Calculation sequence:
          1 = Proration rules (calculate prorated amounts)
          2 = Component calculations (formulas, OT)
          3 = Gross salary sum
          4 = Social insurance deductions
          5 = Tax calculations (PIT)
          6 = Net salary calculation
      override_params:
        type: jsonb
        description: "Basis-specific parameter overrides"
      effective_start_date:
        type: date
        required: true
      effective_end_date:
        type: date
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      salaryBasis:
        target: SalaryBasis
        cardinality: "N:1"
      rule:
        target: CalculationRuleDefinition
        cardinality: "N:1"
    constraints:
      - name: "uk_basis_calc_rule"
        type: unique
        fields: [salary_basis_id, rule_id, effective_start_date]
    businessRules:
      - "execution_order critical for multi-step calculations (grossSItaxnet)"
      - "override_params can customize rule behavior per basis"
    indexes:
      - name: "idx_basis_calc_rule_basis"
        columns: [salary_basis_id, rule_scope]
      - name: "idx_basis_calc_rule_rule"
        columns: [rule_id]
      - name: "idx_basis_calc_rule_order"
        columns: [salary_basis_id, rule_scope, execution_order]
      - name: "idx_basis_calc_rule_effective"
        columns: [effective_start_date, effective_end_date]

  TaxCalculationCache:
    description: |
      Pre-calculated tax/SI lookup for performance optimization.
      Caches frequently-used calculations to speed up payroll processing.
    attributes:
      id:
        type: UUID
        required: true
      rule_id:
        type: UUID
        required: true
        description: "FK to CalculationRuleDefinition"
      input_amount:
        type: decimal
        required: true
        precision: [18, 4]
        description: "Taxable income or SI base"
      output_tax:
        type: decimal
        required: true
        precision: [18, 4]
        description: "Calculated tax or SI amount"
      output_details:
        type: jsonb
        description: |
          Breakdown by bracket/tier:
          {
            "brackets": [
              {"bracket": 1, "amount": 5000000, "rate": 0.05, "tax": 250000},
              {"bracket": 2, "amount": 3000000, "rate": 0.10, "tax": 300000}
            ],
            "total_tax": 550000,
            "effective_rate": 0.0688
          }
      params_hash:
        type: string
        required: true
        maxLength: 64
        description: "MD5 hash of input parameters for cache key"
      calculated_at:
        type: timestamp
        default: now()
      expires_at:
        type: timestamp
        required: true
        description: "Cache expiration (e.g., end of month, end of year)"
    relationships:
      rule:
        target: CalculationRuleDefinition
        cardinality: "N:1"
    constraints:
      - name: "uk_tax_calc_cache"
        type: unique
        fields: [rule_id, params_hash]
    businessRules:
      - "params_hash = MD5(rule_id + input_amount + deductions + dependents + ...)"
      - "Cache invalidated when rule version changes"
      - "expires_at for automatic cache cleanup"
    indexes:
      - name: "idx_tax_calc_cache_rule"
        columns: [rule_id, params_hash]
        unique: true
      - name: "idx_tax_calc_cache_input"
        columns: [rule_id, input_amount]
      - name: "idx_tax_calc_cache_expires"
        columns: [expires_at]
      - name: "idx_tax_calc_cache_calculated"
        columns: [calculated_at]

  CountryConfiguration:
    description: |
      Country-level configuration for compensation calculations.
      Defines standard working hours, days, tax/SI systems per country.
    attributes:
      id:
        type: UUID
        required: true
      country_code:
        type: string
        required: true
        maxLength: 2
        description: "ISO 3166-1 alpha-2 (VN, US, SG, etc.)"
      country_name:
        type: string
        required: true
        maxLength: 100
      currency_code:
        type: string
        required: true
        maxLength: 3
        description: "ISO 4217 (VND, USD, SGD)"
      tax_system:
        type: enum
        required: true
        values: [PROGRESSIVE, FLAT, DUAL, TERRITORIAL, NONE]
        description: "Tax system type"
      si_system:
        type: enum
        required: true
        values: [MANDATORY, OPTIONAL, HYBRID, NONE]
        description: "Social insurance system"
      standard_working_hours_per_day:
        type: integer
        default: 8
        description: "Standard working hours per day"
      standard_working_days_per_week:
        type: integer
        default: 5
        description: "Standard working days per week"
      standard_working_days_per_month:
        type: integer
        default: 22
        description: "Standard working days per month (for proration)"
      config_json:
        type: jsonb
        description: |
          Country-specific configurations:
          {
            "fiscal_year_start": "01-01",
            "pay_frequency_allowed": ["MONTHLY", "BIWEEKLY"],
            "minimum_wage": 4680000,
            "overtime_cap_hours_per_month": 200,
            "annual_leave_days": 12,
            "probation_max_days": 60
          }
      is_active:
        type: boolean
        default: true
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      calculationRules:
        target: CalculationRuleDefinition
        cardinality: "1:N"
        description: "Country-specific calculation rules"
      holidays:
        target: HolidayCalendar
        cardinality: "1:N"
        description: "Holiday calendar"
    constraints:
      - name: "uk_country_config_code"
        type: unique
        fields: [country_code]
    businessRules:
      - "Country code must be valid ISO 3166-1 alpha-2"
      - "Currency code must be valid ISO 4217"
      - "Standard working hours/days used for proration calculations"
    indexes:
      - name: "idx_country_config_code"
        columns: [country_code]
        unique: true
      - name: "idx_country_config_active"
        columns: [is_active]
    examples:
      - country_code: VN
        country_name: "Vietnam"
        currency_code: VND
        tax_system: PROGRESSIVE
        si_system: MANDATORY
        standard_working_hours_per_day: 8
        standard_working_days_per_month: 26
      - country_code: SG
        country_name: "Singapore"
        currency_code: SGD
        tax_system: PROGRESSIVE
        si_system: MANDATORY
        standard_working_hours_per_day: 8
        standard_working_days_per_month: 22

  HolidayCalendar:
    description: |
      Holiday calendar per country/jurisdiction.
      Used for OT multiplier determination and proration calculations.
    attributes:
      id:
        type: UUID
        required: true
      country_code:
        type: string
        required: true
        maxLength: 2
        description: "FK to CountryConfiguration.country_code"
      jurisdiction:
        type: string
        maxLength: 50
        description: "State/Province if applicable (NULL for national)"
      year:
        type: integer
        required: true
        description: "Calendar year (2025, 2026, etc.)"
      holiday_date:
        type: date
        required: true
        description: "Holiday date"
      holiday_name:
        type: string
        required: true
        maxLength: 200
        description: "Holiday name (e.g., Tt Nguyn n, Independence Day)"
      holiday_type:
        type: enum
        required: true
        values: [NATIONAL, REGIONAL, BANK, OPTIONAL, RELIGIOUS]
        description: "Holiday type"
      is_paid:
        type: boolean
        default: true
        description: "Is this a paid holiday?"
      ot_multiplier:
        type: decimal
        precision: [4, 2]
        description: "OT multiplier if work on this day (e.g., 3.0 for Vietnam holidays)"
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
    relationships:
      countryConfig:
        target: CountryConfiguration
        cardinality: "N:1"
    constraints:
      - name: "uk_holiday_calendar"
        type: unique
        fields: [country_code, year, holiday_date]
    businessRules:
      - "Used for OT multiplier determination"
      - "Used for proration calculations (exclude holidays from working days)"
      - "Regional holidays override national for specific jurisdictions"
    indexes:
      - name: "idx_holiday_calendar_country"
        columns: [country_code, year, holiday_date]
        unique: true
      - name: "idx_holiday_calendar_jurisdiction"
        columns: [country_code, jurisdiction, year]
      - name: "idx_holiday_calendar_date"
        columns: [holiday_date]
      - name: "idx_holiday_calendar_year"
        columns: [year]
    examples:
      - country_code: VN
        year: 2025
        holiday_date: "2025-01-01"
        holiday_name: "Tt Dng Lch"
        holiday_type: NATIONAL
        is_paid: true
        ot_multiplier: 3.0
      - country_code: VN
        year: 2025
        holiday_date: "2025-01-28"
        holiday_name: "Tt Nguyn n (Mng 1)"
        holiday_type: NATIONAL
        is_paid: true
        ot_multiplier: 3.0

  # ===========================================================================
  # VARIABLE PAY SCHEMA
  # ===========================================================================

  BonusPlan:
    description: |
      Defines bonus plan structure and rules.
      Supports STI (short-term incentive), LTI (long-term incentive), and commission.
    attributes:
      id:
        type: UUID
        required: true
      code:
        type: string
        required: true
        maxLength: 50
        description: "Unique plan code (e.g., STI_2025, LTI_2025_2027)"
      name:
        type: string
        required: true
        maxLength: 200
      description:
        type: text
      bonus_type:
        type: enum
        required: true
        values: [STI, LTI, COMMISSION, SPOT_BONUS, RETENTION, SIGN_ON]
        description: "Bonus category"
      equity_flag:
        type: boolean
        default: false
        description: "Whether bonus includes equity component"
      formula_json:
        type: jsonb
        description: |
          Bonus calculation formula:
          {
            "base": "ANNUAL_SALARY",
            "target_pct": 0.15,
            "performance_multiplier": {
              "EXCEEDS": 1.5,
              "MEETS": 1.0,
              "BELOW": 0.5,
              "UNSATISFACTORY": 0.0
            },
            "company_multiplier_range": [0.8, 1.2]
          }
      eligibility_rule:
        type: jsonb
        description: |
          Eligibility criteria:
          {
            "min_tenure_months": 6,
            "employment_types": ["FULL_TIME"],
            "grades": ["G5", "G6", "M1", "M2"],
            "performance_rating_min": "MEETS"
          }
      metadata:
        type: jsonb
      effective_start_date:
        type: date
        required: true
      effective_end_date:
        type: date
      is_active:
        type: boolean
        default: true
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      cycles:
        target: BonusCycle
        cardinality: "1:N"
    constraints:
      - name: "uk_bonus_plan_code"
        type: unique
        fields: [code]
    businessRules:
      - "STI typically annual, LTI multi-year"
      - "Commission plans have different calculation logic"
      - "Eligibility rules evaluated at cycle start"
    indexes:
      - name: "idx_bonus_plan_code"
        columns: [code]
      - name: "idx_bonus_plan_type"
        columns: [bonus_type]
      - name: "idx_bonus_plan_active"
        columns: [is_active]
        where: "is_active = true"

  BonusCycle:
    description: |
      Specific instance of bonus plan for a time period.
      Manages budget, workflow, and payout timing.
    attributes:
      id:
        type: UUID
        required: true
      plan_id:
        type: UUID
        required: true
      code:
        type: string
        required: true
        maxLength: 50
        description: "Cycle identifier (e.g., STI_2025_Q1, LTI_2025)"
      name:
        type: string
        required: true
        maxLength: 200
      description:
        type: text
      period_start:
        type: date
        required: true
        description: "Performance period start"
      period_end:
        type: date
        required: true
        description: "Performance period end"
      payout_date:
        type: date
        description: "Planned payout date"
      budget_amount:
        type: decimal
        precision: [18, 4]
        description: "Total budget for this cycle"
      currency:
        type: string
        required: true
        maxLength: 3
      workflow_state:
        type: jsonb
        description: "Current workflow state and history"
      status:
        type: enum
        default: DRAFT
        values: [DRAFT, OPEN, IN_REVIEW, APPROVED, PAID, CLOSED, CANCELLED]
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      plan:
        target: BonusPlan
        cardinality: "N:1"
      pools:
        target: BonusPool
        cardinality: "1:N"
    constraints:
      - name: "uk_bonus_cycle_code"
        type: unique
        fields: [code]
    businessRules:
      - "period_end must be after period_start"
      - "payout_date typically after period_end"
      - "Cannot modify PAID or CLOSED cycle"
    indexes:
      - name: "idx_bonus_cycle_plan"
        columns: [plan_id]
      - name: "idx_bonus_cycle_code"
        columns: [code]
      - name: "idx_bonus_cycle_status"
        columns: [status]
      - name: "idx_bonus_cycle_period"
        columns: [period_start, period_end]

  BonusPool:
    description: |
      Budget pool for bonus allocation by legal entity or business unit.
      Enables distributed bonus management across organization.
    attributes:
      id:
        type: UUID
        required: true
      cycle_id:
        type: UUID
        required: true
      legal_entity_id:
        type: UUID
        required: true
        description: "FK to Core.LegalEntity"
      name:
        type: string
        required: true
        maxLength: 200
        description: "Pool name (e.g., 'Vietnam STI Pool 2025')"
      budget_amount:
        type: decimal
        required: true
        precision: [18, 4]
      utilized_amount:
        type: decimal
        default: 0
        precision: [18, 4]
        description: "Sum of approved allocations"
      currency:
        type: string
        required: true
        maxLength: 3
      metadata:
        type: jsonb
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
    relationships:
      cycle:
        target: BonusCycle
        cardinality: "N:1"
      legalEntity:
        target: Core.LegalEntity
        cardinality: "N:1"
      allocations:
        target: BonusAllocation
        cardinality: "1:N"
    businessRules:
      - "utilized_amount = SUM(approved_amount) from allocations"
      - "utilized_amount should not exceed budget_amount (warning)"
    indexes:
      - name: "idx_bonus_pool_cycle"
        columns: [cycle_id]
      - name: "idx_bonus_pool_entity"
        columns: [legal_entity_id]

  BonusAllocation:
    description: |
      Individual bonus allocation to employee.
      Tracks proposed, approved amounts and approval workflow.
    attributes:
      id:
        type: UUID
        required: true
      pool_id:
        type: UUID
        required: true
      employee_id:
        type: UUID
        required: true
        description: "FK to Core.Employee"
      proposed_amount:
        type: decimal
        required: true
        precision: [18, 4]
        description: "Proposed bonus amount"
      approved_amount:
        type: decimal
        precision: [18, 4]
        description: "Final approved amount (may differ from proposed)"
      currency:
        type: string
        required: true
        maxLength: 3
      performance_rating:
        type: string
        maxLength: 50
        description: "Performance rating for this period"
      performance_multiplier:
        type: decimal
        precision: [5, 4]
        description: "Performance multiplier applied (e.g., 1.5 for EXCEEDS)"
      company_multiplier:
        type: decimal
        precision: [5, 4]
        description: "Company performance multiplier (e.g., 1.1)"
      calculation_details:
        type: jsonb
        description: |
          Calculation breakdown:
          {
            "base_salary": 50000000,
            "target_pct": 0.15,
            "target_bonus": 7500000,
            "performance_multiplier": 1.2,
            "company_multiplier": 1.1,
            "calculated_bonus": 9900000,
            "proposed_bonus": 9900000,
            "approved_bonus": 10000000
          }
      status:
        type: enum
        default: DRAFT
        values: [DRAFT, PENDING, APPROVED, REJECTED, PAID]
      approver_emp_id:
        type: UUID
        description: "FK to Core.Employee (approver)"
      decision_date:
        type: timestamp
      decision_note:
        type: text
      metadata:
        type: jsonb
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
    relationships:
      pool:
        target: BonusPool
        cardinality: "N:1"
      employee:
        target: Core.Employee
        cardinality: "N:1"
      approver:
        target: Core.Employee
        cardinality: "N:1"
    businessRules:
      - "approved_amount may differ from proposed_amount (manager discretion)"
      - "Cannot modify APPROVED or PAID allocation"
    indexes:
      - name: "idx_bonus_alloc_pool"
        columns: [pool_id]
      - name: "idx_bonus_alloc_employee"
        columns: [employee_id]
      - name: "idx_bonus_alloc_status"
        columns: [status]
      - name: "idx_bonus_alloc_approver"
        columns: [approver_emp_id]


  EquityGrant:
    description: |
      Equity grant lifecycle management (RSU, Options, SAR).
      Tracks total, vested, exercised, and forfeited units.
    attributes:
      id:
        type: UUID
        required: true
      employee_id:
        type: UUID
        required: true
        description: "FK to Core.Employee"
      plan_id:
        type: UUID
        required: true
        description: "FK to BonusPlan (for equity plans)"
      grant_number:
        type: string
        required: true
        maxLength: 50
        description: "Unique grant identifier (e.g., RSU-2025-001234)"
      grant_date:
        type: date
        required: true
        description: "Date grant was awarded"
      unit_type:
        type: enum
        required: true
        values: [RSU, OPTION, SAR, PHANTOM_STOCK]
        description: "Type of equity grant"
      total_units:
        type: integer
        required: true
        description: "Total units granted"
      vested_units:
        type: integer
        default: 0
        description: "Units vested to date"
      exercised_units:
        type: integer
        default: 0
        description: "Units exercised (for options/SAR)"
      forfeited_units:
        type: integer
        default: 0
        description: "Units forfeited (termination, etc.)"
      unvested_units:
        type: integer
        description: "Computed: total_units - vested_units - forfeited_units"
      strike_price:
        type: decimal
        precision: [18, 6]
        description: "Exercise price for options (NULL for RSU)"
      fair_market_value:
        type: decimal
        precision: [18, 6]
        description: "FMV at grant date"
      expiry_date:
        type: date
        description: "Expiration date (for options)"
      vesting_schedule_json:
        type: jsonb
        required: true
        description: |
          Vesting schedule:
          {
            "type": "TIME_BASED",
            "cliff_months": 12,
            "vesting_period_months": 48,
            "vesting_frequency": "QUARTERLY",
            "schedule": [
              {"vest_date": "2026-01-01", "units": 250, "cumulative": 250},
              {"vest_date": "2026-04-01", "units": 250, "cumulative": 500},
              {"vest_date": "2026-07-01", "units": 250, "cumulative": 750},
              {"vest_date": "2026-10-01", "units": 250, "cumulative": 1000}
            ]
          }
      status:
        type: enum
        default: ACTIVE
        values: [ACTIVE, FULLY_VESTED, FORFEITED, EXPIRED, EXERCISED]
      termination_date:
        type: date
        description: "Employee termination date (affects vesting)"
      metadata:
        type: jsonb
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      employee:
        target: Core.Employee
        cardinality: "N:1"
      plan:
        target: BonusPlan
        cardinality: "N:1"
      vestingEvents:
        target: EquityVestingEvent
        cardinality: "1:N"
      transactions:
        target: EquityTransaction
        cardinality: "1:N"
    businessRules:
      - "unvested_units = total_units - vested_units - forfeited_units"
      - "vested_units + exercised_units + forfeited_units <= total_units"
      - "RSU has NULL strike_price, Options have strike_price"
      - "Vesting accelerates on termination for certain cases"
    indexes:
      - name: "idx_equity_grant_employee"
        columns: [employee_id]
      - name: "idx_equity_grant_number"
        columns: [grant_number]
        unique: true
      - name: "idx_equity_grant_date"
        columns: [grant_date]
      - name: "idx_equity_grant_status"
        columns: [status]
      - name: "idx_equity_grant_expiry"
        columns: [expiry_date]

  EquityVestingEvent:
    description: |
      Records each vesting event (scheduled, accelerated, or forfeit).
      Created automatically based on vesting schedule or manually for accelerations.
    attributes:
      id:
        type: UUID
        required: true
      grant_id:
        type: UUID
        required: true
        description: "FK to EquityGrant"
      vest_date:
        type: date
        required: true
        description: "Date units vested"
      vested_units:
        type: integer
        required: true
        description: "Number of units vested in this event"
      event_type:
        type: enum
        required: true
        values: [SCHEDULED, ACCELERATED, FORFEIT, CLIFF]
        description: "Type of vesting event"
      acceleration_reason:
        type: string
        maxLength: 100
        description: "Reason for acceleration (TERMINATION, ACQUISITION, IPO, etc.)"
      payroll_batch_id:
        type: UUID
        description: "FK to Payroll.Batch (if taxable event processed)"
      metadata:
        type: jsonb
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
    relationships:
      grant:
        target: EquityGrant
        cardinality: "N:1"
    businessRules:
      - "SCHEDULED events created from vesting_schedule_json"
      - "ACCELERATED events require acceleration_reason"
      - "FORFEIT events have negative vested_units"
      - "Vesting creates taxable event (RSU) or exercise opportunity (Options)"
    indexes:
      - name: "idx_equity_vest_grant"
        columns: [grant_id]
      - name: "idx_equity_vest_date"
        columns: [vest_date]
      - name: "idx_equity_vest_type"
        columns: [event_type]
      - name: "idx_equity_vest_payroll"
        columns: [payroll_batch_id]

  EquityTransaction:
    description: |
      Records equity transactions (exercise, cancel, forfeit, vest).
      Tracks cash value for tax purposes.
    attributes:
      id:
        type: UUID
        required: true
      grant_id:
        type: UUID
        required: true
        description: "FK to EquityGrant"
      txn_date:
        type: date
        required: true
        description: "Transaction date"
      txn_type:
        type: enum
        required: true
        values: [EXERCISE, CANCEL, FORFEIT, VEST, SELL]
        description: "Transaction type"
      units:
        type: integer
        required: true
        description: "Number of units in transaction"
      price_per_unit:
        type: decimal
        precision: [18, 6]
        description: "Price per unit at transaction (FMV for vest, strike for exercise)"
      cash_value:
        type: decimal
        precision: [18, 4]
        description: "Total cash value (units * price_per_unit)"
      gain_loss:
        type: decimal
        precision: [18, 4]
        description: "Gain/loss for tax purposes (FMV - strike for options)"
      payroll_batch_id:
        type: UUID
        description: "FK to Payroll.Batch (if tax withholding processed)"
      metadata:
        type: jsonb
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
    relationships:
      grant:
        target: EquityGrant
        cardinality: "N:1"
    businessRules:
      - "EXERCISE: cash_value = units * strike_price, gain = units * (FMV - strike)"
      - "VEST (RSU): cash_value = units * FMV, taxable as income"
      - "FORFEIT: negative units, no cash value"
      - "SELL: cash_value = units * sale_price"
    indexes:
      - name: "idx_equity_txn_grant"
        columns: [grant_id]
      - name: "idx_equity_txn_date"
        columns: [txn_date]
      - name: "idx_equity_txn_type"
        columns: [txn_type]
      - name: "idx_equity_txn_payroll"
        columns: [payroll_batch_id]

  CommissionPlan:
    description: |
      Commission plan structure for sales compensation.
      Defines quota, tiers, and calculation rules.
    attributes:
      id:
        type: UUID
        required: true
      code:
        type: string
        required: true
        maxLength: 50
        description: "Unique plan code (e.g., SALES_COMM_2025)"
      name:
        type: string
        required: true
        maxLength: 200
      description:
        type: text
      plan_type:
        type: enum
        required: true
        values: [REVENUE_BASED, PROFIT_BASED, UNIT_BASED, HYBRID]
        description: "Commission calculation basis"
      quota_type:
        type: enum
        required: true
        values: [INDIVIDUAL, TEAM, TERRITORY, PRODUCT]
        description: "How quota is assigned"
      payment_frequency:
        type: enum
        required: true
        values: [MONTHLY, QUARTERLY, ANNUAL]
        description: "Commission payout frequency"
      calculation_method:
        type: enum
        required: true
        values: [FLAT_RATE, TIERED, ACCELERATOR, DECELERATOR]
        description: "Commission calculation method"
      formula_json:
        type: jsonb
        description: |
          Commission calculation formula:
          {
            "base_rate": 0.05,
            "quota_threshold": 1000000,
            "accelerator": {
              "above_100_pct": 0.08,
              "above_120_pct": 0.10
            },
            "cap": 500000
          }
      eligibility_rule:
        type: jsonb
        description: "Eligibility criteria (roles, tenure, etc.)"
      metadata:
        type: jsonb
      effective_start_date:
        type: date
        required: true
      effective_end_date:
        type: date
      is_active:
        type: boolean
        default: true
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      tiers:
        target: CommissionTier
        cardinality: "1:N"
        description: "Commission tiers"
      transactions:
        target: CommissionTransaction
        cardinality: "1:N"
        description: "Commission transactions"
    constraints:
      - name: "uk_commission_plan_code"
        type: unique
        fields: [code]
    businessRules:
      - "TIERED plans have multiple tiers with different rates"
      - "ACCELERATOR increases rate above quota"
      - "DECELERATOR decreases rate below quota"
      - "Cap limits maximum commission payout"
    indexes:
      - name: "idx_commission_plan_code"
        columns: [code]
      - name: "idx_commission_plan_type"
        columns: [plan_type]
      - name: "idx_commission_plan_active"
        columns: [is_active]
        where: "is_active = true"

  CommissionTier:
    description: |
      Commission rate tiers for tiered commission plans.
      Defines rate per achievement level.
    attributes:
      id:
        type: UUID
        required: true
      plan_id:
        type: UUID
        required: true
        description: "FK to CommissionPlan"
      tier_number:
        type: integer
        required: true
        description: "Tier sequence (1, 2, 3...)"
      tier_name:
        type: string
        maxLength: 100
        description: "Tier name (e.g., 'Base', 'Accelerator', 'Super Accelerator')"
      min_achievement_pct:
        type: decimal
        required: true
        precision: [5, 2]
        description: "Minimum quota achievement % for this tier (e.g., 0, 80, 100, 120)"
      max_achievement_pct:
        type: decimal
        precision: [5, 2]
        description: "Maximum quota achievement % for this tier (NULL = unlimited)"
      commission_rate:
        type: decimal
        required: true
        precision: [5, 4]
        description: "Commission rate for this tier (e.g., 0.05 = 5%)"
      flat_amount:
        type: decimal
        precision: [18, 4]
        description: "Flat commission amount (alternative to rate)"
      effective_start_date:
        type: date
        required: true
      effective_end_date:
        type: date
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
    relationships:
      plan:
        target: CommissionPlan
        cardinality: "N:1"
    constraints:
      - name: "uk_commission_tier"
        type: unique
        fields: [plan_id, tier_number, effective_start_date]
    businessRules:
      - "Tiers must not overlap in achievement % ranges"
      - "Tier 1 typically starts at 0% achievement"
      - "Higher tiers have higher rates (accelerator model)"
    indexes:
      - name: "idx_commission_tier_plan"
        columns: [plan_id, tier_number]
      - name: "idx_commission_tier_achievement"
        columns: [plan_id, min_achievement_pct]
    examples:
      - tier_number: 1
        tier_name: "Base"
        min_achievement_pct: 0
        max_achievement_pct: 100
        commission_rate: 0.05
      - tier_number: 2
        tier_name: "Accelerator"
        min_achievement_pct: 100
        max_achievement_pct: 120
        commission_rate: 0.08
      - tier_number: 3
        tier_name: "Super Accelerator"
        min_achievement_pct: 120
        max_achievement_pct: null
        commission_rate: 0.10

  CommissionTransaction:
    description: |
      Individual commission transaction record.
      Links to sales/revenue data and calculates commission earned.
    attributes:
      id:
        type: UUID
        required: true
      plan_id:
        type: UUID
        required: true
        description: "FK to CommissionPlan"
      employee_id:
        type: UUID
        required: true
        description: "FK to Core.Employee"
      transaction_date:
        type: date
        required: true
        description: "Date of sale/transaction"
      period_start:
        type: date
        required: true
        description: "Commission period start"
      period_end:
        type: date
        required: true
        description: "Commission period end"
      revenue_amount:
        type: decimal
        required: true
        precision: [18, 4]
        description: "Revenue/sales amount"
      quota_amount:
        type: decimal
        precision: [18, 4]
        description: "Quota for this period"
      achievement_pct:
        type: decimal
        precision: [5, 2]
        description: "Computed: (revenue_amount / quota_amount) * 100"
      tier_id:
        type: UUID
        description: "FK to CommissionTier (tier applied)"
      commission_rate:
        type: decimal
        precision: [5, 4]
        description: "Rate applied (from tier or plan)"
      commission_amount:
        type: decimal
        required: true
        precision: [18, 4]
        description: "Commission earned"
      currency:
        type: string
        required: true
        maxLength: 3
      calculation_details:
        type: jsonb
        description: |
          Calculation breakdown:
          {
            "revenue": 15000000,
            "quota": 10000000,
            "achievement_pct": 150,
            "tier": "Super Accelerator",
            "rate": 0.10,
            "commission": 1500000
          }
      status:
        type: enum
        default: PENDING
        values: [PENDING, APPROVED, PAID, DISPUTED, CANCELLED]
      approved_by:
        type: UUID
        description: "FK to Core.Employee (approver)"
      approved_date:
        type: timestamp
      payroll_batch_id:
        type: UUID
        description: "FK to Payroll.Batch (when paid)"
      metadata:
        type: jsonb
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
    relationships:
      plan:
        target: CommissionPlan
        cardinality: "N:1"
      employee:
        target: Core.Employee
        cardinality: "N:1"
      tier:
        target: CommissionTier
        cardinality: "N:1"
      approver:
        target: Core.Employee
        cardinality: "N:1"
    businessRules:
      - "achievement_pct = (revenue_amount / quota_amount) * 100"
      - "commission_amount = revenue_amount * commission_rate"
      - "Tier determined by achievement_pct"
      - "Cannot modify APPROVED or PAID transactions"
    indexes:
      - name: "idx_commission_txn_plan"
        columns: [plan_id]
      - name: "idx_commission_txn_employee"
        columns: [employee_id]
      - name: "idx_commission_txn_date"
        columns: [transaction_date]
      - name: "idx_commission_txn_period"
        columns: [period_start, period_end]
      - name: "idx_commission_txn_status"
        columns: [status]
      - name: "idx_commission_txn_payroll"
        columns: [payroll_batch_id]

# Continue in next message for Benefits, Recognition, and remaining modules...

  # ===========================================================================
  # BENEFITS SCHEMA
  # ===========================================================================

  BenefitPlan:
    description: |
      Benefit plan definition (health, retirement, wellness, perks).
      Supports multiple coverage options and eligibility rules.
    attributes:
      id:
        type: UUID
        required: true
      code:
        type: string
        required: true
        maxLength: 50
        description: "Unique plan code (e.g., MEDICAL_VN_2025, DENTAL_US_PPO)"
      name:
        type: string
        required: true
        maxLength: 255
      description:
        type: text
      plan_category:
        type: enum
        required: true
        values: [MEDICAL, DENTAL, VISION, LIFE, DISABILITY, RETIREMENT, PERK, WELLNESS, EDUCATION, TRANSPORTATION]
        description: "Benefit category"
      provider_name:
        type: string
        maxLength: 255
        description: "Insurance provider/carrier name"
      sponsor_legal_entity_id:
        type: UUID
        description: "FK to Core.LegalEntity (sponsoring entity)"
      eligibility_rule_json:
        type: jsonb
        description: |
          Eligibility criteria:
          {
            "employment_types": ["FULL_TIME"],
            "min_tenure_months": 3,
            "grades": ["G3", "G4", "G5"],
            "locations": ["VN", "SG"]
          }
      coverage_options_json:
        type: jsonb
        description: |
          Available coverage options:
          {
            "options": [
              {"code": "EMPLOYEE_ONLY", "name": "Employee Only"},
              {"code": "EMPLOYEE_SPOUSE", "name": "Employee + Spouse"},
              {"code": "EMPLOYEE_FAMILY", "name": "Employee + Family"}
            ]
          }
      currency:
        type: string
        maxLength: 3
        description: "Currency for premiums/costs"
      premium_type:
        type: enum
        values: [EMPLOYEE, EMPLOYER, SHARED]
        description: "Who pays premium"
      metadata:
        type: jsonb
      effective_start_date:
        type: date
        required: true
      effective_end_date:
        type: date
      is_active:
        type: boolean
        default: true
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      sponsorEntity:
        target: Core.LegalEntity
        cardinality: "N:1"
      options:
        target: BenefitOption
        cardinality: "1:N"
        description: "Coverage options"
      eligibilityProfiles:
        target: PlanEligibility
        cardinality: "1:N"
        description: "Eligibility profiles"
      enrollments:
        target: Enrollment
        cardinality: "1:N"
        description: "Employee enrollments"
    constraints:
      - name: "uk_benefit_plan_code"
        type: unique
        fields: [code]
    businessRules:
      - "Plan code must be unique"
      - "Eligibility evaluated at enrollment time"
      - "Coverage options define employee choices"
    indexes:
      - name: "idx_benefit_plan_code"
        columns: [code]
      - name: "idx_benefit_plan_category"
        columns: [plan_category]
      - name: "idx_benefit_plan_active"
        columns: [is_active]
        where: "is_active = true"

  BenefitOption:
    description: |
      Specific coverage option within a benefit plan.
      Defines coverage tier and associated costs.
    attributes:
      id:
        type: UUID
        required: true
      plan_id:
        type: UUID
        required: true
        description: "FK to BenefitPlan"
      code:
        type: string
        required: true
        maxLength: 50
        description: "Option code (e.g., EMP_ONLY, EMP_SPOUSE, EMP_FAMILY)"
      name:
        type: string
        required: true
        maxLength: 200
      coverage_tier:
        type: enum
        required: true
        values: [EMPLOYEE_ONLY, EMPLOYEE_SPOUSE, EMPLOYEE_CHILDREN, EMPLOYEE_FAMILY, EMPLOYEE_DOMESTIC_PARTNER]
        description: "Coverage tier"
      cost_employee:
        type: decimal
        precision: [18, 4]
        description: "Employee cost per period"
      cost_employer:
        type: decimal
        precision: [18, 4]
        description: "Employer cost per period"
      currency:
        type: string
        required: true
        maxLength: 3
      formula_json:
        type: jsonb
        description: |
          Cost calculation formula:
          {
            "base_cost": 500000,
            "per_dependent": 200000,
            "employee_contribution_pct": 0.30,
            "employer_contribution_pct": 0.70
          }
      metadata:
        type: jsonb
      effective_start_date:
        type: date
        required: true
      effective_end_date:
        type: date
      is_active:
        type: boolean
        default: true
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
    relationships:
      plan:
        target: BenefitPlan
        cardinality: "N:1"
      enrollments:
        target: Enrollment
        cardinality: "1:N"
    constraints:
      - name: "uk_benefit_option_code"
        type: unique
        fields: [code]
    businessRules:
      - "cost_employee + cost_employer = total premium"
      - "EMPLOYEE_FAMILY tier covers spouse + children"
    indexes:
      - name: "idx_benefit_option_plan"
        columns: [plan_id]
      - name: "idx_benefit_option_code"
        columns: [code]
      - name: "idx_benefit_option_active"
        columns: [is_active]
        where: "is_active = true"

  EligibilityProfile:
    description: |
      Reusable eligibility rule profile.
      Can be shared across multiple benefit plans.
    attributes:
      id:
        type: UUID
        required: true
      code:
        type: string
        required: true
        maxLength: 50
        description: "Profile code (e.g., FULL_TIME_3M, MANAGER_LEVEL)"
      name:
        type: string
        required: true
        maxLength: 200
      rule_json:
        type: jsonb
        required: true
        description: |
          Eligibility rules:
          {
            "employment_types": ["FULL_TIME"],
            "min_tenure_months": 3,
            "grades": ["G3", "G4", "G5"],
            "job_levels": [3, 4, 5],
            "locations": ["VN", "SG"],
            "custom_rules": [
              {"field": "performance_rating", "operator": ">=", "value": "MEETS"}
            ]
          }
      metadata:
        type: jsonb
      effective_start_date:
        type: date
        required: true
      effective_end_date:
        type: date
      is_active:
        type: boolean
        default: true
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
    relationships:
      planEligibilities:
        target: PlanEligibility
        cardinality: "1:N"
    constraints:
      - name: "uk_eligibility_profile_code"
        type: unique
        fields: [code]
    indexes:
      - name: "idx_eligibility_profile_code"
        columns: [code]
      - name: "idx_eligibility_profile_active"
        columns: [is_active]
        where: "is_active = true"

  PlanEligibility:
    description: |
      Links benefit plans to eligibility profiles.
      Many-to-many relationship.
    attributes:
      plan_id:
        type: UUID
        required: true
        description: "FK to BenefitPlan"
      eligibility_id:
        type: UUID
        required: true
        description: "FK to EligibilityProfile"
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
    relationships:
      plan:
        target: BenefitPlan
        cardinality: "N:1"
      eligibility:
        target: EligibilityProfile
        cardinality: "N:1"
    constraints:
      - name: "uk_plan_eligibility"
        type: unique
        fields: [plan_id, eligibility_id]
    indexes:
      - name: "idx_plan_eligibility_plan"
        columns: [plan_id]
      - name: "idx_plan_eligibility_eligibility"
        columns: [eligibility_id]

  EnrollmentPeriod:
    description: |
      Open enrollment period for benefit elections.
      Defines when employees can enroll/change benefits.
      NEW - Addresses missing item from design review.
    attributes:
      id:
        type: UUID
        required: true
      code:
        type: string
        required: true
        maxLength: 50
        description: "Period code (e.g., OPEN_ENROLLMENT_2025, NEW_HIRE_2025_Q1)"
      name:
        type: string
        required: true
        maxLength: 200
      period_type:
        type: enum
        required: true
        values: [OPEN_ENROLLMENT, NEW_HIRE, QUALIFYING_EVENT, SPECIAL_ENROLLMENT]
        description: "Type of enrollment period"
      enrollment_start_date:
        type: date
        required: true
        description: "When enrollment opens"
      enrollment_end_date:
        type: date
        required: true
        description: "When enrollment closes"
      coverage_start_date:
        type: date
        required: true
        description: "When coverage begins"
      coverage_end_date:
        type: date
        description: "When coverage ends (NULL for ongoing)"
      eligible_plans_json:
        type: jsonb
        description: |
          Plans available during this period:
          {
            "plan_ids": ["uuid1", "uuid2"],
            "categories": ["MEDICAL", "DENTAL", "VISION"]
          }
      auto_enroll:
        type: boolean
        default: false
        description: "Auto-enroll eligible employees in default options"
      reminder_schedule_json:
        type: jsonb
        description: |
          Reminder schedule:
          {
            "reminders": [
              {"days_before_end": 30, "sent": false},
              {"days_before_end": 14, "sent": false},
              {"days_before_end": 7, "sent": false},
              {"days_before_end": 1, "sent": false}
            ]
          }
      status:
        type: enum
        default: DRAFT
        values: [DRAFT, SCHEDULED, OPEN, CLOSED, CANCELLED]
      metadata:
        type: jsonb
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      enrollments:
        target: Enrollment
        cardinality: "1:N"
        description: "Enrollments during this period"
    constraints:
      - name: "uk_enrollment_period_code"
        type: unique
        fields: [code]
      - name: "chk_enrollment_period_dates"
        type: check
        expression: "enrollment_start_date < enrollment_end_date AND enrollment_end_date <= coverage_start_date"
    businessRules:
      - "enrollment_end_date must be before coverage_start_date"
      - "OPEN_ENROLLMENT typically annual"
      - "NEW_HIRE period for new employees"
      - "QUALIFYING_EVENT triggered by life events"
    indexes:
      - name: "idx_enrollment_period_code"
        columns: [code]
      - name: "idx_enrollment_period_type"
        columns: [period_type]
      - name: "idx_enrollment_period_dates"
        columns: [enrollment_start_date, enrollment_end_date]
      - name: "idx_enrollment_period_status"
        columns: [status]

  LifeEvent:
    description: |
      Qualifying life events that trigger special enrollment.
      Examples: marriage, birth, adoption, divorce, etc.
      NEW - Addresses missing item from design review.
    attributes:
      id:
        type: UUID
        required: true
      employee_id:
        type: UUID
        required: true
        description: "FK to Core.Employee"
      event_type:
        type: enum
        required: true
        values: [MARRIAGE, DIVORCE, BIRTH, ADOPTION, DEATH_OF_DEPENDENT, LOSS_OF_COVERAGE, CHANGE_IN_EMPLOYMENT, RELOCATION, DISABILITY]
        description: "Type of life event"
      event_date:
        type: date
        required: true
        description: "Date event occurred"
      reported_date:
        type: date
        required: true
        description: "Date employee reported event"
      enrollment_deadline:
        type: date
        required: true
        description: "Deadline to make benefit changes (typically event_date + 30 days)"
      supporting_documents_json:
        type: jsonb
        description: |
          Required documentation:
          {
            "documents": [
              {"type": "MARRIAGE_CERTIFICATE", "uploaded": true, "url": "..."},
              {"type": "BIRTH_CERTIFICATE", "uploaded": false}
            ]
          }
      status:
        type: enum
        default: PENDING
        values: [PENDING, VERIFIED, APPROVED, REJECTED, EXPIRED]
      verified_by:
        type: UUID
        description: "FK to Core.Employee (HR verifier)"
      verified_date:
        type: timestamp
      verification_notes:
        type: text
      metadata:
        type: jsonb
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      employee:
        target: Core.Employee
        cardinality: "N:1"
      verifier:
        target: Core.Employee
        cardinality: "N:1"
      enrollments:
        target: Enrollment
        cardinality: "1:N"
        description: "Benefit changes triggered by this event"
    businessRules:
      - "enrollment_deadline typically 30 days from event_date"
      - "Supporting documents required for verification"
      - "VERIFIED status required before enrollment changes"
      - "Expired if not acted upon by deadline"
    indexes:
      - name: "idx_life_event_employee"
        columns: [employee_id]
      - name: "idx_life_event_type"
        columns: [event_type]
      - name: "idx_life_event_date"
        columns: [event_date]
      - name: "idx_life_event_status"
        columns: [status]
      - name: "idx_life_event_deadline"
        columns: [enrollment_deadline]

  EmployeeDependent:
    description: |
      Employee dependents for benefit coverage.
      Tracks relationship, eligibility, and coverage status.
      NEW - Addresses missing item from design review.
    attributes:
      id:
        type: UUID
        required: true
      employee_id:
        type: UUID
        required: true
        description: "FK to Core.Employee"
      full_name:
        type: string
        required: true
        maxLength: 200
        description: "Dependent's full legal name"
      relationship:
        type: enum
        required: true
        values: [SPOUSE, DOMESTIC_PARTNER, CHILD, STEPCHILD, ADOPTED_CHILD, PARENT, SIBLING, OTHER]
        description: "Relationship to employee"
      date_of_birth:
        type: date
        required: true
      gender:
        type: string
        maxLength: 20
      national_id:
        type: string
        maxLength: 50
        description: "National ID/SSN (encrypted)"
      is_student:
        type: boolean
        default: false
        description: "Full-time student status (for age extension)"
      student_verification_date:
        type: date
        description: "Last student status verification"
      is_disabled:
        type: boolean
        default: false
        description: "Disabled dependent (no age limit)"
      disability_verification_date:
        type: date
      is_eligible:
        type: boolean
        default: true
        description: "Currently eligible for coverage"
      eligibility_end_date:
        type: date
        description: "When eligibility ends (e.g., child turns 26)"
      supporting_documents_json:
        type: jsonb
        description: |
          Required documentation:
          {
            "documents": [
              {"type": "BIRTH_CERTIFICATE", "uploaded": true, "url": "..."},
              {"type": "MARRIAGE_CERTIFICATE", "uploaded": true, "url": "..."}
            ]
          }
      status:
        type: enum
        default: ACTIVE
        values: [ACTIVE, INACTIVE, PENDING_VERIFICATION, INELIGIBLE]
      metadata:
        type: jsonb
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      employee:
        target: Core.Employee
        cardinality: "N:1"
      enrollments:
        target: Enrollment
        cardinality: "N:M"
        description: "Benefit enrollments covering this dependent"
    businessRules:
      - "CHILD eligible until age 26 (US) or 21 (Vietnam)"
      - "STUDENT status extends eligibility to age 26"
      - "DISABLED dependents have no age limit"
      - "Supporting documents required for verification"
      - "Eligibility re-verified annually"
    indexes:
      - name: "idx_employee_dependent_employee"
        columns: [employee_id]
      - name: "idx_employee_dependent_relationship"
        columns: [relationship]
      - name: "idx_employee_dependent_status"
        columns: [status]
      - name: "idx_employee_dependent_eligible"
        columns: [is_eligible]
        where: "is_eligible = true"
      - name: "idx_employee_dependent_eligibility_end"
        columns: [eligibility_end_date]

  BenefitBeneficiary:
    description: |
      Beneficiaries for life insurance and retirement benefits.
      Supports primary and contingent beneficiaries.
      NEW - Addresses missing item from design review.
    attributes:
      id:
        type: UUID
        required: true
      employee_id:
        type: UUID
        required: true
        description: "FK to Core.Employee"
      plan_id:
        type: UUID
        required: true
        description: "FK to BenefitPlan (LIFE or RETIREMENT)"
      beneficiary_type:
        type: enum
        required: true
        values: [PRIMARY, CONTINGENT]
        description: "Beneficiary designation"
      sequence:
        type: integer
        required: true
        description: "Order within beneficiary type (1, 2, 3...)"
      full_name:
        type: string
        required: true
        maxLength: 200
      relationship:
        type: enum
        required: true
        values: [SPOUSE, CHILD, PARENT, SIBLING, TRUST, ESTATE, OTHER]
      date_of_birth:
        type: date
      contact_info_json:
        type: jsonb
        description: |
          Contact information:
          {
            "address": "123 Main St, City, State, ZIP",
            "phone": "+1-555-1234",
            "email": "beneficiary@example.com"
          }
      allocation_percentage:
        type: decimal
        required: true
        precision: [5, 2]
        description: "Percentage of benefit (must sum to 100% per type)"
      is_irrevocable:
        type: boolean
        default: false
        description: "Cannot be changed without beneficiary consent"
      effective_date:
        type: date
        required: true
        description: "When designation becomes effective"
      end_date:
        type: date
        description: "When designation ends (NULL = active)"
      status:
        type: enum
        default: ACTIVE
        values: [ACTIVE, INACTIVE, DECEASED]
      metadata:
        type: jsonb
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      employee:
        target: Core.Employee
        cardinality: "N:1"
      plan:
        target: BenefitPlan
        cardinality: "N:1"
    constraints:
      - name: "chk_beneficiary_allocation"
        type: check
        expression: "allocation_percentage > 0 AND allocation_percentage <= 100"
    businessRules:
      - "PRIMARY beneficiaries must sum to 100%"
      - "CONTINGENT beneficiaries receive if all PRIMARY deceased"
      - "CONTINGENT must also sum to 100%"
      - "IRREVOCABLE beneficiaries cannot be changed without consent"
    indexes:
      - name: "idx_benefit_beneficiary_employee"
        columns: [employee_id]
      - name: "idx_benefit_beneficiary_plan"
        columns: [plan_id]
      - name: "idx_benefit_beneficiary_type"
        columns: [employee_id, beneficiary_type, sequence]
      - name: "idx_benefit_beneficiary_status"
        columns: [status]

  Enrollment:
    description: |
      Employee benefit enrollment record.
      Tracks coverage elections and status.
    attributes:
      id:
        type: UUID
        required: true
      employee_id:
        type: UUID
        required: true
        description: "FK to Core.Employee"
      option_id:
        type: UUID
        required: true
        description: "FK to BenefitOption"
      enrollment_period_id:
        type: UUID
        description: "FK to EnrollmentPeriod (if enrolled during period)"
      life_event_id:
        type: UUID
        description: "FK to LifeEvent (if triggered by life event)"
      coverage_start_date:
        type: date
        required: true
      coverage_end_date:
        type: date
        description: "NULL = ongoing coverage"
      status:
        type: enum
        default: ACTIVE
        values: [ACTIVE, WAIVED, TERMINATED, PENDING, SUSPENDED]
      waiver_reason:
        type: string
        maxLength: 200
        description: "Reason for waiving coverage"
      premium_employee:
        type: decimal
        precision: [18, 4]
        description: "Employee premium amount per period"
      premium_employer:
        type: decimal
        precision: [18, 4]
        description: "Employer premium amount per period"
      currency:
        type: string
        required: true
        maxLength: 3
      covered_dependents_json:
        type: jsonb
        description: |
          Dependents covered:
          {
            "dependent_ids": ["uuid1", "uuid2"],
            "count": 2
          }
      metadata:
        type: jsonb
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      employee:
        target: Core.Employee
        cardinality: "N:1"
      option:
        target: BenefitOption
        cardinality: "N:1"
      enrollmentPeriod:
        target: EnrollmentPeriod
        cardinality: "N:1"
      lifeEvent:
        target: LifeEvent
        cardinality: "N:1"
    businessRules:
      - "Only one ACTIVE enrollment per plan per employee"
      - "WAIVED status requires waiver_reason"
      - "coverage_end_date must be after coverage_start_date"
      - "Premiums calculated from BenefitOption costs"
    indexes:
      - name: "idx_enrollment_employee"
        columns: [employee_id]
      - name: "idx_enrollment_option"
        columns: [option_id]
      - name: "idx_enrollment_status"
        columns: [status]
      - name: "idx_enrollment_coverage"
        columns: [coverage_start_date, coverage_end_date]
      - name: "idx_enrollment_period"
        columns: [enrollment_period_id]
      - name: "idx_enrollment_life_event"
        columns: [life_event_id]

  ReimbursementRequest:
    description: |
      Employee reimbursement request for expenses.
      Supports medical, wellness, education, and general expenses.
    attributes:
      id:
        type: UUID
        required: true
      employee_id:
        type: UUID
        required: true
        description: "FK to Core.Employee"
      option_id:
        type: UUID
        description: "FK to BenefitOption (if related to benefit plan)"
      request_type:
        type: enum
        required: true
        values: [EXPENSE, MEDICAL, WELLNESS, EDUCATION, TRANSPORTATION, CHILDCARE]
        description: "Type of reimbursement"
      request_date:
        type: date
        required: true
      status:
        type: enum
        default: DRAFT
        values: [DRAFT, SUBMITTED, APPROVED, REJECTED, PAID, CANCELLED]
      total_amount:
        type: decimal
        required: true
        precision: [18, 4]
        description: "Total requested amount"
      approved_amount:
        type: decimal
        precision: [18, 4]
        description: "Approved amount (may differ from requested)"
      currency:
        type: string
        required: true
        maxLength: 3
      approver_id:
        type: UUID
        description: "FK to Core.Employee (approver)"
      decision_date:
        type: timestamp
      decision_note:
        type: text
      payment_date:
        type: date
        description: "When reimbursement was paid"
      payment_method:
        type: enum
        values: [BANK_TRANSFER, PAYROLL, CHECK, CASH]
      metadata:
        type: jsonb
      created_at:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      employee:
        target: Core.Employee
        cardinality: "N:1"
      option:
        target: BenefitOption
        cardinality: "N:1"
      approver:
        target: Core.Employee
        cardinality: "N:1"
      lines:
        target: ReimbursementLine
        cardinality: "1:N"
    businessRules:
      - "approved_amount <= total_amount"
      - "Cannot modify APPROVED or PAID request"
      - "Supporting documents required"
    indexes:
      - name: "idx_reimbursement_employee"
        columns: [employee_id]
      - name: "idx_reimbursement_option"
        columns: [option_id]
      - name: "idx_reimbursement_status"
        columns: [status]
      - name: "idx_reimbursement_date"
        columns: [request_date]
      - name: "idx_reimbursement_approver"
        columns: [approver_id]

  ReimbursementLine:
    description: |
      Individual line item in reimbursement request.
      Supports multiple expenses per request.
    attributes:
      id:
        type: UUID
        required: true
      request_id:
        type: UUID
        required: true
        description: "FK to ReimbursementRequest"
      line_number:
        type: integer
        required: true
        description: "Line sequence (1, 2, 3...)"
      description:
        type: string
        required: true
        maxLength: 255
        description: "Expense description"
      expense_date:
        type: date
        required: true
        description: "When expense was incurred"
      amount:
        type: decimal
        required: true
        precision: [18, 4]
      currency:
        type: string
        required: true
        maxLength: 3
      receipt_url:
        type: string
        maxLength: 500
        description: "URL to receipt/invoice document"
      metadata:
        type: jsonb
    relationships:
      request:
        target: ReimbursementRequest
        cardinality: "N:1"
    constraints:
      - name: "uk_reimbursement_line"
        type: unique
        fields: [request_id, line_number]
    indexes:
      - name: "idx_reimbursement_line_request"
        columns: [request_id, line_number]

  HealthcareClaimHeader:
    description: |
      Healthcare insurance claim header.
      Tracks claim submission and payment status.
    attributes:
      id:
        type: UUID
        required: true
      employee_id:
        type: UUID
        required: true
        description: "FK to Core.Employee"
      enrollment_id:
        type: UUID
        description: "FK to Enrollment (related benefit enrollment)"
      insurer_claim_id:
        type: string
        maxLength: 50
        description: "Claim ID from insurance provider"
      service_date:
        type: date
        required: true
        description: "Date of medical service"
      provider_name:
        type: string
        maxLength: 255
        description: "Healthcare provider name"
      claim_status:
        type: enum
        default: SUBMITTED
        values: [SUBMITTED, IN_REVIEW, APPROVED, REJECTED, PAID, APPEALED]
      amount:
        type: decimal
        required: true
        precision: [18, 4]
        description: "Total claim amount"
      approved_amount:
        type: decimal
        precision: [18, 4]
        description: "Approved amount by insurer"
      paid_amount:
        type: decimal
        precision: [18, 4]
        description: "Amount paid to provider/employee"
      currency:
        type: string
        required: true
        maxLength: 3
      metadata:
        type: jsonb
      created_at:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
    relationships:
      employee:
        target: Core.Employee
        cardinality: "N:1"
      enrollment:
        target: Enrollment
        cardinality: "N:1"
      lines:
        target: HealthcareClaimLine
        cardinality: "1:N"
    indexes:
      - name: "idx_healthcare_claim_employee"
        columns: [employee_id]
      - name: "idx_healthcare_claim_status"
        columns: [claim_status]
      - name: "idx_healthcare_claim_service_date"
        columns: [service_date]
      - name: "idx_healthcare_claim_insurer"
        columns: [insurer_claim_id]

  HealthcareClaimLine:
    description: |
      Individual procedure/service line in healthcare claim.
      Tracks specific medical procedures and charges.
    attributes:
      id:
        type: UUID
        required: true
      claim_header_id:
        type: UUID
        required: true
        description: "FK to HealthcareClaimHeader"
      procedure_code:
        type: string
        required: true
        maxLength: 50
        description: "Medical procedure code (CPT, ICD-10)"
      description:
        type: text
        description: "Procedure description"
      charge_amount:
        type: decimal
        required: true
        precision: [18, 4]
        description: "Provider charge amount"
      allowed_amount:
        type: decimal
        precision: [18, 4]
        description: "Insurance allowed amount"
      currency:
        type: string
        required: true
        maxLength: 3
      metadata:
        type: jsonb
    relationships:
      claimHeader:
        target: HealthcareClaimHeader
        cardinality: "N:1"
    indexes:
      - name: "idx_healthcare_claim_line_header"
        columns: [claim_header_id]
      - name: "idx_healthcare_claim_line_procedure"
        columns: [procedure_code]

  # ===========================================================================
  # RECOGNITION SCHEMA
  # ===========================================================================

  RecognitionEventType:
    description: |
      Types of recognition events (awards, achievements).
      Defines point values and criteria.
    attributes:
      code:
        type: string
        required: true
        maxLength: 50
        description: "Event type code (e.g., PEER_RECOGNITION, MILESTONE, INNOVATION)"
      name:
        type: string
        required: true
        maxLength: 100
      description:
        type: text
      default_points:
        type: integer
        required: true
        description: "Default points awarded for this event type"
      min_points:
        type: integer
        description: "Minimum points allowed"
      max_points:
        type: integer
        description: "Maximum points allowed"
      requires_approval:
        type: boolean
        default: false
        description: "Whether event requires manager approval"
      metadata:
        type: jsonb
      is_active:
        type: boolean
        default: true
    relationships:
      events:
        target: RecognitionEvent
        cardinality: "1:N"
    constraints:
      - name: "pk_recognition_event_type"
        type: primary_key
        fields: [code]
    indexes:
      - name: "idx_recognition_event_type_active"
        columns: [is_active]
        where: "is_active = true"

  PerkCategory:
    description: |
      Categories for perk catalog organization.
      Examples: Electronics, Travel, Wellness, Experiences.
    attributes:
      id:
        type: UUID
        required: true
      code:
        type: string
        required: true
        maxLength: 50
      name:
        type: string
        required: true
        maxLength: 100
      description:
        type: text
      is_active:
        type: boolean
        default: true
    relationships:
      perks:
        target: PerkCatalog
        cardinality: "1:N"
    constraints:
      - name: "uk_perk_category_code"
        type: unique
        fields: [code]
    indexes:
      - name: "idx_perk_category_code"
        columns: [code]
      - name: "idx_perk_category_active"
        columns: [is_active]
        where: "is_active = true"

  PerkCatalog:
    description: |
      Catalog of redeemable perks/rewards.
      Employees can redeem points for perks.
    attributes:
      id:
        type: UUID
        required: true
      code:
        type: string
        required: true
        maxLength: 50
      name:
        type: string
        required: true
        maxLength: 200
      category_id:
        type: UUID
        required: true
        description: "FK to PerkCategory"
      points_cost:
        type: integer
        required: true
        description: "Points required to redeem"
      inventory:
        type: integer
        description: "Available inventory (NULL = unlimited)"
      redeem_limit_per_employee:
        type: integer
        description: "Max redemptions per employee (NULL = unlimited)"
      status:
        type: enum
        default: ACTIVE
        values: [ACTIVE, INACTIVE, OUT_OF_STOCK, DISCONTINUED]
      image_url:
        type: string
        maxLength: 500
      description:
        type: text
      metadata:
        type: jsonb
      effective_start_date:
        type: date
        required: true
      effective_end_date:
        type: date
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
    relationships:
      category:
        target: PerkCategory
        cardinality: "N:1"
      redemptions:
        target: PerkRedemption
        cardinality: "1:N"
    constraints:
      - name: "uk_perk_catalog_code"
        type: unique
        fields: [code]
    businessRules:
      - "inventory decremented on redemption"
      - "OUT_OF_STOCK when inventory = 0"
      - "redeem_limit_per_employee enforced"
    indexes:
      - name: "idx_perk_catalog_code"
        columns: [code]
      - name: "idx_perk_catalog_category"
        columns: [category_id]
      - name: "idx_perk_catalog_status"
        columns: [status]
      - name: "idx_perk_catalog_points"
        columns: [points_cost]

  PointAccount:
    description: |
      Employee point account for recognition program.
      Tracks balance, earned, spent, and expiration.
      ENHANCED - Added point expiration tracking.
    attributes:
      employee_id:
        type: UUID
        required: true
        description: "PK and FK to Core.Employee"
      balance:
        type: integer
        default: 0
        description: "Current available points"
      lifetime_earned:
        type: integer
        default: 0
        description: "Total points earned all time"
      lifetime_spent:
        type: integer
        default: 0
        description: "Total points spent all time"
      lifetime_expired:
        type: integer
        default: 0
        description: "Total points expired (NEW)"
      pending_expiration:
        type: integer
        default: 0
        description: "Points expiring soon (within 30 days) (NEW)"
      next_expiration_date:
        type: date
        description: "Date of next point expiration (NEW)"
      next_expiration_amount:
        type: integer
        description: "Amount expiring on next_expiration_date (NEW)"
      expiration_policy_json:
        type: jsonb
        description: |
          Point expiration policy (NEW):
          {
            "enabled": true,
            "expiration_months": 12,
            "warning_days": 30,
            "auto_expire": true
          }
      last_updated:
        type: timestamp
        default: now()
      created_date:
        type: timestamp
        default: now()
    relationships:
      employee:
        target: Core.Employee
        cardinality: "1:1"
      transactions:
        target: RewardPointTransaction
        cardinality: "1:N"
    constraints:
      - name: "pk_point_account"
        type: primary_key
        fields: [employee_id]
      - name: "chk_point_account_balance"
        type: check
        expression: "balance >= 0"
    businessRules:
      - "balance = lifetime_earned - lifetime_spent - lifetime_expired"
      - "Points expire after expiration_months (typically 12 months)"
      - "Warning sent when pending_expiration > 0"
      - "Auto-expiration runs monthly"
    indexes:
      - name: "idx_point_account_balance"
        columns: [balance]
      - name: "idx_point_account_expiration"
        columns: [next_expiration_date]
        where: "next_expiration_date IS NOT NULL"

  RecognitionEvent:
    description: |
      Individual recognition event record.
      Tracks who recognized whom, for what, and points awarded.
    attributes:
      id:
        type: UUID
        required: true
      employee_from_id:
        type: UUID
        required: true
        description: "FK to Core.Employee (giver)"
      employee_to_id:
        type: UUID
        required: true
        description: "FK to Core.Employee (receiver)"
      event_type_code:
        type: string
        required: true
        maxLength: 50
        description: "FK to RecognitionEventType"
      points_awarded:
        type: integer
        required: true
        description: "Points awarded in this event"
      reason:
        type: enum
        values: [PERFORMANCE, TEAMWORK, INNOVATION, VALUES, MILESTONE, CUSTOMER_SERVICE, LEADERSHIP]
        description: "Recognition reason category"
      message:
        type: text
        description: "Recognition message/note"
      status:
        type: enum
        default: PENDING
        values: [PENDING, APPROVED, REJECTED, CANCELLED]
      approver_id:
        type: UUID
        description: "FK to Core.Employee (approver if required)"
      decision_date:
        type: timestamp
      decision_note:
        type: text
      created_at:
        type: timestamp
        default: now()
      metadata:
        type: jsonb
    relationships:
      employeeFrom:
        target: Core.Employee
        cardinality: "N:1"
        description: "Recognition giver"
      employeeTo:
        target: Core.Employee
        cardinality: "N:1"
        description: "Recognition receiver"
      eventType:
        target: RecognitionEventType
        cardinality: "N:1"
      approver:
        target: Core.Employee
        cardinality: "N:1"
    businessRules:
      - "Points awarded when status = APPROVED"
      - "Points within min/max range for event type"
      - "Approval required if event_type.requires_approval = true"
    indexes:
      - name: "idx_recognition_event_from"
        columns: [employee_from_id]
      - name: "idx_recognition_event_to"
        columns: [employee_to_id]
      - name: "idx_recognition_event_type"
        columns: [event_type_code]
      - name: "idx_recognition_event_status"
        columns: [status]
      - name: "idx_recognition_event_created"
        columns: [created_at]

  RewardPointTransaction:
    description: |
      Point transaction history (earn, spend, adjust, expire).
      Complete audit trail of all point movements.
      ENHANCED - Added expiration tracking.
    attributes:
      id:
        type: UUID
        required: true
      employee_id:
        type: UUID
        required: true
        description: "FK to Core.Employee"
      points_delta:
        type: integer
        required: true
        description: "Point change (positive = earn, negative = spend/expire)"
      balance_after:
        type: integer
        required: true
        description: "Balance after this transaction"
      txn_type:
        type: enum
        required: true
        values: [EARNED, SPENT, ADJUSTED, EXPIRED, REVERSED]
        description: "Transaction type (ENHANCED with EXPIRED)"
      reference_type:
        type: enum
        values: [RECOGNITION_EVENT, PERK_REDEMPTION, MANUAL_ADJUSTMENT, EXPIRATION, REVERSAL]
        description: "What triggered this transaction"
      reference_id:
        type: UUID
        description: "ID of triggering record (recognition_event_id, redemption_id, etc.)"
      expiration_date:
        type: date
        description: "When these points expire (for EARNED transactions) (NEW)"
      description:
        type: string
        maxLength: 500
        description: "Transaction description"
      txn_date:
        type: timestamp
        default: now()
      metadata:
        type: jsonb
    relationships:
      employee:
        target: Core.Employee
        cardinality: "N:1"
    businessRules:
      - "EARNED points have expiration_date (typically +12 months)"
      - "SPENT/EXPIRED points are negative"
      - "balance_after must be >= 0"
      - "Oldest points spent/expired first (FIFO)"
    indexes:
      - name: "idx_reward_point_txn_employee"
        columns: [employee_id, txn_date]
      - name: "idx_reward_point_txn_type"
        columns: [txn_type]
      - name: "idx_reward_point_txn_reference"
        columns: [reference_type, reference_id]
      - name: "idx_reward_point_txn_expiration"
        columns: [expiration_date]
        where: "expiration_date IS NOT NULL"

  PerkRedemption:
    description: |
      Perk redemption request and fulfillment tracking.
      Links points spent to perks received.
    attributes:
      id:
        type: UUID
        required: true
      employee_id:
        type: UUID
        required: true
        description: "FK to Core.Employee"
      perk_id:
        type: UUID
        required: true
        description: "FK to PerkCatalog"
      points_spent:
        type: integer
        required: true
        description: "Points deducted for this redemption"
      quantity:
        type: integer
        default: 1
        description: "Number of items redeemed"
      status:
        type: enum
        default: REQUESTED
        values: [REQUESTED, APPROVED, REJECTED, FULFILLED, CANCELLED]
      request_date:
        type: timestamp
        default: now()
      fulfillment_date:
        type: timestamp
        description: "When perk was delivered/fulfilled"
      fulfilled_by:
        type: UUID
        description: "FK to Core.Employee (fulfillment admin)"
      delivery_address_json:
        type: jsonb
        description: |
          Delivery information:
          {
            "address": "123 Main St, City, State, ZIP",
            "phone": "+1-555-1234",
            "notes": "Leave at front desk"
          }
      tracking_number:
        type: string
        maxLength: 100
        description: "Shipping tracking number"
      metadata:
        type: jsonb
    relationships:
      employee:
        target: Core.Employee
        cardinality: "N:1"
      perk:
        target: PerkCatalog
        cardinality: "N:1"
      fulfilledBy:
        target: Core.Employee
        cardinality: "N:1"
    businessRules:
      - "Points deducted when status = APPROVED"
      - "Inventory decremented when status = APPROVED"
      - "Cannot cancel FULFILLED redemption"
    indexes:
      - name: "idx_perk_redemption_employee"
        columns: [employee_id]
      - name: "idx_perk_redemption_perk"
        columns: [perk_id]
      - name: "idx_perk_redemption_status"
        columns: [status]
      - name: "idx_perk_redemption_request_date"
        columns: [request_date]

# Continue in next message for remaining modules...

  # ===========================================================================
  # OFFER MANAGEMENT SCHEMA
  # ===========================================================================

  OfferTemplate:
    description: |
      Reusable total rewards offer template.
      Defines standard offer structure for new hires, promotions, retention.
    attributes:
      id:
        type: UUID
        required: true
      code:
        type: string
        required: true
        maxLength: 50
        description: "Template code (e.g., NEW_HIRE_ENG_L5, RETENTION_EXEC)"
      name:
        type: string
        required: true
        maxLength: 200
      description:
        type: text
      version_no:
        type: integer
        default: 1
        description: "Template version number"
      offer_type:
        type: enum
        required: true
        values: [NEW_HIRE, PROMOTION, RETENTION, COUNTER_OFFER, INTERNAL_TRANSFER]
        description: "Type of offer"
      components_json:
        type: jsonb
        required: true
        description: |
          Offer components structure:
          {
            "fixed_compensation": {
              "base_salary": {"amount": null, "currency": "VND", "frequency": "MONTHLY"},
              "allowances": [
                {"component": "LUNCH", "amount": 730000},
                {"component": "TRANSPORT", "amount": 500000}
              ]
            },
            "variable_compensation": {
              "sti_target_pct": 0.15,
              "lti_eligible": true,
              "equity_units": null
            },
            "benefits": {
              "medical": "PREMIUM_PLAN",
              "dental": "STANDARD_PLAN",
              "life_insurance": "2X_SALARY"
            },
            "perks": {
              "signing_bonus": null,
              "relocation": null,
              "education_allowance": 10000000
            }
          }
      approval_workflow_json:
        type: jsonb
        description: |
          Approval workflow:
          {
            "levels": [
              {"level": 1, "role": "HIRING_MANAGER", "required": true},
              {"level": 2, "role": "HR_DIRECTOR", "required": true},
              {"level": 3, "role": "CFO", "required_if": "total_value > 100000000"}
            ]
          }
      metadata:
        type: jsonb
      created_by:
        type: UUID
        required: true
        description: "FK to Core.Employee"
      created_at:
        type: timestamp
        default: now()
      effective_start_date:
        type: date
        required: true
      effective_end_date:
        type: date
      is_active:
        type: boolean
        default: true
    relationships:
      creator:
        target: Core.Employee
        cardinality: "N:1"
      events:
        target: OfferTemplateEvent
        cardinality: "1:N"
      packages:
        target: OfferPackage
        cardinality: "1:N"
    constraints:
      - name: "uk_offer_template_code_version"
        type: unique
        fields: [code, version_no]
    businessRules:
      - "Template versioned for change tracking"
      - "components_json defines offer structure"
      - "Approval workflow based on offer value"
    indexes:
      - name: "idx_offer_template_code"
        columns: [code, version_no]
        unique: true
      - name: "idx_offer_template_active"
        columns: [is_active]
        where: "is_active = true"
      - name: "idx_offer_template_type"
        columns: [offer_type]

  OfferTemplateEvent:
    description: |
      Audit trail for template changes.
      Tracks creation, updates, activation, deactivation.
    attributes:
      id:
        type: UUID
        required: true
      template_id:
        type: UUID
        required: true
        description: "FK to OfferTemplate"
      event_type:
        type: enum
        required: true
        values: [CREATED, UPDATED, ACTIVATED, DEACTIVATED, CLONED]
        description: "Event type"
      event_time:
        type: timestamp
        default: now()
      event_by:
        type: UUID
        description: "FK to Core.Employee (who triggered event)"
      changes_json:
        type: jsonb
        description: |
          Change details:
          {
            "field": "components_json.fixed_compensation.base_salary",
            "old_value": 50000000,
            "new_value": 55000000,
            "reason": "Market adjustment"
          }
      metadata:
        type: jsonb
    relationships:
      template:
        target: OfferTemplate
        cardinality: "N:1"
      eventBy:
        target: Core.Employee
        cardinality: "N:1"
    indexes:
      - name: "idx_offer_template_event_template"
        columns: [template_id, event_time]
      - name: "idx_offer_template_event_type"
        columns: [event_type]

  OfferPackage:
    description: |
      Specific offer package for a candidate/employee.
      Instantiates template with actual values.
    attributes:
      id:
        type: UUID
        required: true
      template_id:
        type: UUID
        required: true
        description: "FK to OfferTemplate"
      worker_id:
        type: UUID
        required: true
        description: "FK to Core.Worker (candidate)"
      employee_id:
        type: UUID
        description: "FK to Core.Employee (if existing employee for retention/promotion)"
      offer_type:
        type: enum
        required: true
        values: [NEW_HIRE, PROMOTION, RETENTION, COUNTER_OFFER, INTERNAL_TRANSFER]
      position_title:
        type: string
        maxLength: 200
        description: "Position being offered"
      grade_id:
        type: UUID
        description: "FK to GradeVersion"
      legal_entity_id:
        type: UUID
        description: "FK to Core.LegalEntity"
      currency:
        type: string
        required: true
        maxLength: 3
      total_fixed_cash:
        type: decimal
        precision: [18, 4]
        description: "Total fixed compensation (base + allowances)"
      total_variable:
        type: decimal
        precision: [18, 4]
        description: "Total variable compensation (target STI + LTI)"
      total_benefits:
        type: decimal
        precision: [18, 4]
        description: "Total benefits value (estimated annual)"
      total_cash:
        type: decimal
        required: true
        precision: [18, 4]
        description: "total_fixed_cash + total_variable"
      total_value:
        type: decimal
        required: true
        precision: [18, 4]
        description: "total_cash + total_benefits"
      cost_json:
        type: jsonb
        description: |
          Detailed cost breakdown:
          {
            "fixed": {
              "base_salary": 60000000,
              "allowances": 5000000
            },
            "variable": {
              "sti_target": 9000000,
              "lti_target": 6000000
            },
            "benefits": {
              "medical": 3000000,
              "retirement": 4800000
            },
            "one_time": {
              "signing_bonus": 10000000,
              "relocation": 5000000
            }
          }
      status:
        type: enum
        default: DRAFT
        values: [DRAFT, PENDING, APPROVED, SENT, VIEWED, ACCEPTED, REJECTED, EXPIRED, WITHDRAWN]
      approved_by:
        type: UUID
        description: "FK to Core.Employee (final approver)"
      approved_at:
        type: timestamp
      sent_date:
        type: date
        description: "When offer was sent to candidate"
      viewed_date:
        type: timestamp
        description: "When candidate first viewed offer"
      response_deadline:
        type: date
        description: "Deadline for candidate response"
      expires_at:
        type: date
        description: "Offer expiration date"
      start_date:
        type: date
        description: "Proposed start date"
      metadata:
        type: jsonb
      created_at:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_at:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      template:
        target: OfferTemplate
        cardinality: "N:1"
      worker:
        target: Core.Worker
        cardinality: "N:1"
      employee:
        target: Core.Employee
        cardinality: "N:1"
      grade:
        target: GradeVersion
        cardinality: "N:1"
      legalEntity:
        target: Core.LegalEntity
        cardinality: "N:1"
      approver:
        target: Core.Employee
        cardinality: "N:1"
      creator:
        target: Core.Employee
        cardinality: "N:1"
      events:
        target: OfferEvent
        cardinality: "1:N"
      acceptance:
        target: OfferAcceptance
        cardinality: "1:1"
    businessRules:
      - "total_cash = total_fixed_cash + total_variable"
      - "total_value = total_cash + total_benefits"
      - "Cannot modify ACCEPTED or REJECTED offer"
      - "Expires if no response by expires_at"
      - "VIEWED status set when candidate opens offer letter"
    indexes:
      - name: "idx_offer_package_worker"
        columns: [worker_id]
      - name: "idx_offer_package_employee"
        columns: [employee_id]
      - name: "idx_offer_package_status"
        columns: [status]
      - name: "idx_offer_package_type"
        columns: [offer_type]
      - name: "idx_offer_package_sent_date"
        columns: [sent_date]
      - name: "idx_offer_package_expires"
        columns: [expires_at]

  OfferEvent:
    description: |
      Offer package event tracking.
      Complete audit trail of offer lifecycle.
    attributes:
      id:
        type: UUID
        required: true
      package_id:
        type: UUID
        required: true
        description: "FK to OfferPackage"
      event_type:
        type: enum
        required: true
        values: [CREATED, SENT, VIEWED, REMINDER, ACCEPTED, REJECTED, EXPIRED, WITHDRAWN, MODIFIED, APPROVED]
        description: "Event type"
      event_time:
        type: timestamp
        default: now()
      event_by:
        type: UUID
        description: "FK to Core.Employee or Worker (who triggered event)"
      event_details_json:
        type: jsonb
        description: |
          Event details:
          {
            "ip_address": "192.168.1.1",
            "user_agent": "Mozilla/5.0...",
            "location": "Ho Chi Minh City, VN",
            "device": "Desktop",
            "notes": "Candidate requested higher base salary"
          }
      metadata:
        type: jsonb
    relationships:
      package:
        target: OfferPackage
        cardinality: "N:1"
    indexes:
      - name: "idx_offer_event_package"
        columns: [package_id, event_time]
      - name: "idx_offer_event_type"
        columns: [event_type]

  OfferAcceptance:
    description: |
      Offer acceptance/rejection record.
      Captures candidate decision and signature.
    attributes:
      id:
        type: UUID
        required: true
      package_id:
        type: UUID
        required: true
        description: "FK to OfferPackage"
      accepted:
        type: boolean
        required: true
        description: "true = accepted, false = rejected"
      accepted_at:
        type: timestamp
        description: "When offer was accepted"
      rejected_at:
        type: timestamp
        description: "When offer was rejected"
      rejection_reason:
        type: text
        description: "Why candidate rejected offer"
      rejection_category:
        type: enum
        values: [COMPENSATION, LOCATION, ROLE, COMPANY_FIT, COMPETING_OFFER, PERSONAL_REASONS, OTHER]
        description: "Rejection reason category"
      signed_doc_url:
        type: string
        maxLength: 500
        description: "URL to signed offer letter (e-signature)"
      signature_ip:
        type: string
        maxLength: 50
        description: "IP address of signature"
      signature_timestamp:
        type: timestamp
        description: "When document was signed"
      counter_offer_json:
        type: jsonb
        description: |
          Candidate counter-offer:
          {
            "requested_base_salary": 70000000,
            "requested_signing_bonus": 15000000,
            "requested_start_date": "2025-02-01",
            "notes": "Current employer counter-offered"
          }
      metadata:
        type: jsonb
    relationships:
      package:
        target: OfferPackage
        cardinality: "1:1"
    businessRules:
      - "accepted and rejected_at are mutually exclusive"
      - "signed_doc_url required if accepted = true"
      - "rejection_reason required if accepted = false"
      - "Counter-offer triggers negotiation workflow"
    indexes:
      - name: "idx_offer_acceptance_package"
        columns: [package_id]
        unique: true
      - name: "idx_offer_acceptance_accepted"
        columns: [accepted]
      - name: "idx_offer_acceptance_rejection_category"
        columns: [rejection_category]

  # ===========================================================================
  # TAXABLE BRIDGE SCHEMA
  # ===========================================================================

  TaxableItem:
    description: |
      Bridge table to payroll for taxable benefits.
      Captures non-cash compensation that must be taxed.
    attributes:
      id:
        type: UUID
        required: true
      source_module:
        type: enum
        required: true
        values: [BENEFIT, EQUITY, PERK, RECOGNITION, REIMBURSEMENT, OTHER]
        description: "Source module"
      source_table:
        type: string
        required: true
        maxLength: 50
        description: "Source table name"
      source_id:
        type: UUID
        required: true
        description: "Source record ID"
      employee_id:
        type: UUID
        required: true
        description: "FK to Core.Employee"
      benefit_type:
        type: string
        required: true
        maxLength: 50
        description: "Type of taxable benefit (GIFT_CARD, CAR_ALLOWANCE, EQUITY_VEST, etc.)"
      taxable_amount:
        type: decimal
        required: true
        precision: [18, 4]
        description: "Taxable value"
      currency:
        type: string
        required: true
        maxLength: 3
      tax_year:
        type: integer
        required: true
        description: "Tax year (e.g., 2025)"
      tax_period:
        type: string
        maxLength: 10
        description: "Tax period (e.g., 2025-01, 2025-Q1)"
      payroll_batch_id:
        type: UUID
        description: "FK to Payroll.Batch (when processed)"
      processed_flag:
        type: boolean
        default: false
        description: "Whether item has been processed in payroll"
      processed_at:
        type: timestamp
        description: "When item was processed"
      tax_withheld:
        type: decimal
        precision: [18, 4]
        description: "Tax amount withheld"
      metadata:
        type: jsonb
      created_at:
        type: timestamp
        default: now()
    relationships:
      employee:
        target: Core.Employee
        cardinality: "N:1"
    businessRules:
      - "Created when taxable event occurs (equity vest, perk redemption, etc.)"
      - "Processed by payroll module for tax withholding"
      - "Reported on annual tax forms (W-2, 1099, etc.)"
    indexes:
      - name: "idx_taxable_item_employee"
        columns: [employee_id, tax_year]
      - name: "idx_taxable_item_source"
        columns: [source_module, source_table, source_id]
      - name: "idx_taxable_item_processed"
        columns: [processed_flag]
        where: "processed_flag = false"
      - name: "idx_taxable_item_payroll"
        columns: [payroll_batch_id]
      - name: "idx_taxable_item_tax_year"
        columns: [tax_year, tax_period]

  # ===========================================================================
  # TOTAL REWARDS STATEMENT SCHEMA
  # ===========================================================================

  StatementConfiguration:
    description: |
      Total rewards statement configuration.
      Defines layout, sections, and generation schedule.
    attributes:
      id:
        type: UUID
        required: true
      code:
        type: string
        required: true
        maxLength: 50
        description: "Config code (e.g., ANNUAL_TR_STATEMENT_2025)"
      name:
        type: string
        required: true
        maxLength: 200
      description:
        type: text
      version_no:
        type: integer
        default: 1
      layout_json:
        type: jsonb
        required: true
        description: |
          Statement layout:
          {
            "sections": [
              {"code": "FIXED_COMP", "title": "Fixed Compensation", "order": 1},
              {"code": "VARIABLE_COMP", "title": "Variable Compensation", "order": 2},
              {"code": "BENEFITS", "title": "Benefits", "order": 3},
              {"code": "PERKS", "title": "Perks & Recognition", "order": 4},
              {"code": "TOTAL", "title": "Total Rewards Value", "order": 5}
            ],
            "template": "STANDARD",
            "language": "EN",
            "currency_display": "VND"
          }
      schedule_json:
        type: jsonb
        description: |
          Generation schedule:
          {
            "frequency": "ANNUAL",
            "generation_month": 1,
            "generation_day": 15,
            "auto_generate": true,
            "auto_distribute": false
          }
      metadata:
        type: jsonb
      is_active:
        type: boolean
        default: true
      created_by:
        type: UUID
        description: "FK to Core.Employee"
      created_at:
        type: timestamp
        default: now()
      updated_at:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      creator:
        target: Core.Employee
        cardinality: "N:1"
      jobs:
        target: StatementJob
        cardinality: "1:N"
    constraints:
      - name: "uk_statement_config_code_version"
        type: unique
        fields: [code, version_no]
    indexes:
      - name: "idx_statement_config_code"
        columns: [code, version_no]
        unique: true
      - name: "idx_statement_config_active"
        columns: [is_active]
        where: "is_active = true"

  StatementSection:
    description: |
      Predefined statement sections.
      Defines what data to include in each section.
    attributes:
      code:
        type: string
        required: true
        maxLength: 50
        description: "Section code (e.g., FIXED_COMP, BENEFITS)"
      name:
        type: string
        required: true
        maxLength: 100
      description:
        type: text
      data_source_json:
        type: jsonb
        description: |
          Data source definition:
          {
            "queries": [
              {
                "entity": "EmployeeCompensationSnapshot",
                "filters": {"status": "ACTIVE", "component_type": "BASE"},
                "aggregation": "SUM"
              }
            ]
          }
      sort_order:
        type: integer
        default: 0
      metadata:
        type: jsonb
      is_active:
        type: boolean
        default: true
    constraints:
      - name: "pk_statement_section"
        type: primary_key
        fields: [code]
    indexes:
      - name: "idx_statement_section_active"
        columns: [is_active]
        where: "is_active = true"
      - name: "idx_statement_section_order"
        columns: [sort_order]

  StatementJob:
    description: |
      Statement generation job.
      Batch process to generate statements for employees.
    attributes:
      id:
        type: UUID
        required: true
      config_id:
        type: UUID
        required: true
        description: "FK to StatementConfiguration"
      period_start:
        type: date
        required: true
        description: "Statement period start"
      period_end:
        type: date
        required: true
        description: "Statement period end"
      status:
        type: enum
        default: PENDING
        values: [PENDING, RUNNING, COMPLETED, FAILED, CANCELLED]
      started_at:
        type: timestamp
        description: "When job started"
      completed_at:
        type: timestamp
        description: "When job completed"
      total_employees:
        type: integer
        description: "Total employees to process"
      processed_employees:
        type: integer
        default: 0
        description: "Employees processed so far"
      failed_employees:
        type: integer
        default: 0
        description: "Employees that failed processing"
      file_url:
        type: string
        maxLength: 500
        description: "URL to batch output file (ZIP of all PDFs)"
      error_message:
        type: text
        description: "Error details if status = FAILED"
      metadata:
        type: jsonb
      created_by:
        type: UUID
        description: "FK to Core.Employee"
      created_at:
        type: timestamp
        default: now()
      updated_at:
        type: timestamp
    relationships:
      config:
        target: StatementConfiguration
        cardinality: "N:1"
      creator:
        target: Core.Employee
        cardinality: "N:1"
      lines:
        target: StatementLine
        cardinality: "1:N"
    constraints:
      - name: "uk_statement_job"
        type: unique
        fields: [config_id, period_start, period_end]
    businessRules:
      - "Cannot modify COMPLETED or FAILED job"
      - "Generates one StatementLine per employee"
    indexes:
      - name: "idx_statement_job_config"
        columns: [config_id, period_start, period_end]
        unique: true
      - name: "idx_statement_job_status"
        columns: [status]
      - name: "idx_statement_job_created"
        columns: [created_at]

  StatementLine:
    description: |
      Individual employee statement.
      Contains calculated total rewards data.
    attributes:
      id:
        type: UUID
        required: true
      job_id:
        type: UUID
        required: true
        description: "FK to StatementJob"
      employee_id:
        type: UUID
        required: true
        description: "FK to Core.Employee"
      section_code:
        type: string
        maxLength: 50
        description: "FK to StatementSection (NULL for summary)"
      statement_json:
        type: jsonb
        required: true
        description: |
          Statement data:
          {
            "employee": {
              "name": "John Doe",
              "employee_id": "EMP001",
              "grade": "G5",
              "department": "Engineering"
            },
            "fixed_compensation": {
              "base_salary": 60000000,
              "allowances": 5000000,
              "total": 65000000
            },
            "variable_compensation": {
              "sti_target": 9000000,
              "sti_actual": 10800000,
              "lti_value": 6000000,
              "total": 16800000
            },
            "benefits": {
              "medical": 3000000,
              "retirement": 4800000,
              "life_insurance": 1200000,
              "total": 9000000
            },
            "perks_recognition": {
              "points_earned": 5000,
              "perks_redeemed": 2000000,
              "total": 2000000
            },
            "total_rewards": 92800000
          }
      pdf_url:
        type: string
        maxLength: 500
        description: "URL to generated PDF statement"
      generated_at:
        type: timestamp
        default: now()
      sent_to_employee:
        type: boolean
        default: false
      sent_at:
        type: timestamp
      metadata:
        type: jsonb
    relationships:
      job:
        target: StatementJob
        cardinality: "N:1"
      employee:
        target: Core.Employee
        cardinality: "N:1"
      section:
        target: StatementSection
        cardinality: "N:1"
    indexes:
      - name: "idx_statement_line_job"
        columns: [job_id, employee_id]
      - name: "idx_statement_line_employee"
        columns: [employee_id]
      - name: "idx_statement_line_section"
        columns: [section_code]

  # ===========================================================================
  # DEDUCTIONS SCHEMA
  # ===========================================================================

  DeductionType:
    description: |
      Types of employee deductions.
      Defines deduction categories and rules.
      NEW - Addresses missing item from design review.
    attributes:
      id:
        type: UUID
        required: true
      code:
        type: string
        required: true
        maxLength: 50
        description: "Deduction type code (e.g., LOAN, GARNISHMENT, ADVANCE, UNION_DUES)"
      name:
        type: string
        required: true
        maxLength: 200
      category:
        type: enum
        required: true
        values: [LOAN, GARNISHMENT, ADVANCE, UNION_DUES, CHARITY, SAVINGS, INSURANCE, OTHER]
        description: "Deduction category"
      priority:
        type: integer
        default: 100
        description: "Deduction priority (lower = higher priority, e.g., garnishments = 1)"
      is_mandatory:
        type: boolean
        default: false
        description: "Whether deduction is mandatory (e.g., court-ordered garnishment)"
      max_percentage_of_net:
        type: decimal
        precision: [5, 2]
        description: "Maximum % of net pay (e.g., 25% for garnishments)"
      calculation_rule_json:
        type: jsonb
        description: |
          Calculation rules:
          {
            "basis": "NET_PAY",
            "max_pct": 0.25,
            "min_remaining_net": 5000000,
            "priority_order": 1
          }
      metadata:
        type: jsonb
      is_active:
        type: boolean
        default: true
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
    relationships:
      employeeDeductions:
        target: EmployeeDeduction
        cardinality: "1:N"
    constraints:
      - name: "uk_deduction_type_code"
        type: unique
        fields: [code]
    businessRules:
      - "GARNISHMENT has highest priority (1)"
      - "Total deductions cannot exceed max_percentage_of_net"
      - "Mandatory deductions processed first"
    indexes:
      - name: "idx_deduction_type_code"
        columns: [code]
      - name: "idx_deduction_type_category"
        columns: [category]
      - name: "idx_deduction_type_priority"
        columns: [priority]
      - name: "idx_deduction_type_active"
        columns: [is_active]
        where: "is_active = true"

  EmployeeDeduction:
    description: |
      Employee-specific deduction record.
      Links employee to deduction type with specific terms.
      NEW - Addresses missing item from design review.
    attributes:
      id:
        type: UUID
        required: true
      employee_id:
        type: UUID
        required: true
        description: "FK to Core.Employee"
      deduction_type_id:
        type: UUID
        required: true
        description: "FK to DeductionType"
      reference_number:
        type: string
        maxLength: 50
        description: "External reference (loan number, case number, etc.)"
      total_amount:
        type: decimal
        required: true
        precision: [18, 4]
        description: "Total deduction amount"
      remaining_amount:
        type: decimal
        required: true
        precision: [18, 4]
        description: "Remaining balance"
      currency:
        type: string
        required: true
        maxLength: 3
      installment_amount:
        type: decimal
        precision: [18, 4]
        description: "Fixed installment amount per period"
      installment_percentage:
        type: decimal
        precision: [5, 2]
        description: "Percentage of salary per period"
      start_date:
        type: date
        required: true
        description: "When deduction starts"
      end_date:
        type: date
        description: "When deduction ends (NULL = until paid off)"
      status:
        type: enum
        default: ACTIVE
        values: [ACTIVE, SUSPENDED, COMPLETED, CANCELLED]
      court_order_json:
        type: jsonb
        description: |
          Court order details (for garnishments):
          {
            "court_name": "District Court",
            "case_number": "12345-2025",
            "order_date": "2025-01-15",
            "creditor": "ABC Bank",
            "max_percentage": 0.25
          }
      metadata:
        type: jsonb
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      employee:
        target: Core.Employee
        cardinality: "N:1"
      deductionType:
        target: DeductionType
        cardinality: "N:1"
      schedule:
        target: DeductionSchedule
        cardinality: "1:N"
      transactions:
        target: DeductionTransaction
        cardinality: "1:N"
    businessRules:
      - "remaining_amount updated after each deduction"
      - "Status = COMPLETED when remaining_amount = 0"
      - "GARNISHMENT requires court_order_json"
      - "Either installment_amount or installment_percentage required"
    indexes:
      - name: "idx_employee_deduction_employee"
        columns: [employee_id]
      - name: "idx_employee_deduction_type"
        columns: [deduction_type_id]
      - name: "idx_employee_deduction_status"
        columns: [status]
      - name: "idx_employee_deduction_dates"
        columns: [start_date, end_date]

  DeductionSchedule:
    description: |
      Planned deduction schedule.
      Defines when and how much to deduct.
      NEW - Addresses missing item from design review.
    attributes:
      id:
        type: UUID
        required: true
      employee_deduction_id:
        type: UUID
        required: true
        description: "FK to EmployeeDeduction"
      scheduled_date:
        type: date
        required: true
        description: "When deduction should occur"
      scheduled_amount:
        type: decimal
        required: true
        precision: [18, 4]
        description: "Planned deduction amount"
      actual_amount:
        type: decimal
        precision: [18, 4]
        description: "Actual amount deducted (may differ due to insufficient funds)"
      status:
        type: enum
        default: PENDING
        values: [PENDING, PROCESSED, SKIPPED, FAILED]
      processed_date:
        type: date
        description: "When deduction was actually processed"
      payroll_batch_id:
        type: UUID
        description: "FK to Payroll.Batch"
      skip_reason:
        type: string
        maxLength: 200
        description: "Why deduction was skipped (insufficient funds, etc.)"
      metadata:
        type: jsonb
      created_date:
        type: timestamp
        default: now()
    relationships:
      employeeDeduction:
        target: EmployeeDeduction
        cardinality: "N:1"
    businessRules:
      - "Generated based on installment schedule"
      - "Status = SKIPPED if insufficient net pay"
      - "actual_amount may be less than scheduled_amount"
    indexes:
      - name: "idx_deduction_schedule_deduction"
        columns: [employee_deduction_id]
      - name: "idx_deduction_schedule_date"
        columns: [scheduled_date]
      - name: "idx_deduction_schedule_status"
        columns: [status]
      - name: "idx_deduction_schedule_payroll"
        columns: [payroll_batch_id]

  DeductionTransaction:
    description: |
      Actual deduction transaction record.
      Created when deduction is processed in payroll.
      NEW - Addresses missing item from design review.
    attributes:
      id:
        type: UUID
        required: true
      employee_deduction_id:
        type: UUID
        required: true
        description: "FK to EmployeeDeduction"
      schedule_id:
        type: UUID
        description: "FK to DeductionSchedule (if from schedule)"
      transaction_date:
        type: date
        required: true
      amount:
        type: decimal
        required: true
        precision: [18, 4]
        description: "Amount deducted"
      remaining_balance:
        type: decimal
        required: true
        precision: [18, 4]
        description: "Balance after this deduction"
      currency:
        type: string
        required: true
        maxLength: 3
      payroll_batch_id:
        type: UUID
        required: true
        description: "FK to Payroll.Batch"
      payment_method:
        type: enum
        values: [PAYROLL_DEDUCTION, BANK_TRANSFER, CHECK, CASH]
        default: PAYROLL_DEDUCTION
      payment_reference:
        type: string
        maxLength: 100
        description: "Payment confirmation number"
      metadata:
        type: jsonb
      created_date:
        type: timestamp
        default: now()
    relationships:
      employeeDeduction:
        target: EmployeeDeduction
        cardinality: "N:1"
      schedule:
        target: DeductionSchedule
        cardinality: "N:1"
    businessRules:
      - "remaining_balance = previous_balance - amount"
      - "Updates EmployeeDeduction.remaining_amount"
      - "Creates audit trail for compliance"
    indexes:
      - name: "idx_deduction_txn_deduction"
        columns: [employee_deduction_id]
      - name: "idx_deduction_txn_date"
        columns: [transaction_date]
      - name: "idx_deduction_txn_payroll"
        columns: [payroll_batch_id]
      - name: "idx_deduction_txn_schedule"
        columns: [schedule_id]

  # ===========================================================================
  # TAX WITHHOLDING SCHEMA
  # ===========================================================================

  TaxWithholding:
    description: |
      Monthly tax withholding record.
      Tracks tax withheld from employee pay.
      NEW - Addresses missing item from design review.
    attributes:
      id:
        type: UUID
        required: true
      employee_id:
        type: UUID
        required: true
        description: "FK to Core.Employee"
      tax_year:
        type: integer
        required: true
        description: "Tax year (e.g., 2025)"
      tax_month:
        type: integer
        required: true
        description: "Tax month (1-12)"
      gross_income:
        type: decimal
        required: true
        precision: [18, 4]
        description: "Total gross income for month"
      taxable_income:
        type: decimal
        required: true
        precision: [18, 4]
        description: "Income subject to tax (after deductions)"
      personal_deduction:
        type: decimal
        precision: [18, 4]
        description: "Personal deduction amount"
      dependent_deduction:
        type: decimal
        precision: [18, 4]
        description: "Dependent deduction amount"
      dependent_count:
        type: integer
        default: 0
        description: "Number of dependents claimed"
      si_contribution:
        type: decimal
        precision: [18, 4]
        description: "Social insurance contribution (deductible)"
      tax_withheld:
        type: decimal
        required: true
        precision: [18, 4]
        description: "Tax amount withheld"
      effective_tax_rate:
        type: decimal
        precision: [5, 4]
        description: "Effective tax rate (tax_withheld / taxable_income)"
      currency:
        type: string
        required: true
        maxLength: 3
      calculation_rule_id:
        type: UUID
        description: "FK to CalculationRuleDefinition (tax rule used)"
      calculation_details_json:
        type: jsonb
        description: |
          Tax calculation breakdown:
          {
            "gross": 60000000,
            "si_deduction": 6300000,
            "personal_deduction": 15500000,
            "dependent_deduction": 12400000,
            "taxable_income": 25800000,
            "brackets": [
              {"bracket": 1, "amount": 5000000, "rate": 0.05, "tax": 250000},
              {"bracket": 2, "amount": 5000000, "rate": 0.10, "tax": 500000},
              {"bracket": 3, "amount": 8000000, "rate": 0.15, "tax": 1200000},
              {"bracket": 4, "amount": 7800000, "rate": 0.20, "tax": 1560000}
            ],
            "total_tax": 3510000
          }
      payroll_batch_id:
        type: UUID
        required: true
        description: "FK to Payroll.Batch"
      metadata:
        type: jsonb
      created_date:
        type: timestamp
        default: now()
    relationships:
      employee:
        target: Core.Employee
        cardinality: "N:1"
      calculationRule:
        target: CalculationRuleDefinition
        cardinality: "N:1"
    constraints:
      - name: "uk_tax_withholding"
        type: unique
        fields: [employee_id, tax_year, tax_month]
    businessRules:
      - "One record per employee per month"
      - "taxable_income = gross_income - si_contribution - personal_deduction - dependent_deduction"
      - "effective_tax_rate = tax_withheld / taxable_income"
      - "Cumulative tracking for annual reconciliation"
    indexes:
      - name: "idx_tax_withholding_employee"
        columns: [employee_id, tax_year, tax_month]
        unique: true
      - name: "idx_tax_withholding_year"
        columns: [tax_year]
      - name: "idx_tax_withholding_payroll"
        columns: [payroll_batch_id]

  TaxDeclaration:
    description: |
      Annual tax declaration/filing.
      Employee's annual tax return data.
      NEW - Addresses missing item from design review.
    attributes:
      id:
        type: UUID
        required: true
      employee_id:
        type: UUID
        required: true
        description: "FK to Core.Employee"
      tax_year:
        type: integer
        required: true
        description: "Tax year (e.g., 2025)"
      declaration_type:
        type: enum
        required: true
        values: [ANNUAL_RETURN, AMENDED_RETURN, FINAL_RETURN]
        description: "Type of declaration"
      total_gross_income:
        type: decimal
        required: true
        precision: [18, 4]
        description: "Total annual gross income"
      total_taxable_income:
        type: decimal
        required: true
        precision: [18, 4]
        description: "Total annual taxable income"
      total_tax_withheld:
        type: decimal
        required: true
        precision: [18, 4]
        description: "Total tax withheld during year"
      total_tax_owed:
        type: decimal
        required: true
        precision: [18, 4]
        description: "Total tax owed for year"
      refund_amount:
        type: decimal
        precision: [18, 4]
        description: "Tax refund due (if tax_withheld > tax_owed)"
      additional_tax_due:
        type: decimal
        precision: [18, 4]
        description: "Additional tax due (if tax_owed > tax_withheld)"
      currency:
        type: string
        required: true
        maxLength: 3
      filing_status:
        type: enum
        default: DRAFT
        values: [DRAFT, SUBMITTED, ACCEPTED, REJECTED, AMENDED]
      filed_date:
        type: date
        description: "When declaration was filed"
      tax_authority_reference:
        type: string
        maxLength: 100
        description: "Tax authority confirmation number"
      declaration_json:
        type: jsonb
        description: |
          Complete declaration data:
          {
            "personal_info": {...},
            "income_sources": [...],
            "deductions": {...},
            "dependents": [...],
            "tax_calculation": {...},
            "payment_info": {...}
          }
      metadata:
        type: jsonb
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
      updated_date:
        type: timestamp
      updated_by:
        type: UUID
    relationships:
      employee:
        target: Core.Employee
        cardinality: "N:1"
      adjustments:
        target: TaxAdjustment
        cardinality: "1:N"
    constraints:
      - name: "uk_tax_declaration"
        type: unique
        fields: [employee_id, tax_year, declaration_type]
    businessRules:
      - "refund_amount = tax_withheld - tax_owed (if positive)"
      - "additional_tax_due = tax_owed - tax_withheld (if positive)"
      - "AMENDED_RETURN references original ANNUAL_RETURN"
      - "Filing deadline typically April 30 of following year"
    indexes:
      - name: "idx_tax_declaration_employee"
        columns: [employee_id, tax_year]
      - name: "idx_tax_declaration_year"
        columns: [tax_year]
      - name: "idx_tax_declaration_status"
        columns: [filing_status]
      - name: "idx_tax_declaration_filed"
        columns: [filed_date]

  TaxAdjustment:
    description: |
      Tax adjustments and corrections.
      Handles mid-year changes, corrections, and amendments.
      NEW - Addresses missing item from design review.
    attributes:
      id:
        type: UUID
        required: true
      employee_id:
        type: UUID
        required: true
        description: "FK to Core.Employee"
      declaration_id:
        type: UUID
        description: "FK to TaxDeclaration (if related to annual filing)"
      tax_year:
        type: integer
        required: true
      tax_month:
        type: integer
        description: "Month of adjustment (NULL for annual)"
      adjustment_type:
        type: enum
        required: true
        values: [DEPENDENT_CHANGE, INCOME_CORRECTION, DEDUCTION_CORRECTION, REFUND, ADDITIONAL_PAYMENT, PENALTY, INTEREST]
        description: "Type of adjustment"
      adjustment_amount:
        type: decimal
        required: true
        precision: [18, 4]
        description: "Adjustment amount (positive or negative)"
      currency:
        type: string
        required: true
        maxLength: 3
      reason:
        type: text
        required: true
        description: "Reason for adjustment"
      supporting_documents_json:
        type: jsonb
        description: |
          Supporting documentation:
          {
            "documents": [
              {"type": "BIRTH_CERTIFICATE", "url": "..."},
              {"type": "MARRIAGE_CERTIFICATE", "url": "..."}
            ]
          }
      status:
        type: enum
        default: PENDING
        values: [PENDING, APPROVED, REJECTED, PROCESSED]
      approved_by:
        type: UUID
        description: "FK to Core.Employee (approver)"
      approved_date:
        type: timestamp
      processed_date:
        type: date
        description: "When adjustment was processed in payroll/tax"
      metadata:
        type: jsonb
      created_date:
        type: timestamp
        default: now()
      created_by:
        type: UUID
        required: true
    relationships:
      employee:
        target: Core.Employee
        cardinality: "N:1"
      declaration:
        target: TaxDeclaration
        cardinality: "N:1"
      approver:
        target: Core.Employee
        cardinality: "N:1"
    businessRules:
      - "DEPENDENT_CHANGE affects future withholding"
      - "INCOME_CORRECTION may trigger amended return"
      - "REFUND/ADDITIONAL_PAYMENT processed via payroll"
      - "Approval required before processing"
    indexes:
      - name: "idx_tax_adjustment_employee"
        columns: [employee_id, tax_year]
      - name: "idx_tax_adjustment_declaration"
        columns: [declaration_id]
      - name: "idx_tax_adjustment_type"
        columns: [adjustment_type]
      - name: "idx_tax_adjustment_status"
        columns: [status]

  # ===========================================================================
  # AUDIT SCHEMA
  # ===========================================================================

  AuditLog:
    description: |
      Comprehensive audit trail for all Total Rewards modules.
      Captures all changes with before/after values for compliance.
    attributes:
      id:
        type: UUID
        required: true
      event_type:
        type: string
        required: true
        maxLength: 50
        description: "Event type (COMP_CHANGED, BONUS_APPROVED, EQUITY_VESTED, etc.)"
      entity_type:
        type: string
        required: true
        maxLength: 50
        description: "Table name (e.g., CompensationAdjustment, EquityGrant)"
      entity_id:
        type: UUID
        required: true
        description: "Record ID"
      action:
        type: enum
        required: true
        values: [CREATE, UPDATE, DELETE, APPROVE, REJECT, VIEW, EXPORT]
        description: "Action performed"
      user_id:
        type: UUID
        required: true
        description: "Who performed action (FK to Core.Employee or Core.User)"
      user_role:
        type: string
        maxLength: 50
        description: "User's role at time of action"
      ip_address:
        type: string
        maxLength: 50
        description: "IP address of user"
      user_agent:
        type: text
        description: "Browser/client user agent"
      request_id:
        type: UUID
        description: "Request correlation ID"
      old_values:
        type: jsonb
        description: "Previous state (for UPDATE/DELETE)"
      new_values:
        type: jsonb
        description: "New state (for CREATE/UPDATE)"
      change_summary:
        type: text
        description: "Human-readable change description"
      reason:
        type: text
        description: "Why change was made"
      timestamp:
        type: timestamp
        default: now()
        required: true
    businessRules:
      - "Immutable - records cannot be modified or deleted"
      - "Partitioned by month for performance"
      - "Retained per compliance requirements (typically 7 years)"
      - "Sensitive data (SSN, salary) access logged"
    indexes:
      - name: "idx_audit_log_entity"
        columns: [entity_type, entity_id]
      - name: "idx_audit_log_user"
        columns: [user_id, timestamp]
      - name: "idx_audit_log_timestamp"
        columns: [timestamp]
      - name: "idx_audit_log_event_type"
        columns: [event_type]
      - name: "idx_audit_log_action"
        columns: [action]
    partitioning:
      strategy: "RANGE"
      column: "timestamp"
      interval: "MONTHLY"
      retention: "84 MONTHS"  # 7 years

# =============================================================================
# DESIGN PATTERNS & BEST PRACTICES
# =============================================================================

design_patterns:
  temporal_data:
    description: "SCD Type 2 for versioned entities"
    entities:
      - GradeVersion
      - CalculationRuleDefinition
      - OfferTemplate
    pattern: |
      - version_number: incremental version
      - previous_version_id: chain to previous version
      - is_current_version: flag for current version
      - effective_start_date / effective_end_date: validity period

  audit_trail:
    description: "Complete audit trail for compliance"
    fields:
      - created_date
      - created_by
      - updated_date
      - updated_by
    entities: "All entities have audit fields"

  soft_delete:
    description: "Soft delete with is_active flag"
    pattern: |
      - is_active: boolean flag
      - Filtered queries use WHERE is_active = true
      - Partial indexes for performance

  multi_currency:
    description: "Multi-currency support"
    pattern: |
      - currency: char(3) ISO 4217
      - amounts: decimal(18,4) for precision
      - stock prices: decimal(18,6) for higher precision

  workflow_state:
    description: "Workflow state management"
    pattern: |
      - status: enum for current state
      - workflow_state: jsonb for state history
      - approval fields: approver_id, decision_date, decision_note

  calculation_engine:
    description: "Rule-based calculation engine"
    components:
      - CalculationRuleDefinition: global rules
      - ComponentCalculationRule: component-specific rules
      - BasisCalculationRule: basis-level rules
      - execution_order: determines calculation sequence

# =============================================================================
# ONTOLOGY METADATA
# =============================================================================

ontology_metadata:
  version: "2.0"
  last_updated: "2025-12-03"
  total_entities: 70
  total_relationships: 150+
  design_review_status: "All gaps addressed"
  production_readiness: "100%"
  
  modules_summary:
    CoreCompensation:
      entities: 16
      status: "Complete"
      highlights:
        - "SCD Type 2 for grades"
        - "Multi-scope pay ranges"
        - "Component dependencies"
        - "Structured proration rules"
        - "Salary history tracking"
    
    CalculationRules:
      entities: 6
      status: "Complete"
      highlights:
        - "Multi-country support"
        - "SCD Type 2 versioning"
        - "Tax/SI/OT rules"
        - "Performance caching"
        - "Holiday calendar"
    
    VariablePay:
      entities: 10
      status: "Complete"
      highlights:
        - "Bonus plans and cycles"
        - "Equity lifecycle"
        - "Commission tiers"
        - "Vesting schedules"
        - "Tax integration"
    
    Benefits:
      entities: 13
      status: "Complete"
      highlights:
        - "Enrollment periods"
        - "Life events"
        - "Dependent management"
        - "Beneficiary designation"
        - "Healthcare claims"
    
    Recognition:
      entities: 7
      status: "Complete"
      highlights:
        - "Point expiration"
        - "Perk catalog"
        - "Redemption workflow"
        - "Recognition events"
        - "FIFO expiration"
    
    OfferManagement:
      entities: 5
      status: "Complete"
      highlights:
        - "Template versioning"
        - "Total value calculation"
        - "Approval workflow"
        - "E-signature support"
        - "Counter-offer tracking"
    
    TaxableBridge:
      entities: 1
      status: "Complete"
      highlights:
        - "Payroll integration"
        - "Multi-source taxable items"
        - "Tax year tracking"
    
    TotalRewardsStatement:
      entities: 4
      status: "Complete"
      highlights:
        - "Configurable layouts"
        - "Batch generation"
        - "PDF output"
        - "Auto-distribution"
    
    Deductions:
      entities: 4
      status: "Complete"
      highlights:
        - "Priority-based deductions"
        - "Court-ordered garnishments"
        - "Installment schedules"
        - "Insufficient funds handling"
    
    TaxWithholding:
      entities: 3
      status: "Complete"
      highlights:
        - "Monthly withholding"
        - "Annual declarations"
        - "Tax adjustments"
        - "Refund/payment tracking"
    
    Audit:
      entities: 1
      status: "Complete"
      highlights:
        - "Immutable audit log"
        - "Before/after values"
        - "Monthly partitioning"
        - "7-year retention"

# END OF ONTOLOGY
