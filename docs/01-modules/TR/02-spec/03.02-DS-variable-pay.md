# Data Specification - Variable Pay

**Version**: 1.0  
**Last Updated**: 2025-12-16  
**Module**: Total Rewards (TR) - Variable Pay  
**Status**: Draft

---

## Document Information

- **Purpose**: Define data validation rules and constraints for Variable Pay entities
- **Audience**: Backend Developers, Database Administrators, QA Engineers
- **Scope**: Bonus plans, equity grants, commissions, and variable compensation
- **Related Documents**:
  - [TR Ontology](../../00-ontology/tr-ontology.yaml) - Entity definitions
  - [API Specification](./02-api-specification.md) - API contracts
  - [Business Rules](./04-business-rules.md) - Business logic

---

## Table of Contents

1. [Bonus Entities](#bonus-entities)
2. [Equity Entities](#equity-entities)
3. [Commission Entities](#commission-entities)
4. [Common Validation Patterns](#common-validation-patterns)
5. [Enumeration Definitions](#enumeration-definitions)

---

# Bonus Entities

## BonusPlan

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `code` | String | Yes | Unique, max 50 chars, pattern: `^[A-Z0-9_]+$` | Unique code |
| `name` | String | Yes | Max 200 chars | Display name |
| `description` | String | No | Max 500 chars | Optional description |
| `planType` | Enum | Yes | See BonusPlanType | STI, LTI, SPOT_BONUS, RETENTION |
| `targetType` | Enum | Yes | See TargetType | PERCENTAGE, FIXED_AMOUNT, MULTIPLIER |
| `targetValue` | Decimal | Yes | > 0 | Target value |
| `performanceMetrics` | Array | No | Max 10 metrics | Performance metrics |
| `payoutFrequency` | Enum | Yes | See PayoutFrequency | Payout frequency |
| `currency` | String | Yes | ISO 4217 | Currency code |
| `isActive` | Boolean | Yes | - | Default: true |
| `effectiveDate` | Date | Yes | >= today (unless retroactive) | Start date |
| `endDate` | Date | No | > effectiveDate | End date |
| `createdBy` | UUID | Yes | Must exist in User | Creator |
| `createdAt` | Timestamp | Yes | - | System-generated |
| `updatedAt` | Timestamp | Yes | >= createdAt | System-generated |

### Cross-Field Rules

**Rule 1: Target Value Validation**
- If `targetType` = PERCENTAGE, then `targetValue` should be 0-100
- If `targetType` = FIXED_AMOUNT, then `targetValue` > 0
- If `targetType` = MULTIPLIER, then `targetValue` typically 0-5

**Rule 2: Plan Type Alignment**
- If `planType` = STI, then `payoutFrequency` typically ANNUAL
- If `planType` = LTI, then `payoutFrequency` typically ANNUAL or longer
- If `planType` = SPOT_BONUS, then `payoutFrequency` typically MONTHLY or QUARTERLY

**Rule 3: Performance Metrics**
- If `performanceMetrics` is set, must include at least one metric
- Valid metrics: COMPANY_PERFORMANCE, INDIVIDUAL_PERFORMANCE, TEAM_PERFORMANCE, SALES_TARGET

### Business Validations

**Budget Availability**
- Plan must have budget allocated before activation
- Track budget consumption across all cycles

**Eligibility Rules**
- Define which employees are eligible for the plan
- Check eligibility criteria before enrollment

---

## BonusCycle

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `bonusPlanId` | UUID | Yes | Must exist in BonusPlan | Bonus plan |
| `cycleYear` | Integer | Yes | >= 2000, <= 2100 | Cycle year |
| `cycleName` | String | Yes | Max 200 chars | Cycle name |
| `startDate` | Date | Yes | - | Cycle start |
| `endDate` | Date | Yes | > startDate | Cycle end |
| `performancePeriodStart` | Date | Yes | - | Performance period start |
| `performancePeriodEnd` | Date | Yes | > performancePeriodStart | Performance period end |
| `payoutDate` | Date | No | >= endDate | Payout date |
| `status` | Enum | Yes | See CycleStatus | Cycle status |
| `totalBudget` | Decimal | No | >= 0 | Total budget |
| `allocatedAmount` | Decimal | Yes | >= 0, <= totalBudget | Allocated amount |
| `paidAmount` | Decimal | Yes | >= 0, <= allocatedAmount | Paid amount |
| `currency` | String | Yes | ISO 4217 | Currency code |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Date Consistency**
- `endDate` > `startDate`
- `performancePeriodEnd` > `performancePeriodStart`
- Performance period typically aligns with cycle dates

**Rule 2: Budget Tracking**
- `allocatedAmount` <= `totalBudget` (if budget set)
- `paidAmount` <= `allocatedAmount`
- Track in real-time

**Rule 3: Status Transitions**
- Valid transitions:
  - DRAFT → ACTIVE (start cycle)
  - ACTIVE → CALCULATION (calculate bonuses)
  - CALCULATION → APPROVED (approve bonuses)
  - APPROVED → PAID (pay bonuses)
  - ACTIVE → CANCELLED (cancel cycle)

**Rule 4: Payout Date**
- `payoutDate` must be >= `endDate`
- Typically set when status = APPROVED

---

## BonusPool

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `bonusCycleId` | UUID | Yes | Must exist in BonusCycle | Bonus cycle |
| `poolName` | String | Yes | Max 200 chars | Pool name |
| `poolType` | Enum | Yes | DEPARTMENT, TEAM, INDIVIDUAL | Pool type |
| `organizationUnitId` | UUID | Conditional | Must exist if poolType != INDIVIDUAL | Org unit |
| `budgetAmount` | Decimal | Yes | > 0 | Pool budget |
| `allocatedAmount` | Decimal | Yes | >= 0, <= budgetAmount | Allocated amount |
| `currency` | String | Yes | ISO 4217 | Currency code |
| `isActive` | Boolean | Yes | - | Default: true |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Pool Type Requirements**
- If `poolType` = DEPARTMENT or TEAM, then `organizationUnitId` is required
- If `poolType` = INDIVIDUAL, then `organizationUnitId` must be null

**Rule 2: Budget Allocation**
- Sum of all pool budgets should not exceed cycle's totalBudget
- `allocatedAmount` <= `budgetAmount`

**Rule 3: Currency Consistency**
- `currency` must match cycle's currency

---

## BonusAllocation

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `bonusPoolId` | UUID | Yes | Must exist in BonusPool | Bonus pool |
| `employeeId` | UUID | Yes | Must exist in Worker | Employee |
| `targetAmount` | Decimal | Yes | >= 0 | Target bonus |
| `actualAmount` | Decimal | Yes | >= 0 | Actual bonus |
| `performanceRating` | Decimal | No | 0-5 | Performance rating |
| `performanceMultiplier` | Decimal | No | >= 0 | Performance multiplier |
| `prorationFactor` | Decimal | Yes | 0-1 | Proration factor |
| `adjustmentAmount` | Decimal | Yes | Can be negative | Manual adjustment |
| `finalAmount` | Decimal | Yes | >= 0 | Final bonus amount |
| `currency` | String | Yes | ISO 4217 | Currency code |
| `status` | Enum | Yes | See AllocationStatus | Allocation status |
| `approvedBy` | UUID | No | Must exist if approved | Approver |
| `approvedAt` | Timestamp | No | - | Approval timestamp |
| `paidAt` | Timestamp | No | - | Payment timestamp |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Amount Calculation**
```
actualAmount = targetAmount * performanceMultiplier * prorationFactor
finalAmount = actualAmount + adjustmentAmount
```

**Rule 2: Performance Multiplier**
- If `performanceRating` is set, calculate multiplier based on rating
- Typical range: 0.5 - 2.0 (50% to 200% of target)

**Rule 3: Proration Factor**
- `prorationFactor` = 1.0 for full year
- < 1.0 for partial year (e.g., new hires, terminations)
- Calculated based on employment period

**Rule 4: Status Transitions**
- DRAFT → PENDING → APPROVED → PAID
- If `status` = APPROVED, then approvedBy and approvedAt are required
- If `status` = PAID, then paidAt is required

### Business Validations

**Budget Check**
- Sum of all finalAmounts in pool should not exceed pool's budgetAmount
- Warn if over budget

**Eligibility Check**
- Employee must be eligible for the bonus plan
- Check employment status and tenure

**Proration Rules**
- Calculate proration based on employment period
- Consider hire date, termination date, leaves of absence

---

# Equity Entities

## EquityGrant

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `employeeId` | UUID | Yes | Must exist in Worker | Employee |
| `grantType` | Enum | Yes | See GrantType | RSU, STOCK_OPTION, ESPP |
| `quantity` | Integer | Yes | > 0 | Number of shares/units |
| `grantDate` | Date | Yes | <= today | Grant date |
| `vestingScheduleId` | UUID | Yes | Must exist in VestingSchedule | Vesting schedule |
| `strikePrice` | Decimal | Conditional | > 0 | Required if STOCK_OPTION |
| `fairMarketValue` | Decimal | Yes | > 0 | FMV at grant date |
| `currency` | String | Yes | ISO 4217 | Currency code |
| `totalValue` | Decimal | Yes | > 0 | Total grant value |
| `vestedQuantity` | Integer | Yes | >= 0, <= quantity | Vested quantity |
| `unvestedQuantity` | Integer | Yes | >= 0, <= quantity | Unvested quantity |
| `forfeitedQuantity` | Integer | Yes | >= 0 | Forfeited quantity |
| `status` | Enum | Yes | See GrantStatus | Grant status |
| `reason` | String | No | Max 500 chars | Grant reason |
| `createdBy` | UUID | Yes | Must exist in User | Creator |
| `createdAt` | Timestamp | Yes | - | System-generated |
| `updatedAt` | Timestamp | Yes | >= createdAt | System-generated |

### Cross-Field Rules

**Rule 1: Quantity Tracking**
```
quantity = vestedQuantity + unvestedQuantity + forfeitedQuantity
```

**Rule 2: Grant Type Requirements**
- If `grantType` = STOCK_OPTION, then `strikePrice` is required
- If `grantType` = RSU or ESPP, then `strikePrice` must be null

**Rule 3: Value Calculation**
- For RSU: `totalValue` = quantity * fairMarketValue
- For STOCK_OPTION: `totalValue` = quantity * (fairMarketValue - strikePrice)
- For ESPP: `totalValue` = quantity * fairMarketValue * discount

**Rule 4: Status Lifecycle**
- ACTIVE: Grant is active, vesting in progress
- VESTED: All shares vested
- FORFEITED: Grant forfeited (termination, etc.)
- CANCELLED: Grant cancelled

### Business Validations

**Vesting Schedule Validation**
- Vesting schedule must be active
- Total vesting events should match grant quantity

**Grant Date Validation**
- Grant date cannot be in future
- Grant date should align with board approval date

**FMV Validation**
- Fair market value should match stock price on grant date
- Validate against external pricing source

---

## EquityVestingEvent

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `equityGrantId` | UUID | Yes | Must exist in EquityGrant | Equity grant |
| `vestDate` | Date | Yes | - | Vesting date |
| `quantity` | Integer | Yes | > 0 | Vesting quantity |
| `fairMarketValue` | Decimal | Yes | > 0 | FMV at vest date |
| `totalValue` | Decimal | Yes | > 0 | Total vesting value |
| `taxableAmount` | Decimal | Yes | >= 0 | Taxable amount |
| `status` | Enum | Yes | See VestingStatus | Vesting status |
| `processedAt` | Timestamp | No | - | Processing timestamp |
| `taxableItemId` | UUID | No | Must exist if processed | Taxable item reference |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Value Calculation**
```
totalValue = quantity * fairMarketValue
taxableAmount = totalValue (for RSU)
taxableAmount = (fairMarketValue - strikePrice) * quantity (for STOCK_OPTION)
```

**Rule 2: Vest Date Validation**
- `vestDate` must be >= grant's grantDate
- `vestDate` should align with vesting schedule

**Rule 3: Status Transitions**
- PENDING → VESTED (on vest date)
- VESTED → PROCESSED (after tax withholding)
- PENDING → FORFEITED (if employee leaves before vesting)

**Rule 4: Taxable Item Creation**
- When status = PROCESSED, create taxable item
- `taxableItemId` should reference created item

### Business Validations

**Vesting Date Check**
- Process vesting only on or after vest date
- Cannot vest in advance

**Tax Withholding**
- Calculate tax withholding based on taxable amount
- Create taxable item for payroll processing

**Grant Quantity Update**
- Update grant's vestedQuantity and unvestedQuantity
- Ensure quantities remain consistent

---

## EquityTransaction

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `equityGrantId` | UUID | Yes | Must exist in EquityGrant | Equity grant |
| `transactionType` | Enum | Yes | See TransactionType | Transaction type |
| `transactionDate` | Date | Yes | - | Transaction date |
| `quantity` | Integer | Yes | != 0 | Quantity (positive or negative) |
| `pricePerShare` | Decimal | Conditional | > 0 | Price per share |
| `totalAmount` | Decimal | Conditional | Can be negative | Total amount |
| `currency` | String | Yes | ISO 4217 | Currency code |
| `reason` | String | No | Max 500 chars | Transaction reason |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Transaction Type Rules**
- VEST: quantity > 0, updates vestedQuantity
- EXERCISE: quantity > 0 (for stock options)
- SELL: quantity < 0
- FORFEIT: quantity < 0, updates forfeitedQuantity

**Rule 2: Amount Calculation**
- If `pricePerShare` is set, then `totalAmount` = quantity * pricePerShare
- For VEST: pricePerShare = fairMarketValue at vest date

**Rule 3: Quantity Validation**
- For SELL or EXERCISE: abs(quantity) <= grant's vestedQuantity
- Cannot sell more than vested

---

# Commission Entities

## CommissionPlan

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `code` | String | Yes | Unique, max 50 chars | Unique code |
| `name` | String | Yes | Max 200 chars | Display name |
| `description` | String | No | Max 500 chars | Optional description |
| `commissionType` | Enum | Yes | See CommissionType | FLAT, TIERED, MATRIX |
| `baseRate` | Decimal | Conditional | 0-100 | Base commission rate % |
| `tiers` | JSON | Conditional | - | Tiered rates (if TIERED) |
| `matrix` | JSON | Conditional | - | Commission matrix (if MATRIX) |
| `payoutFrequency` | Enum | Yes | See PayoutFrequency | Payout frequency |
| `currency` | String | Yes | ISO 4217 | Currency code |
| `isActive` | Boolean | Yes | - | Default: true |
| `effectiveDate` | Date | Yes | >= today (unless retroactive) | Start date |
| `endDate` | Date | No | > effectiveDate | End date |
| `createdBy` | UUID | Yes | Must exist in User | Creator |
| `createdAt` | Timestamp | Yes | - | System-generated |
| `updatedAt` | Timestamp | Yes | >= createdAt | System-generated |

### Cross-Field Rules

**Rule 1: Commission Type Requirements**
- If `commissionType` = FLAT, then `baseRate` is required, tiers and matrix must be null
- If `commissionType` = TIERED, then `tiers` is required, must have at least 2 tiers
- If `commissionType` = MATRIX, then `matrix` is required

**Rule 2: Tier Validation**
- Tiers must not overlap
- Each tier: {minAmount, maxAmount, rate}
- Rates must be 0-100

**Rule 3: Matrix Validation**
- Matrix dimensions: product x achievement level
- Each cell contains commission rate

### Business Validations

**Rate Reasonableness**
- Commission rates typically 1-20%
- Warn if rates are unusually high

**Tier Coverage**
- Tiers should cover full sales range
- No gaps between tiers

---

## CommissionTransaction

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `commissionPlanId` | UUID | Yes | Must exist in CommissionPlan | Commission plan |
| `employeeId` | UUID | Yes | Must exist in Worker | Employee |
| `transactionDate` | Date | Yes | - | Transaction date |
| `salesAmount` | Decimal | Yes | >= 0 | Sales amount |
| `commissionRate` | Decimal | Yes | 0-100 | Applied rate % |
| `commissionAmount` | Decimal | Yes | >= 0 | Commission earned |
| `currency` | String | Yes | ISO 4217 | Currency code |
| `period` | String | Yes | Format: YYYY-MM | Commission period |
| `status` | Enum | Yes | See CommissionStatus | Status |
| `paidAt` | Timestamp | No | - | Payment timestamp |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Commission Calculation**
```
commissionAmount = salesAmount * (commissionRate / 100)
```
- For TIERED: Calculate based on tier brackets
- For MATRIX: Lookup rate from matrix

**Rule 2: Period Format**
- `period` must be valid YYYY-MM format
- Must match transaction date's month

**Rule 3: Status Transitions**
- PENDING → APPROVED → PAID
- If `status` = PAID, then `paidAt` is required

### Business Validations

**Sales Amount Validation**
- Sales amount should be positive
- Validate against sales records

**Rate Application**
- Verify correct rate applied based on plan type
- Recalculate if plan changes

---

# Common Validation Patterns

## Date Validations

**Past Date Check**
```
date >= today (unless retroactive allowed)
```

**Date Range Check**
```
endDate > startDate
```

**Vesting Date Alignment**
```
vestDate must align with vesting schedule
```

## Decimal Precision

All decimal fields (amounts, rates, multipliers):
- Precision: 2 decimal places
- Rounding: HALF_UP
- Example: 15000.00, 1.50, 0.75

## Percentage Validations

Commission rates, performance multipliers:
- Range: 0-100 (or 0-500 for multipliers)
- Precision: 2 decimal places
- Example: 15.50, 125.00

## Quantity Validations

Equity quantities:
- Must be positive integers
- No fractional shares
- Example: 1000, 500, 250

---

# Enumeration Definitions

## BonusPlanType

```
STI             - Short-term incentive
LTI             - Long-term incentive
SPOT_BONUS      - Spot bonus/recognition
RETENTION       - Retention bonus
```

## TargetType

```
PERCENTAGE      - Percentage of base salary
FIXED_AMOUNT    - Fixed amount
MULTIPLIER      - Multiplier of base salary
```

## PayoutFrequency

```
MONTHLY         - Monthly payout
QUARTERLY       - Quarterly payout
SEMI_ANNUAL     - Semi-annual payout
ANNUAL          - Annual payout
```

## CycleStatus

```
DRAFT           - Draft cycle
ACTIVE          - Active cycle
CALCULATION     - Calculating bonuses
APPROVED        - Bonuses approved
PAID            - Bonuses paid
CANCELLED       - Cycle cancelled
```

## AllocationStatus

```
DRAFT           - Draft allocation
PENDING         - Pending approval
APPROVED        - Approved
PAID            - Paid
CANCELLED       - Cancelled
```

## GrantType

```
RSU             - Restricted Stock Units
STOCK_OPTION    - Stock Options
ESPP            - Employee Stock Purchase Plan
```

## GrantStatus

```
ACTIVE          - Active grant
VESTED          - Fully vested
FORFEITED       - Forfeited
CANCELLED       - Cancelled
```

## VestingStatus

```
PENDING         - Pending vesting
VESTED          - Vested
PROCESSED       - Processed (tax withheld)
FORFEITED       - Forfeited
```

## TransactionType

```
VEST            - Vesting event
EXERCISE        - Exercise option
SELL            - Sell shares
FORFEIT         - Forfeit shares
```

## CommissionType

```
FLAT            - Flat rate
TIERED          - Tiered rates
MATRIX          - Matrix-based rates
```

## CommissionStatus

```
PENDING         - Pending calculation
APPROVED        - Approved
PAID            - Paid
CANCELLED       - Cancelled
```

---

## Document Status

**Status**: Complete - All Variable Pay entities documented  
**Coverage**:
- ✅ Bonus Entities (4 entities)
- ✅ Equity Entities (3 entities)
- ✅ Commission Entities (2 entities)

**Total Entities**: 9 entities with complete validation rules  
**Total Lines**: ~500 lines

**Last Updated**: 2025-12-16  
**Next**: 03.03-DS-benefits.md
