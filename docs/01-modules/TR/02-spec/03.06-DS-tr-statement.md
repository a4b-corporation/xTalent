# Data Specification - TR Statement

**Version**: 1.0  
**Last Updated**: 2025-12-16  
**Module**: Total Rewards (TR) - TR Statement  
**Status**: Draft

---

## Document Information

- **Purpose**: Define data validation rules and constraints for TR Statement entities
- **Audience**: Backend Developers, Database Administrators, QA Engineers
- **Scope**: Statement templates, generation, sections, and employee access
- **Related Documents**:
  - [TR Ontology](../../00-ontology/tr-ontology.yaml) - Entity definitions
  - [API Specification](./02-api-specification.md) - API contracts
  - [Business Rules](./04-business-rules.md) - Business logic

---

## Table of Contents

1. [Statement Template Entities](#statement-template-entities)
2. [Statement Generation Entities](#statement-generation-entities)
3. [Statement Access Entities](#statement-access-entities)
4. [Common Validation Patterns](#common-validation-patterns)
5. [Enumeration Definitions](#enumeration-definitions)

---

# Statement Template Entities

## StatementTemplate

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `code` | String | Yes | Unique, max 50 chars, pattern: `^[A-Z0-9_]+$` | Unique code |
| `name` | String | Yes | Max 200 chars | Template name |
| `description` | String | No | Max 500 chars | Optional description |
| `country` | String | Yes | ISO 3166-1 alpha-2 | Country code |
| `currency` | String | Yes | ISO 4217 | Currency code |
| `templateType` | Enum | Yes | See TemplateType | Template type |
| `layout` | JSON | Yes | - | Template layout configuration |
| `sections` | Array | Yes | - | Statement sections |
| `isActive` | Boolean | Yes | - | Default: true |
| `createdBy` | UUID | Yes | Must exist in User | Creator |
| `createdAt` | Timestamp | Yes | - | System-generated |
| `updatedAt` | Timestamp | Yes | >= createdAt | System-generated |

### Cross-Field Rules

**Rule 1: Country-Currency Alignment**
- If `country` = VN, then `currency` should be VND
- If `country` = US, then `currency` should be USD
- If `country` = SG, then `currency` should be SGD

**Rule 2: Sections Requirement**
- `sections` array must have at least 1 section
- Common sections: Compensation, Benefits, Equity, Perks, Tax

**Rule 3: Layout Configuration**
- `layout` JSON defines visual structure
- Includes branding, colors, fonts, logo

### Business Validations

**Template Completeness**
- Template should include all relevant TR components
- Validate section configurations

---

## StatementSection

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `templateId` | UUID | Yes | Must exist in StatementTemplate | Template |
| `sectionCode` | String | Yes | Max 50 chars | Section code |
| `sectionName` | String | Yes | Max 200 chars | Section name |
| `sectionType` | Enum | Yes | See SectionType | Section type |
| `displayOrder` | Integer | Yes | >= 1 | Display order |
| `dataSource` | String | Yes | Max 200 chars | Data source query/reference |
| `formatting` | JSON | No | - | Section formatting rules |
| `isRequired` | Boolean | Yes | - | Default: true |
| `isActive` | Boolean | Yes | - | Default: true |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Display Order**
- `displayOrder` should be unique within same template
- Determines section sequence in statement

**Rule 2: Section Type Rules**
- COMPENSATION: Shows salary, bonuses, commissions
- BENEFITS: Shows benefit plans and values
- EQUITY: Shows equity grants and vesting
- PERKS: Shows recognition points and perks
- TAX: Shows tax withholding summary
- SUMMARY: Shows total rewards summary

**Rule 3: Data Source Validation**
- `dataSource` must reference valid data query or entity
- Validate data source returns expected structure

---

# Statement Generation Entities

## StatementGeneration

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `templateId` | UUID | Yes | Must exist in StatementTemplate | Template |
| `statementYear` | Integer | Yes | >= 2000, <= 2100 | Statement year |
| `generationType` | Enum | Yes | See GenerationType | Generation type |
| `employeeIds` | Array | Conditional | - | Required if INDIVIDUAL/BATCH |
| `status` | Enum | Yes | See GenerationStatus | Generation status |
| `totalEmployees` | Integer | Yes | >= 0 | Total employees |
| `successCount` | Integer | Yes | >= 0, <= totalEmployees | Success count |
| `failureCount` | Integer | Yes | >= 0, <= totalEmployees | Failure count |
| `errorLog` | String | No | - | Error log |
| `startedAt` | Timestamp | Yes | - | Start timestamp |
| `completedAt` | Timestamp | No | - | Completion timestamp |
| `createdBy` | UUID | Yes | Must exist in User | Creator |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Employee IDs Requirement**
- If `generationType` = INDIVIDUAL or BATCH, then `employeeIds` is required
- If `generationType` = ALL_EMPLOYEES, then `employeeIds` must be null

**Rule 2: Count Validation**
```
totalEmployees = successCount + failureCount
```

**Rule 3: Status Transitions**
- PENDING → PROCESSING → COMPLETED/FAILED
- If `status` = COMPLETED or FAILED, then `completedAt` is required

**Rule 4: Error Logging**
- If `failureCount` > 0, then `errorLog` should be populated
- Track which employees failed and why

### Business Validations

**Data Availability**
- Verify all required data is available for statement year
- Check compensation, benefits, equity data completeness

**Generation Performance**
- Track generation time
- Alert if generation takes too long

---

# Statement Access Entities

## StatementAccess

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `employeeId` | UUID | Yes | Must exist in Worker | Employee |
| `statementYear` | Integer | Yes | >= 2000, <= 2100 | Statement year |
| `statementFile` | String | Yes | File path or URL | Statement file location |
| `fileFormat` | Enum | Yes | PDF, HTML | File format |
| `fileSize` | Integer | Yes | > 0 | File size in bytes |
| `generatedAt` | Timestamp | Yes | - | Generation timestamp |
| `viewedAt` | Timestamp | No | - | First view timestamp |
| `downloadedAt` | Timestamp | No | - | First download timestamp |
| `viewCount` | Integer | Yes | >= 0 | View count |
| `downloadCount` | Integer | Yes | >= 0 | Download count |
| `isActive` | Boolean | Yes | - | Default: true |
| `expiresAt` | Timestamp | No | - | Expiration timestamp |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Uniqueness**
- Composite unique key: (employeeId, statementYear)
- One statement per employee per year

**Rule 2: Access Tracking**
- `viewedAt` set on first view
- `downloadedAt` set on first download
- Increment counts on each access

**Rule 3: File Format**
- PDF: For download and print
- HTML: For online viewing

**Rule 4: Expiration**
- If `expiresAt` is set, statement becomes unavailable after expiration
- Typically no expiration for TR statements

### Business Validations

**File Storage**
- Verify file exists at specified location
- Ensure file is accessible

**Access Control**
- Employee can only access own statements
- HR/Admin can access all statements

**Retention Policy**
- Retain statements for required period (typically 7 years)
- Archive old statements

---

# Common Validation Patterns

## Date Validations

**Year Validation**
```
statementYear >= 2000 and <= 2100
```

**Timestamp Sequence**
```
completedAt >= startedAt
viewedAt >= generatedAt
```

## File Validations

**File Path**
- Must be valid file system path or URL
- File must exist and be readable

**File Size**
- Typical PDF size: 100KB - 5MB
- Alert if unusually large

## Count Validations

```
totalEmployees = successCount + failureCount
viewCount >= 0
downloadCount >= 0
```

---

# Enumeration Definitions

## TemplateType

```
ANNUAL          - Annual TR statement
QUARTERLY       - Quarterly statement
ON_DEMAND       - On-demand statement
```

## SectionType

```
COMPENSATION    - Compensation section
BENEFITS        - Benefits section
EQUITY          - Equity section
PERKS           - Perks and recognition section
TAX             - Tax withholding section
SUMMARY         - Total rewards summary
```

## GenerationType

```
INDIVIDUAL      - Single employee
BATCH           - Selected employees
ALL_EMPLOYEES   - All active employees
```

## GenerationStatus

```
PENDING         - Pending generation
PROCESSING      - Generating statements
COMPLETED       - Generation completed
FAILED          - Generation failed
```

## FileFormat

```
PDF             - PDF format
HTML            - HTML format
```

---

## Document Status

**Status**: Complete - All TR Statement entities documented  
**Coverage**:
- ✅ Statement Template Entities (2 entities)
- ✅ Statement Generation Entities (1 entity)
- ✅ Statement Access Entities (1 entity)

**Total Entities**: 4 entities with complete validation rules  
**Total Lines**: ~200 lines

**Last Updated**: 2025-12-16  
**Next**: 03.07-DS-deductions.md (Phase 3)
