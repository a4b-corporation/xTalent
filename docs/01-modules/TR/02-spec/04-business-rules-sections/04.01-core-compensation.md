# 1. Core Compensation Rules

## Category: Salary Basis Management

### BR-TR-COMP-001: Salary Basis Code Uniqueness

**Priority**: HIGH

**Description**:
Each salary basis must have a unique code within the system to prevent conflicts and ensure data integrity.

**Conditions**:
```
IF creating new SalaryBasis
AND code already exists
THEN reject with error
```

**Rules**:
1. Salary basis code must be unique across all legal entities
2. Code format: uppercase alphanumeric with underscores
3. Maximum length: 50 characters
4. Cannot be changed once created (immutable)

**Exceptions**:
- None

**Error Messages**:
- `ERR_COMP_001`: "Salary basis code '{code}' already exists. Please use a unique code."

**Examples**:
```yaml
Example 1: Valid creation
  Input:
    code: "MONTHLY_VN"
    name: "Monthly Salary - Vietnam"
  
  Validation:
    BR-TR-COMP-001: PASS
  
  Output:
    SalaryBasis created successfully

Example 2: Duplicate code
  Input:
    code: "MONTHLY_VN"  # Already exists
  
  Validation:
    BR-TR-COMP-001: FAIL
  
  Output:
    Error: ERR_COMP_001
```

**Related Requirements**:
- FR-TR-COMP-001

**Related Entities**:
- SalaryBasis

---

### BR-TR-COMP-002: Salary Basis Frequency Validation

**Priority**: HIGH

**Description**:
Salary basis frequency must be one of the predefined valid values to ensure consistent payroll processing.

**Conditions**:
```
IF creating/updating SalaryBasis
THEN frequency must be in allowed list
```

**Rules**:
1. Allowed frequencies: MONTHLY, SEMI_MONTHLY, WEEKLY, BI_WEEKLY, DAILY, HOURLY
2. Frequency determines pay period calculation
3. Cannot change frequency if employees are assigned (data migration required)

**Exceptions**:
- Custom frequencies require system configuration approval

**Error Messages**:
- `ERR_COMP_002`: "Invalid frequency '{frequency}'. Must be one of: MONTHLY, SEMI_MONTHLY, WEEKLY, BI_WEEKLY, DAILY, HOURLY."

**Related Requirements**:
- FR-TR-COMP-001

**Related Entities**:
- SalaryBasis

---

### BR-TR-COMP-003: Salary Basis Currency Validation

**Priority**: HIGH

**Description**:
Salary basis currency must match the legal entity's operating currency or be an approved multi-currency.

**Conditions**:
```
IF creating SalaryBasis
THEN currency must be valid for legal entity
```

**Rules**:
1. Currency must exist in Core.Currency master data
2. Must be active currency
3. Preferably matches legal entity default currency
4. Multi-currency requires approval

**Exceptions**:
- Expatriate packages may use different currency

**Error Messages**:
- `ERR_COMP_003`: "Currency '{currency}' is not valid for legal entity '{entity}'."

**Related Requirements**:
- FR-TR-COMP-001

**Related Entities**:
- SalaryBasis
- Core.Currency
- Core.LegalEntity

---

## Category: Pay Component Definition

### BR-TR-COMP-004: Component Code Uniqueness

**Priority**: HIGH

**Description**:
Pay component codes must be unique within a legal entity to prevent confusion and calculation errors.

**Conditions**:
```
IF creating PayComponentDefinition
AND code exists in same legal entity
THEN reject
```

**Rules**:
1. Code unique per legal entity
2. Same code can exist across different legal entities
3. Code format: uppercase with underscores
4. Maximum 50 characters

**Exceptions**:
- Global components (shared across entities) must be globally unique

**Error Messages**:
- `ERR_COMP_004`: "Component code '{code}' already exists in legal entity '{entity}'."

**Related Requirements**:
- FR-TR-COMP-002

**Related Entities**:
- PayComponentDefinition

---

### BR-TR-COMP-005: Component Category Validation

**Priority**: HIGH

**Description**:
Component category determines tax treatment and calculation behavior.

**Conditions**:
```
IF creating component
THEN category must be valid
```

**Rules**:
1. Allowed categories: BASE_SALARY, ALLOWANCE, BONUS, COMMISSION, OVERTIME, DEDUCTION, EMPLOYER_CONTRIBUTION
2. Category affects tax treatment
3. Category determines display in pay statements
4. Cannot change category after transactions exist

**Exceptions**:
- Category change requires data migration approval

**Error Messages**:
- `ERR_COMP_005`: "Invalid component category '{category}'."

**Related Requirements**:
- FR-TR-COMP-002

**Related Entities**:
- PayComponentDefinition

---

### BR-TR-COMP-006: Component Calculation Method

**Priority**: MEDIUM

**Description**:
Component calculation method must be appropriate for the component type.

**Conditions**:
```
IF component category = BASE_SALARY
THEN calculation method should be FIXED_AMOUNT or FORMULA
```

**Rules**:
1. BASE_SALARY: typically FIXED_AMOUNT
2. ALLOWANCE: FIXED_AMOUNT or PERCENTAGE
3. BONUS: FORMULA or PERCENTAGE
4. OVERTIME: FORMULA (hours × rate)
5. Calculation method determines required parameters

**Exceptions**:
- Custom calculation methods require formula definition

**Error Messages**:
- `ERR_COMP_006`: "Calculation method '{method}' not appropriate for category '{category}'."

**Related Requirements**:
- FR-TR-COMP-002

**Related Entities**:
- PayComponentDefinition

---

## Category: Grade Structure

### BR-TR-COMP-007: Grade Code Uniqueness

**Priority**: HIGH

**Description**:
Grade codes must be unique within a legal entity and career ladder.

**Conditions**:
```
IF creating Grade
AND code exists in same legal entity + career ladder
THEN reject
```

**Rules**:
1. Code unique per legal entity + career ladder combination
2. Different career ladders can have same grade codes
3. Format: alphanumeric (e.g., "L4", "M3", "IC5")
4. Maximum 20 characters

**Exceptions**:
- None

**Error Messages**:
- `ERR_COMP_007`: "Grade code '{code}' already exists in {legal_entity} / {career_ladder}."

**Related Requirements**:
- FR-TR-COMP-003

**Related Entities**:
- GradeVersion

---

### BR-TR-COMP-008: Pay Range Validation

**Priority**: HIGH

**Description**:
Pay ranges must have minimum less than maximum, with appropriate spread.

**Conditions**:
```
IF defining PayRange
THEN min < midpoint < max
AND spread within acceptable limits
```

**Rules**:
1. Minimum < Midpoint < Maximum
2. Typical spread: 20-50% (min to max)
3. Midpoint typically at 50th percentile
4. All amounts must be positive
5. Currency must match grade currency

**Exceptions**:
- Executive grades may have wider spreads (up to 100%)

**Error Messages**:
- `ERR_COMP_008`: "Invalid pay range: min={min}, mid={mid}, max={max}. Must satisfy min < mid < max."

**Examples**:
```yaml
Example 1: Valid range
  Input:
    min: 50000000
    midpoint: 65000000
    max: 80000000
    currency: VND
  
  Validation:
    BR-TR-COMP-008: PASS
    Spread: 60% ((80M - 50M) / 50M)
  
  Output:
    PayRange created

Example 2: Invalid range
  Input:
    min: 80000000
    midpoint: 65000000  # Less than min!
    max: 50000000
  
  Validation:
    BR-TR-COMP-008: FAIL
  
  Output:
    Error: ERR_COMP_008
```

**Related Requirements**:
- FR-TR-COMP-003

**Related Entities**:
- PayRange
- GradeVersion

---

### BR-TR-COMP-009: Grade Versioning (SCD Type 2)

**Priority**: HIGH

**Description**:
Grade changes create new versions while preserving history for audit and reporting.

**Conditions**:
```
IF updating Grade
THEN create new version
AND close current version
AND maintain version chain
```

**Rules**:
1. Each change creates new version (version_number + 1)
2. Previous version: valid_to = new version valid_from - 1 day
3. New version: valid_from = effective date
4. Version chain must be complete (no gaps)
5. Only one version active per effective date
6. Historical versions immutable

**Exceptions**:
- Corrections within same day can update current version

**Error Messages**:
- `ERR_COMP_009`: "Cannot update historical grade version. Create new version instead."

**Related Requirements**:
- FR-TR-COMP-003

**Related Entities**:
- GradeVersion

---

### BR-TR-COMP-010: Career Ladder Progression

**Priority**: MEDIUM

**Description**:
Career ladder defines valid grade progression paths.

**Conditions**:
```
IF employee promoted
THEN new grade must be valid next step in career ladder
```

**Rules**:
1. Promotions follow career ladder sequence
2. Can skip grades with approval
3. Cannot move backward in same ladder (demotion requires special process)
4. Can switch career ladders (e.g., IC to Management)

**Exceptions**:
- Lateral moves to different career ladder allowed
- Demotions require HR approval

**Error Messages**:
- `ERR_COMP_010`: "Grade '{new_grade}' is not a valid progression from '{current_grade}' in {career_ladder}."

**Related Requirements**:
- FR-TR-COMP-003

**Related Entities**:
- GradeLadder
- GradeLadderGrade

---

## Category: Compensation Cycles

### BR-TR-COMP-011: Cycle Period Validation

**Priority**: HIGH

**Description**:
Compensation cycles must have valid start and end dates without overlaps.

**Conditions**:
```
IF creating CompensationCycle
THEN start_date < end_date
AND no overlap with existing cycles of same type
```

**Rules**:
1. Start date must be before end date
2. Cycles of same type cannot overlap
3. Typical cycle: annual (12 months)
4. Cycle must be in future or current period
5. Cannot modify closed cycles

**Exceptions**:
- Off-cycle adjustments can overlap with annual cycle

**Error Messages**:
- `ERR_COMP_011`: "Cycle period {start} to {end} overlaps with existing cycle {cycle_id}."

**Related Requirements**:
- FR-TR-COMP-005

**Related Entities**:
- CompensationCycle

---

### BR-TR-COMP-012: Budget Allocation Validation

**Priority**: HIGH

**Description**:
Budget allocations must not exceed available budget pool.

**Conditions**:
```
IF allocating budget
THEN sum(allocations) <= total_budget
```

**Rules**:
1. Total allocations ≤ total budget
2. Budget tracked by department/business unit
3. Allocations can be reserved or committed
4. Over-allocation requires approval
5. Budget currency must match plan currency

**Exceptions**:
- Emergency adjustments may exceed budget with CFO approval

**Error Messages**:
- `ERR_COMP_012`: "Budget allocation {amount} exceeds available budget {available}."

**Examples**:
```yaml
Example: Budget allocation
  Input:
    total_budget: 1000000000 VND
    department_allocations:
      - dept: Engineering, amount: 600000000
      - dept: Sales, amount: 300000000
      - dept: Marketing, amount: 150000000
  
  Validation:
    Total: 1050000000 VND
    BR-TR-COMP-012: FAIL (exceeds by 50M)
  
  Output:
    Error: ERR_COMP_012
```

**Related Requirements**:
- FR-TR-COMP-005
- FR-TR-COMP-009

**Related Entities**:
- BudgetAllocation
- CompensationCycle

---

### BR-TR-COMP-013: Adjustment Effective Date

**Priority**: HIGH

**Description**:
Compensation adjustments must have effective dates within the cycle period.

**Conditions**:
```
IF creating CompensationAdjustment
THEN effective_date >= cycle.start_date
AND effective_date <= cycle.end_date
```

**Rules**:
1. Effective date within cycle period
2. Typically first day of month
3. Cannot be in the past (except corrections)
4. Future-dated adjustments allowed
5. Retroactive adjustments require approval

**Exceptions**:
- Corrections can have past effective dates with approval

**Error Messages**:
- `ERR_COMP_013`: "Effective date {date} is outside cycle period {start} to {end}."

**Related Requirements**:
- FR-TR-COMP-006

**Related Entities**:
- CompensationAdjustment

---

*[Document continues with remaining business rules...]*

---

**Note**: Due to the comprehensive nature of this document (~300 rules), this is Part 1 showing the structure and first 13 rules. The complete document will include all rules across all 11 sub-modules following the same detailed format.

**Structure for each rule**:
- Rule ID and Title
- Priority (HIGH/MEDIUM/LOW)
- Description
- Conditions (IF-THEN logic)
- Detailed Rules (numbered list)
- Exceptions
- Error Messages with codes
- Examples (YAML format)
- Related Requirements
- Related Entities

**Next sections to complete**:
- Remaining Core Compensation rules (BR-COMP-014 to BR-COMP-051)
- Variable Pay rules (BR-VAR-001 to BR-VAR-050)
- Benefits rules (BR-BEN-001 to BR-BEN-066)
- Recognition rules (BR-REC-001 to BR-REC-031)
- Offer Management rules (BR-OFFER-001 to BR-OFFER-034)
- TR Statement rules (BR-STMT-001 to BR-STMT-022)
- Deductions rules (BR-DED-001 to BR-DED-032)
- Tax Withholding rules (BR-TAX-001 to BR-TAX-037)
- Taxable Bridge rules (BR-BRIDGE-001 to BR-BRIDGE-018)
- Audit rules (BR-AUDIT-001 to BR-AUDIT-025)
- Calculation rules (BR-CALC-001 to BR-CALC-037)

**Total**: ~300 business rules

### BR-TR-COMP-014: Adjustment Amount Validation

**Priority**: HIGH

**Description**:
Compensation adjustments must result in salary within the grade pay range.

**Conditions**:
```
IF creating CompensationAdjustment
THEN new_salary >= grade.pay_range.min
AND new_salary <= grade.pay_range.max
```

**Rules**:
1. New salary must be within grade pay range
2. Exceptions require approval (out-of-range)
3. Red-circle (above max) allowed with justification
4. Green-circle (below min) requires action plan
5. Compa-ratio calculated: (salary / midpoint) × 100

**Exceptions**:
- Out-of-range adjustments require VP+ approval
- Grandfathered employees may be red-circled

**Error Messages**:
- `ERR_COMP_014`: "New salary {amount} is outside grade pay range [{min} - {max}]."
- `WARN_COMP_014`: "Salary {amount} is {percentage}% above maximum. Approval required."

**Examples**:
```yaml
Example 1: Within range
  Input:
    current_salary: 60000000
    adjustment: +5000000
    new_salary: 65000000
    grade_range: [50M - 80M]
  
  Validation:
    BR-TR-COMP-014: PASS
    Compa-ratio: 100% (assuming midpoint = 65M)
  
  Output:
    Adjustment approved

Example 2: Above maximum (red-circle)
  Input:
    current_salary: 75000000
    adjustment: +10000000
    new_salary: 85000000
    grade_range: [50M - 80M]
  
  Validation:
    BR-TR-COMP-014: WARNING
    Above max by: 6.25%
  
  Output:
    Requires VP approval
```

**Related Requirements**:
- FR-TR-COMP-006
- FR-TR-COMP-014

**Related Entities**:
- CompensationAdjustment
- PayRange
- EmployeeCompensationSnapshot

---

### BR-TR-COMP-015: Adjustment Type Validation

**Priority**: MEDIUM

**Description**:
Adjustment type determines calculation method and approval requirements.

**Conditions**:
```
IF adjustment_type = MERIT
THEN performance_rating required
AND merit_matrix applied
```

**Rules**:
1. MERIT: requires performance rating, follows merit matrix
2. PROMOTION: requires new grade, typically larger increase
3. MARKET: based on market data, no performance requirement
4. EQUITY: addresses pay gaps, requires analysis
5. RETENTION: competitive threat, requires justification
6. Each type has different approval thresholds

**Exceptions**:
- Emergency retention adjustments may bypass normal approval

**Error Messages**:
- `ERR_COMP_015`: "Performance rating required for MERIT adjustment."

**Related Requirements**:
- FR-TR-COMP-006

**Related Entities**:
- CompensationAdjustment

---

### BR-TR-COMP-016: Merit Increase Calculation

**Priority**: HIGH

**Description**:
Merit increases calculated based on performance rating and compa-ratio using merit matrix.

**Conditions**:
```
IF adjustment_type = MERIT
THEN increase_percentage = merit_matrix[performance_rating][compa_ratio_band]
```

**Rules**:
1. Merit matrix: 2D lookup (performance × compa-ratio)
2. Higher performance → higher increase
3. Lower compa-ratio → higher increase (catch-up)
4. Matrix configured per compensation plan
5. Auto-calculated, can be overridden with approval

**Exceptions**:
- Manual overrides require manager justification

**Error Messages**:
- `ERR_COMP_016`: "Merit matrix not configured for plan {plan_id}."

**Examples**:
```yaml
Example: Merit matrix lookup
  Input:
    performance_rating: "Exceeds"
    current_salary: 60000000
    midpoint: 65000000
    compa_ratio: 92.3%
    compa_ratio_band: "<95%"
  
  Merit Matrix:
    Performance: Exceeds, Compa: <95% → 8%
  
  Calculation:
    increase_amount: 60M × 8% = 4,800,000
    new_salary: 64,800,000
  
  Validation:
    BR-TR-COMP-016: PASS
  
  Output:
    Recommended increase: 4.8M (8%)
```

**Related Requirements**:
- FR-TR-COMP-006

**Related Entities**:
- CompensationAdjustment
- MeritMatrix

---

### BR-TR-COMP-017: Promotion Increase Guidelines

**Priority**: MEDIUM

**Description**:
Promotion increases should bring salary to appropriate position in new grade range.

**Conditions**:
```
IF adjustment_type = PROMOTION
THEN new_salary >= new_grade.min
AND typically >= new_grade.min + 10%
```

**Rules**:
1. Minimum increase: to new grade minimum
2. Typical target: 10-20% above new grade minimum
3. Consider compa-ratio in new grade
4. Larger increases for multi-level promotions
5. Cannot exceed new grade maximum without approval

**Exceptions**:
- Small increases if already near new grade range

**Error Messages**:
- `ERR_COMP_017`: "Promotion increase must bring salary to at least new grade minimum."

**Related Requirements**:
- FR-TR-COMP-006

**Related Entities**:
- CompensationAdjustment

---

### BR-TR-COMP-018: Budget Consumption Tracking

**Priority**: HIGH

**Description**:
Track budget consumption in real-time to prevent over-spending.

**Conditions**:
```
IF approving adjustment
THEN update budget_consumed
AND check budget_consumed <= budget_allocated
```

**Rules**:
1. Budget consumed = sum of approved adjustments
2. Pending adjustments reserved but not consumed
3. Rejected adjustments release reservation
4. Budget tracked by department/business unit
5. Alerts at 80%, 90%, 100% consumption

**Exceptions**:
- Over-budget requires CFO approval

**Error Messages**:
- `ERR_COMP_018`: "Budget exceeded: consumed {consumed} > allocated {allocated}."
- `WARN_COMP_018`: "Budget {percentage}% consumed. Approaching limit."

**Related Requirements**:
- FR-TR-COMP-009

**Related Entities**:
- BudgetAllocation
- CompensationAdjustment

---

### BR-TR-COMP-019: Approval Routing Rules

**Priority**: HIGH

**Description**:
Route adjustments for approval based on amount, type, and organizational hierarchy.

**Conditions**:
```
IF adjustment_amount > threshold_1
THEN require manager approval
IF adjustment_amount > threshold_2
THEN require director approval
IF adjustment_amount > threshold_3
THEN require VP approval
```

**Rules**:
1. Manager approval: all adjustments
2. Director approval: >10% increase or >$10K
3. VP approval: >20% increase or >$25K
4. CFO approval: out-of-range or over-budget
5. Thresholds configurable per legal entity
6. Approval chain must be complete

**Exceptions**:
- Delegated approval authority
- Auto-approval for small merit increases (<3%)

**Error Messages**:
- `ERR_COMP_019`: "Adjustment requires {approver_level} approval."

**Related Requirements**:
- FR-TR-COMP-007
- FR-TR-COMP-018

**Related Entities**:
- CompensationAdjustment
- ApprovalWorkflow

---

### BR-TR-COMP-020: Approval Delegation

**Priority**: MEDIUM

**Description**:
Approvers can delegate authority to others temporarily.

**Conditions**:
```
IF approver delegates authority
THEN delegate can approve within delegated limits
AND delegation has start/end dates
```

**Rules**:
1. Delegation requires explicit setup
2. Delegate authority limited to delegator's authority
3. Delegation time-bound (start/end dates)
4. Original approver notified of delegated approvals
5. Delegation can be revoked

**Exceptions**:
- Cannot delegate CFO-level approvals

**Error Messages**:
- `ERR_COMP_020`: "Delegation expired on {date}."

**Related Requirements**:
- FR-TR-COMP-007

**Related Entities**:
- ApprovalWorkflow

---

### BR-TR-COMP-021: Cycle Finalization Rules

**Priority**: HIGH

**Description**:
Compensation cycles can only be finalized when all adjustments are approved.

**Conditions**:
```
IF finalizing cycle
THEN all adjustments must be APPROVED or REJECTED
AND no adjustments in PENDING state
AND budget reconciled
```

**Rules**:
1. All adjustments must have final status
2. Budget consumed = sum of approved adjustments
3. Finalization creates salary snapshots
4. Finalized cycles cannot be modified
5. Effective dates applied to employee records

**Exceptions**:
- Can reopen cycle with HR Director approval

**Error Messages**:
- `ERR_COMP_021`: "Cannot finalize cycle: {count} adjustments still pending."

**Related Requirements**:
- FR-TR-COMP-008

**Related Entities**:
- CompensationCycle
- EmployeeCompensationSnapshot

---

### BR-TR-COMP-022: Salary Snapshot Creation

**Priority**: HIGH

**Description**:
Create immutable salary snapshots when cycle is finalized.

**Conditions**:
```
IF cycle finalized
THEN create EmployeeCompensationSnapshot for each approved adjustment
WITH effective_date = adjustment.effective_date
```

**Rules**:
1. Snapshot created for each approved adjustment
2. Snapshot includes all component amounts
3. Snapshot effective from adjustment effective date
4. Previous snapshot closed (valid_to = new effective_date - 1)
5. Snapshots immutable after creation

**Exceptions**:
- Corrections require new snapshot with adjustment

**Error Messages**:
- `ERR_COMP_022`: "Cannot modify historical snapshot. Create correction instead."

**Related Requirements**:
- FR-TR-COMP-008

**Related Entities**:
- EmployeeCompensationSnapshot
- SalaryHistory

---

### BR-TR-COMP-023: Budget Alert Thresholds

**Priority**: MEDIUM

**Description**:
Send alerts when budget consumption reaches defined thresholds.

**Conditions**:
```
IF budget_consumed >= threshold
THEN send alert to budget owner
```

**Rules**:
1. Alert at 80% consumption (warning)
2. Alert at 90% consumption (critical)
3. Alert at 100% consumption (exceeded)
4. Alerts sent to budget owner and HR
5. Daily digest of budget status

**Exceptions**:
- Can configure custom thresholds per department

**Error Messages**:
- N/A (alerts, not errors)

**Related Requirements**:
- FR-TR-COMP-009

**Related Entities**:
- BudgetAllocation

---

### BR-TR-COMP-024: Retroactive Adjustment Rules

**Priority**: MEDIUM

**Description**:
Retroactive adjustments require special approval and payroll processing.

**Conditions**:
```
IF effective_date < current_date
THEN retroactive = true
AND requires HR approval
AND calculate back_pay
```

**Rules**:
1. Retroactive = effective date in past
2. Requires HR approval
3. Calculate back pay for period
4. Back pay processed in next payroll
5. Tax implications documented

**Exceptions**:
- Corrections within same month not considered retroactive

**Error Messages**:
- `WARN_COMP_024`: "Retroactive adjustment requires HR approval and back pay calculation."

**Related Requirements**:
- FR-TR-COMP-006

**Related Entities**:
- CompensationAdjustment

---

### BR-TR-COMP-025: Concurrent Adjustment Prevention

**Priority**: HIGH

**Description**:
Prevent multiple concurrent adjustments for same employee in same cycle.

**Conditions**:
```
IF creating adjustment
AND employee has PENDING adjustment in same cycle
THEN reject or require approval
```

**Rules**:
1. Only one pending adjustment per employee per cycle
2. Must approve/reject existing before creating new
3. Exception: off-cycle adjustments allowed
4. Prevents conflicting changes
5. Latest adjustment supersedes if approved

**Exceptions**:
- Multiple adjustments allowed with HR approval

**Error Messages**:
- `ERR_COMP_025`: "Employee {id} already has pending adjustment {adj_id} in this cycle."

**Related Requirements**:
- FR-TR-COMP-006

**Related Entities**:
- CompensationAdjustment

---

### BR-TR-COMP-026: Cycle Closure Deadline

**Priority**: MEDIUM

**Description**:
Compensation cycles must be finalized by deadline to ensure timely payroll processing.

**Conditions**:
```
IF current_date > cycle.finalization_deadline
AND cycle.status != FINALIZED
THEN send escalation alerts
```

**Rules**:
1. Finalization deadline configured per cycle
2. Typically 2 weeks before effective date
3. Alerts sent at deadline
4. Escalation to HR Director if missed
5. Late finalization requires approval

**Exceptions**:
- Deadline can be extended with approval

**Error Messages**:
- `WARN_COMP_026`: "Cycle finalization deadline {date} approaching."

**Related Requirements**:
- FR-TR-COMP-008

**Related Entities**:
- CompensationCycle

---

## Category: Component Dependencies

### BR-TR-COMP-027: Component Dependency Validation

**Priority**: HIGH

**Description**:
Dependent components must reference valid base components.

**Conditions**:
```
IF component has dependency
THEN dependent_on component must exist
AND be active
AND not create circular dependency
```

**Rules**:
1. Dependent component references base component
2. Base component must exist and be active
3. No circular dependencies allowed
4. Dependency chain validated
5. Deleting base component requires handling dependents

**Exceptions**:
- Can temporarily disable dependent component

**Error Messages**:
- `ERR_COMP_027`: "Component {id} depends on non-existent component {dep_id}."
- `ERR_COMP_027_CIRCULAR`: "Circular dependency detected: {chain}."

**Related Requirements**:
- FR-TR-COMP-010

**Related Entities**:
- ComponentDependency
- PayComponentDefinition

---

### BR-TR-COMP-028: Dependency Calculation Order

**Priority**: HIGH

**Description**:
Components must be calculated in dependency order.

**Conditions**:
```
IF component A depends on component B
THEN calculate B before A
```

**Rules**:
1. Base components calculated first
2. Dependent components calculated after base
3. Calculation order determined by dependency graph
4. Parallel calculation for independent components
5. Circular dependencies prevented

**Exceptions**:
- None (strict ordering required)

**Error Messages**:
- `ERR_COMP_028`: "Cannot calculate {component}: dependency {dep} not yet calculated."

**Related Requirements**:
- FR-TR-COMP-010

**Related Entities**:
- ComponentDependency

---

### BR-TR-COMP-029: Dependency Impact Analysis

**Priority**: MEDIUM

**Description**:
Analyze impact of base component changes on dependent components.

**Conditions**:
```
IF modifying base component
THEN identify all dependent components
AND warn about impact
```

**Rules**:
1. Identify all components depending on modified component
2. Warn about potential calculation changes
3. Require confirmation before proceeding
4. Log impact analysis results
5. Notify owners of dependent components

**Exceptions**:
- Minor changes may not require impact analysis

**Error Messages**:
- `WARN_COMP_029`: "Modifying {component} will affect {count} dependent components."

**Related Requirements**:
- FR-TR-COMP-010

**Related Entities**:
- ComponentDependency

---

## Category: Proration Rules

### BR-TR-COMP-030: Proration Method Selection

**Priority**: HIGH

**Description**:
Select appropriate proration method based on component type and scenario.

**Conditions**:
```
IF employee starts/ends mid-period
THEN apply proration based on component configuration
```

**Rules**:
1. CALENDAR_DAYS: actual days / total days in period
2. WORKING_DAYS: working days / total working days
3. FULL_MONTH: no proration, full amount
4. NO_PRORATION: not applicable
5. Method configured per component
6. Different methods for hire vs termination

**Exceptions**:
- Some components never prorated (e.g., one-time bonuses)

**Error Messages**:
- `ERR_COMP_030`: "Proration method not configured for component {id}."

**Examples**:
```yaml
Example 1: Calendar days proration
  Input:
    component: Base Salary
    monthly_amount: 30000000
    hire_date: 2025-01-15
    period: January 2025 (31 days)
    days_worked: 17 days (15-31)
  
  Calculation:
    proration_method: CALENDAR_DAYS
    prorated_amount: 30M × (17/31) = 16,451,613
  
  Validation:
    BR-TR-COMP-030: PASS
  
  Output:
    Amount: 16,451,613 VND

Example 2: Working days proration
  Input:
    component: Base Salary
    monthly_amount: 30000000
    hire_date: 2025-01-15
    period: January 2025
    working_days_in_month: 22
    working_days_worked: 13
  
  Calculation:
    proration_method: WORKING_DAYS
    prorated_amount: 30M × (13/22) = 17,727,273
  
  Validation:
    BR-TR-COMP-030: PASS
  
  Output:
    Amount: 17,727,273 VND
```

**Related Requirements**:
- FR-TR-COMP-011

**Related Entities**:
- ProrationRule
- PayComponentDefinition

---


### BR-TR-COMP-031: Proration for Partial Periods

**Priority**: HIGH

**Description**:
Calculate prorated amounts accurately for partial employment periods.

**Conditions**:
```
IF employee active for partial period
THEN prorate based on configured method
```

**Rules**:
1. Hire mid-period: prorate from hire date
2. Termination mid-period: prorate to last day
3. Leave of absence: may or may not prorate (configurable)
4. Proration applies to recurring components only
5. One-time payments typically not prorated

**Exceptions**:
- Full month rule: if hired before 15th, pay full month

**Error Messages**:
- `ERR_COMP_031`: "Cannot prorate component {id}: proration rule not defined."

**Related Requirements**:
- FR-TR-COMP-011

**Related Entities**:
- ProrationRule

---

## Category: Salary History

### BR-TR-COMP-032: Salary History Immutability

**Priority**: HIGH

**Description**:
Salary history records are immutable once created to maintain audit trail.

**Conditions**:
```
IF SalaryHistory record created
THEN cannot be modified or deleted
```

**Rules**:
1. History records immutable
2. Corrections create new records
3. Complete audit trail maintained
4. Effective dates determine active record
5. Historical queries use effective date

**Exceptions**:
- System errors within 24 hours can be corrected with approval

**Error Messages**:
- `ERR_COMP_032`: "Cannot modify historical salary record. Create correction instead."

**Related Requirements**:
- FR-TR-COMP-012

**Related Entities**:
- SalaryHistory
- EmployeeCompensationSnapshot

---

### BR-TR-COMP-033: Salary History Completeness

**Priority**: HIGH

**Description**:
Salary history must have complete, gap-free timeline for each employee.

**Conditions**:
```
IF employee has salary
THEN must have continuous history from hire date
AND no gaps in effective dates
```

**Rules**:
1. First record: effective_from = hire_date
2. Subsequent records: effective_from = previous.effective_to + 1 day
3. Current record: effective_to = NULL or future date
4. No gaps allowed in timeline
5. Overlaps not allowed

**Exceptions**:
- Unpaid leave periods may have gaps (configurable)

**Error Messages**:
- `ERR_COMP_033`: "Salary history gap detected: {date1} to {date2}."

**Related Requirements**:
- FR-TR-COMP-012

**Related Entities**:
- SalaryHistory

---

## Category: Pay Equity

### BR-TR-COMP-034: Pay Equity Analysis Scope

**Priority**: HIGH

**Description**:
Pay equity analysis must include all employees in comparable roles.

**Conditions**:
```
IF running pay equity analysis
THEN include all employees with:
  - Same job family
  - Same grade level
  - Same location (if location-based pay)
  - Active employment status
```

**Rules**:
1. Group by job family + grade + location
2. Minimum group size: 5 employees (for statistical significance)
3. Exclude executives (separate analysis)
4. Include all protected groups
5. Analysis run quarterly minimum

**Exceptions**:
- Small groups (<5) flagged but included

**Error Messages**:
- `WARN_COMP_034`: "Group size {count} below minimum threshold of 5."

**Related Requirements**:
- FR-TR-COMP-013

**Related Entities**:
- EmployeeCompensationSnapshot
- Core.Employee

---

### BR-TR-COMP-035: Pay Gap Threshold

**Priority**: HIGH

**Description**:
Define thresholds for identifying significant pay gaps.

**Conditions**:
```
IF pay gap > threshold
THEN flag for review
```

**Rules**:
1. Significant gap: >5% difference in median pay
2. Critical gap: >10% difference
3. Calculate by protected group (gender, ethnicity, etc.)
4. Compare to control group (majority group)
5. Statistical significance required

**Exceptions**:
- Legitimate factors (tenure, performance) may explain gaps

**Error Messages**:
- `WARN_COMP_035`: "Pay gap of {percentage}% detected for {group}."

**Related Requirements**:
- FR-TR-COMP-013

**Related Entities**:
- EmployeeCompensationSnapshot

---

### BR-TR-COMP-036: Pay Equity Remediation

**Priority**: MEDIUM

**Description**:
Pay gaps must be addressed through remediation plans.

**Conditions**:
```
IF pay gap > threshold
AND no legitimate explanation
THEN create remediation plan
```

**Rules**:
1. Remediation plan required for significant gaps
2. Plan includes timeline and budget
3. Adjustments prioritized by gap size
4. Progress tracked quarterly
5. Completion target: within 2 years

**Exceptions**:
- Immediate remediation for critical gaps

**Error Messages**:
- `WARN_COMP_036`: "Remediation plan required for {group} with {percentage}% gap."

**Related Requirements**:
- FR-TR-COMP-013

**Related Entities**:
- CompensationAdjustment

---

## Category: Compa-Ratio

### BR-TR-COMP-037: Compa-Ratio Calculation

**Priority**: HIGH

**Description**:
Calculate compa-ratio as percentage of salary to grade midpoint.

**Conditions**:
```
compa_ratio = (current_salary / grade_midpoint) × 100
```

**Rules**:
1. Formula: (salary / midpoint) × 100
2. 100% = at midpoint (market rate)
3. <100% = below market
4. >100% = above market
5. Typical range: 80-120%

**Exceptions**:
- New hires typically 90-95%
- Top performers may be 110-120%

**Error Messages**:
- `WARN_COMP_037`: "Compa-ratio {ratio}% outside typical range [80-120%]."

**Examples**:
```yaml
Example 1: At market
  Input:
    salary: 65000000
    grade_midpoint: 65000000
  
  Calculation:
    compa_ratio: (65M / 65M) × 100 = 100%
  
  Interpretation:
    At market rate
  
  Validation:
    BR-TR-COMP-037: PASS

Example 2: Below market
  Input:
    salary: 55000000
    grade_midpoint: 65000000
  
  Calculation:
    compa_ratio: (55M / 65M) × 100 = 84.6%
  
  Interpretation:
    Below market, candidate for increase
  
  Validation:
    BR-TR-COMP-037: PASS
```

**Related Requirements**:
- FR-TR-COMP-014

**Related Entities**:
- EmployeeCompensationSnapshot
- PayRange

---

### BR-TR-COMP-038: Compa-Ratio Bands

**Priority**: MEDIUM

**Description**:
Group employees into compa-ratio bands for analysis and merit matrix.

**Conditions**:
```
IF compa_ratio < 85%
THEN band = "Well Below Market"
ELSIF compa_ratio < 95%
THEN band = "Below Market"
...
```

**Rules**:
1. Bands:
   - <85%: Well Below Market
   - 85-95%: Below Market
   - 95-105%: At Market
   - 105-115%: Above Market
   - >115%: Well Above Market
2. Bands used in merit matrix
3. Lower bands get higher merit increases
4. Bands configurable per company

**Exceptions**:
- Custom bands for specific roles

**Error Messages**:
- N/A (informational)

**Related Requirements**:
- FR-TR-COMP-014

**Related Entities**:
- EmployeeCompensationSnapshot

---

### BR-TR-COMP-039: Compa-Ratio Targets

**Priority**: MEDIUM

**Description**:
Define target compa-ratios by employee tenure and performance.

**Conditions**:
```
IF performance = "Exceeds"
AND tenure > 3 years
THEN target_compa_ratio = 105-110%
```

**Rules**:
1. New hires: 90-95%
2. Meets expectations + 1-3 years: 95-100%
3. Meets expectations + 3+ years: 100-105%
4. Exceeds expectations: 105-110%
5. Outstanding: 110-120%

**Exceptions**:
- High-demand roles may have higher targets

**Error Messages**:
- N/A (guidelines, not hard rules)

**Related Requirements**:
- FR-TR-COMP-014

**Related Entities**:
- EmployeeCompensationSnapshot

---

### BR-TR-COMP-040: Compa-Ratio Monitoring

**Priority**: MEDIUM

**Description**:
Monitor compa-ratios and alert on outliers.

**Conditions**:
```
IF compa_ratio < 80% OR compa_ratio > 120%
THEN alert HR
```

**Rules**:
1. Alert on compa-ratio <80% (green-circle)
2. Alert on compa-ratio >120% (red-circle)
3. Monthly monitoring reports
4. Trend analysis over time
5. Action plans for outliers

**Exceptions**:
- Grandfathered employees may be red-circled

**Error Messages**:
- `WARN_COMP_040`: "Employee {id} has compa-ratio {ratio}% outside acceptable range."

**Related Requirements**:
- FR-TR-COMP-014

**Related Entities**:
- EmployeeCompensationSnapshot

---

### BR-TR-COMP-041: Compa-Ratio in Hiring

**Priority**: MEDIUM

**Description**:
Use compa-ratio to guide offer amounts for new hires.

**Conditions**:
```
IF creating offer
THEN target_compa_ratio = 90-95%
UNLESS high-demand role OR exceptional candidate
```

**Rules**:
1. Standard offers: 90-95% compa-ratio
2. Experienced hires: 95-100%
3. High-demand roles: up to 105%
4. Exceptional candidates: up to 110%
5. Consistency with internal equity

**Exceptions**:
- Competitive situations may require higher offers

**Error Messages**:
- `WARN_COMP_041`: "Offer compa-ratio {ratio}% exceeds guideline for new hire."

**Related Requirements**:
- FR-TR-COMP-014
- FR-TR-OFFER-002

**Related Entities**:
- OfferPackage

---

## Category: Mass Upload

### BR-TR-COMP-042: Upload File Validation

**Priority**: HIGH

**Description**:
Validate mass compensation upload files before processing.

**Conditions**:
```
IF uploading compensation file
THEN validate format, required fields, data types
```

**Rules**:
1. Required fields: employee_id, component_code, amount, effective_date
2. Employee ID must exist
3. Component code must exist and be active
4. Amount must be positive number
5. Effective date must be valid date format
6. Maximum 10,000 records per file

**Exceptions**:
- Larger files require batch processing

**Error Messages**:
- `ERR_COMP_042`: "Row {row}: Invalid employee ID '{id}'."
- `ERR_COMP_042_FORMAT`: "File format invalid. Expected CSV with headers."

**Related Requirements**:
- FR-TR-COMP-015

**Related Entities**:
- CompensationAdjustment

---

### BR-TR-COMP-043: Upload Duplicate Detection

**Priority**: HIGH

**Description**:
Detect and prevent duplicate records in mass upload.

**Conditions**:
```
IF upload contains duplicate (employee_id + component + effective_date)
THEN reject or flag for review
```

**Rules**:
1. Duplicate = same employee + component + effective date
2. Within same file: reject
3. Across files: flag for review
4. Latest upload wins (if approved)
5. Audit log of duplicates

**Exceptions**:
- Intentional corrections allowed with flag

**Error Messages**:
- `ERR_COMP_043`: "Duplicate record for employee {id}, component {code}."

**Related Requirements**:
- FR-TR-COMP-015

**Related Entities**:
- CompensationAdjustment

---

### BR-TR-COMP-044: Upload Validation Summary

**Priority**: MEDIUM

**Description**:
Provide comprehensive validation summary before committing upload.

**Conditions**:
```
IF upload validated
THEN show summary:
  - Total records
  - Valid records
  - Invalid records
  - Warnings
```

**Rules**:
1. Summary includes counts by status
2. List all errors and warnings
3. Allow download of error report
4. Require confirmation before commit
5. Rollback option if errors found

**Exceptions**:
- Can proceed with warnings (not errors)

**Error Messages**:
- N/A (summary report)

**Related Requirements**:
- FR-TR-COMP-015

**Related Entities**:
- CompensationAdjustment

---

## Category: Compensation Statements

### BR-TR-COMP-045: Statement Generation Timing

**Priority**: MEDIUM

**Description**:
Generate compensation statements after cycle finalization.

**Conditions**:
```
IF cycle.status = FINALIZED
THEN eligible for statement generation
```

**Rules**:
1. Statements generated after finalization
2. Include all approved adjustments
3. Show before/after comparison
4. Include effective dates
5. Personalized per employee

**Exceptions**:
- Preview statements available before finalization

**Error Messages**:
- `ERR_COMP_045`: "Cannot generate statements: cycle not finalized."

**Related Requirements**:
- FR-TR-COMP-016

**Related Entities**:
- CompensationCycle
- EmployeeCompensationSnapshot

---

### BR-TR-COMP-046: Statement Content Requirements

**Priority**: MEDIUM

**Description**:
Compensation statements must include all required information.

**Conditions**:
```
IF generating statement
THEN include:
  - Current compensation
  - New compensation
  - Change amount and percentage
  - Effective date
  - Component breakdown
```

**Rules**:
1. Required sections:
   - Employee information
   - Current compensation breakdown
   - New compensation breakdown
   - Change summary
   - Effective date
2. Optional sections:
   - Performance rating
   - Compa-ratio
   - Manager message
3. Confidential and secure delivery

**Exceptions**:
- Minimal statements for no-change employees

**Error Messages**:
- `ERR_COMP_046`: "Statement missing required section: {section}."

**Related Requirements**:
- FR-TR-COMP-016

**Related Entities**:
- EmployeeCompensationSnapshot

---

## Category: Benchmarking

### BR-TR-COMP-047: Market Data Validation

**Priority**: MEDIUM

**Description**:
Validate market data before using in benchmarking.

**Conditions**:
```
IF importing market data
THEN validate source, date, geography, job match
```

**Rules**:
1. Data from reputable sources only
2. Data not older than 12 months
3. Geography matches company locations
4. Job titles mapped to internal roles
5. Sample size adequate (n>10)

**Exceptions**:
- Niche roles may have limited data

**Error Messages**:
- `WARN_COMP_047`: "Market data older than 12 months."

**Related Requirements**:
- FR-TR-COMP-017

**Related Entities**:
- MarketData (external)

---

### BR-TR-COMP-048: Benchmark Comparison

**Priority**: MEDIUM

**Description**:
Compare internal compensation to market benchmarks.

**Conditions**:
```
IF comparing to market
THEN calculate:
  - Position vs 50th percentile
  - Position vs 25th/75th percentiles
  - Competitive ratio
```

**Rules**:
1. Compare to 50th percentile (median)
2. Show range (25th to 75th percentile)
3. Calculate competitive ratio: (internal / market) × 100
4. 100% = at market
5. <90% = below market, >110% = above market

**Exceptions**:
- High-cost-of-living areas may pay above market

**Error Messages**:
- N/A (informational)

**Related Requirements**:
- FR-TR-COMP-017

**Related Entities**:
- EmployeeCompensationSnapshot
- MarketData

---

## Category: Approval Workflow

### BR-TR-COMP-049: Workflow Configuration Validation

**Priority**: HIGH

**Description**:
Validate approval workflow configuration before activation.

**Conditions**:
```
IF configuring workflow
THEN validate:
  - At least one approval level
  - Approvers exist and are active
  - Thresholds in ascending order
  - No gaps in approval chain
```

**Rules**:
1. Minimum one approval level required
2. All approvers must be active employees
3. Thresholds must be ascending
4. Approval chain must be complete
5. Fallback approver configured

**Exceptions**:
- Auto-approval for amounts below minimum threshold

**Error Messages**:
- `ERR_COMP_049`: "Invalid workflow: approver {id} not found or inactive."

**Related Requirements**:
- FR-TR-COMP-018

**Related Entities**:
- ApprovalWorkflow

---

### BR-TR-COMP-050: Workflow Escalation Rules

**Priority**: MEDIUM

**Description**:
Escalate approvals that exceed SLA.

**Conditions**:
```
IF approval pending > SLA_days
THEN escalate to next level
```

**Rules**:
1. SLA: 3 business days per level
2. Reminder at 2 days
3. Escalation at 3 days
4. Escalate to approver's manager
5. Final escalation to HR Director

**Exceptions**:
- Can extend SLA with justification

**Error Messages**:
- `WARN_COMP_050`: "Approval {id} exceeded SLA. Escalating to {escalation_approver}."

**Related Requirements**:
- FR-TR-COMP-018

**Related Entities**:
- ApprovalWorkflow

---

### BR-TR-COMP-051: Workflow Audit Trail

**Priority**: HIGH

**Description**:
Maintain complete audit trail of all approval actions.

**Conditions**:
```
IF approval action taken
THEN log:
  - Action (approve/reject/delegate)
  - Approver
  - Timestamp
  - Comments
  - IP address
```

**Rules**:
1. All actions logged immutably
2. Include approver identity
3. Include timestamp
4. Include comments/justification
5. Retain for 7 years minimum

**Exceptions**:
- None (required for compliance)

**Error Messages**:
- N/A (automatic logging)

**Related Requirements**:
- FR-TR-COMP-018
- FR-TR-AUDIT-002

**Related Entities**:
- ApprovalHistory

---

## Summary: Core Compensation Rules

**Total Rules**: 51  
**Priority Breakdown**:
- HIGH: 32 rules (63%)
- MEDIUM: 19 rules (37%)
- LOW: 0 rules

**Categories**:
1. Salary Basis Management (3 rules)
2. Pay Component Definition (3 rules)
3. Grade Structure (4 rules)
4. Compensation Cycles (13 rules)
5. Component Dependencies (3 rules)
6. Proration Rules (2 rules)
7. Salary History (2 rules)
8. Pay Equity (3 rules)
9. Compa-Ratio (5 rules)
10. Mass Upload (3 rules)
11. Compensation Statements (2 rules)
12. Benchmarking (2 rules)
13. Approval Workflow (3 rules)

**Key Highlights**:
- Comprehensive validation rules for data integrity
- Detailed proration calculations with examples
- Pay equity analysis and remediation
- Compa-ratio management and monitoring
- Robust approval workflow with escalation
- Complete audit trail for compliance

---

**Status**: ✅ Core Compensation Rules Complete (51/51)

**Next Sub-Module**: Variable Pay (50 rules)


---

