# 10. Audit Rules

**Total Rules**: 25  
**Priority**: HIGH: 18 rules, MEDIUM: 7 rules

---

## Category: Change Tracking

### BR-TR-AUDIT-001: Data Change Logging

**Priority**: HIGH

**Description**:
Log all changes to TR data with complete audit trail.

**Conditions**:
```
WHEN TR data changes
THEN log change to audit trail
```

**Rules**:
1. Log events: CREATE, UPDATE, DELETE
2. Capture: User, Timestamp, Action, Entity type, Entity ID
3. Before/after values for UPDATE
4. Change reason required for sensitive changes
5. Immutable audit logs (cannot be modified or deleted)

**Exceptions**:
- System-generated changes: Mark as SYSTEM user

**Error Messages**:
- `ERR_AUDIT_001`: "Audit log write failed: {reason}."

**Related Requirements**: FR-TR-AUDIT-001

**Related Entities**: AuditLog

---

### BR-TR-AUDIT-002: Before/After Value Capture

**Priority**: HIGH

**Description**:
Capture before and after values for all data changes.

**Conditions**:
```
WHEN data updated
THEN capture before and after values
```

**Rules**:
1. Store old value (before change)
2. Store new value (after change)
3. Store field name
4. JSON format for complex objects
5. Enable change comparison and rollback

**Exceptions**:
- Sensitive data: Mask or hash values

**Error Messages**:
- None

**Related Requirements**: FR-TR-AUDIT-002

**Related Entities**: AuditLog, ChangeHistory

---

### BR-TR-AUDIT-003: Change Reason Documentation

**Priority**: HIGH

**Description**:
Require reason for sensitive data changes.

**Conditions**:
```
IF changing sensitive data
THEN reason required
```

**Rules**:
1. Sensitive changes: Salary, bonus, equity, benefits, tax elections
2. Reason types: CORRECTION, PROMOTION, MERIT_INCREASE, LIFE_EVENT, OTHER
3. Free-text explanation required
4. Approval required for certain changes
5. Reason stored in audit log

**Exceptions**:
- Automated system changes: System-generated reason

**Error Messages**:
- `ERR_AUDIT_003`: "Change reason required for {field}."

**Related Requirements**: FR-TR-AUDIT-003

**Related Entities**: AuditLog, ChangeReason

---

### BR-TR-AUDIT-004: Approval History Tracking

**Priority**: HIGH

**Description**:
Track complete approval history for workflows.

**Conditions**:
```
WHEN approval action occurs
THEN log approval event
```

**Rules**:
1. Log: Approver, Timestamp, Action (APPROVE/REJECT/DELEGATE)
2. Approval comments captured
3. Approval level and sequence tracked
4. Rejection reason required
5. Complete approval chain visible

**Exceptions**:
- None

**Error Messages**:
- None

**Related Requirements**: FR-TR-AUDIT-004

**Related Entities**: ApprovalHistory, AuditLog

---

### BR-TR-AUDIT-005: Bulk Change Logging

**Priority**: MEDIUM

**Description**:
Log bulk changes with batch identifier.

**Conditions**:
```
WHEN bulk operation performed
THEN log as batch
```

**Rules**:
1. Batch ID links all changes in bulk operation
2. Log: Batch ID, User, Timestamp, Operation type, Record count
3. Individual record changes also logged
4. Batch summary includes success/failure counts
5. Rollback capability for failed batches

**Exceptions**:
- None

**Error Messages**:
- None

**Related Requirements**: FR-TR-AUDIT-005

**Related Entities**: AuditLog, BatchOperation

---

### BR-TR-AUDIT-006: Automated vs Manual Change Differentiation

**Priority**: MEDIUM

**Description**:
Differentiate between automated and manual changes.

**Conditions**:
```
WHEN logging change
THEN mark as AUTOMATED or MANUAL
```

**Rules**:
1. Change source: MANUAL (user action) or AUTOMATED (system process)
2. Automated: Payroll runs, vesting events, accruals, expirations
3. Manual: User edits, approvals, corrections
4. Source clearly indicated in audit log
5. Filtering by source in reports

**Exceptions**:
- None

**Error Messages**:
- None

**Related Requirements**: FR-TR-AUDIT-006

**Related Entities**: AuditLog

---

### BR-TR-AUDIT-007: Version History Maintenance

**Priority**: MEDIUM

**Description**:
Maintain version history for key entities.

**Conditions**:
```
WHEN entity changes
THEN create new version
```

**Rules**:
1. Versioned entities: Compensation, Benefits, Equity grants, Tax elections
2. Each version has: Version number, Effective date, End date, is_current flag
3. Previous versions retained (SCD Type 2)
4. Point-in-time queries supported
5. Version comparison available

**Exceptions**:
- None

**Error Messages**:
- None

**Related Requirements**: FR-TR-AUDIT-007

**Related Entities**: VersionHistory

---

### BR-TR-AUDIT-008: Data Retention Management

**Priority**: HIGH

**Description**:
Manage data retention per legal requirements.

**Conditions**:
```
WHEN data older than retention period
THEN archive or delete
```

**Rules**:
1. Retention periods: 7 years (default), varies by data type
2. Active employees: All data retained
3. Terminated employees: Retain per legal requirements
4. Audit logs: 7 years minimum
5. Legal hold: Retain indefinitely

**Exceptions**:
- Legal hold: Cannot delete

**Error Messages**:
- None

**Related Requirements**: FR-TR-AUDIT-008

**Related Entities**: RetentionPolicy, AuditLog

---

## Category: Access Logging

### BR-TR-AUDIT-009: Data Access Logging

**Priority**: HIGH

**Description**:
Log all access to sensitive TR data.

**Conditions**:
```
WHEN sensitive data accessed
THEN log access event
```

**Rules**:
1. Log: User, Timestamp, Action (VIEW/EXPORT/PRINT), Entity type, Entity ID
2. Sensitive data: Salary, SSN, bank account, tax info
3. Access purpose documented (for RESTRICTED data)
4. IP address and session ID captured
5. Access patterns monitored for anomalies

**Exceptions**:
- Employee accessing own data: Not logged (or logged separately)

**Error Messages**:
- None

**Related Requirements**: FR-TR-AUDIT-009

**Related Entities**: AccessLog, AuditLog

---

### BR-TR-AUDIT-010: Sensitive Data Access Alerts

**Priority**: HIGH

**Description**:
Alert on suspicious access to sensitive data.

**Conditions**:
```
IF access pattern suspicious
THEN alert security team
```

**Rules**:
1. Triggers: Bulk access, after-hours access, unusual user, multiple failures
2. Alert: Security team, DPO, HR leadership
3. Alert includes: User, Data accessed, Time, Pattern detected
4. Investigation workflow triggered
5. Access can be blocked pending investigation

**Exceptions**:
- None

**Error Messages**:
- None

**Related Requirements**: FR-TR-AUDIT-010

**Related Entities**: AccessLog, SecurityAlert

---

### BR-TR-AUDIT-011: Role-Based Access Audit

**Priority**: MEDIUM

**Description**:
Audit role-based access control effectiveness.

**Conditions**:
```
WHEN access granted or denied
THEN log with role information
```

**Rules**:
1. Log: User, Role, Permission, Resource, Action, Result (GRANTED/DENIED)
2. Track role assignments and changes
3. Periodic access reviews
4. Identify over-privileged users
5. Generate access reports

**Exceptions**:
- None

**Error Messages**:
- None

**Related Requirements**: FR-TR-AUDIT-011

**Related Entities**: AccessLog, Role, Permission

---

### BR-TR-AUDIT-012: Failed Access Attempt Logging

**Priority**: HIGH

**Description**:
Log failed access attempts for security monitoring.

**Conditions**:
```
WHEN access denied
THEN log failed attempt
```

**Rules**:
1. Log: User, Timestamp, Resource, Reason for denial
2. Track repeated failures (potential attack)
3. Alert after threshold (e.g., 5 failures in 10 minutes)
4. IP address and session info captured
5. Account lockout after excessive failures

**Exceptions**:
- None

**Error Messages**:
- None

**Related Requirements**: FR-TR-AUDIT-012

**Related Entities**: AccessLog, SecurityAlert

---

### BR-TR-AUDIT-013: Session Tracking

**Priority**: MEDIUM

**Description**:
Track user sessions for audit purposes.

**Conditions**:
```
WHEN user logs in/out
THEN track session
```

**Rules**:
1. Log: Login time, Logout time, Session duration, IP address
2. Track concurrent sessions
3. Session timeout after inactivity
4. Force logout on security events
5. Session history for investigation

**Exceptions**:
- None

**Error Messages**:
- None

**Related Requirements**: FR-TR-AUDIT-013

**Related Entities**: SessionLog, AuditLog

---

## Category: Compliance Audit

### BR-TR-AUDIT-014: SOX Compliance Audit Trail

**Priority**: HIGH

**Description**:
Maintain SOX-compliant audit trail for financial data.

**Conditions**:
```
WHEN financial data changes
THEN ensure SOX compliance
```

**Rules**:
1. SOX scope: Compensation, bonuses, equity, payroll
2. Complete audit trail: Who, What, When, Why
3. Segregation of duties enforced
4. Approval workflows documented
5. Audit trail immutable and tamper-proof

**Exceptions**:
- None

**Error Messages**:
- None

**Related Requirements**: FR-TR-AUDIT-014

**Related Entities**: AuditLog, SOXControl

---

### BR-TR-AUDIT-015: GDPR Compliance Tracking

**Priority**: HIGH

**Description**:
Track GDPR compliance for personal data.

**Conditions**:
```
WHEN personal data processed
THEN ensure GDPR compliance
```

**Rules**:
1. Log: Data access, processing purpose, legal basis
2. Consent tracking for data processing
3. Data subject requests logged (access, rectification, erasure)
4. Data breach notification process
5. Privacy impact assessments documented

**Exceptions**:
- None

**Error Messages**:
- None

**Related Requirements**: FR-TR-AUDIT-015

**Related Entities**: GDPRLog, ConsentRecord

---

### BR-TR-AUDIT-016: Regulatory Compliance Reporting

**Priority**: HIGH

**Description**:
Generate compliance reports for regulators.

**Conditions**:
```
WHEN compliance report requested
THEN generate audit report
```

**Rules**:
1. Report types: SOX, GDPR, SOC 2, ISO 27001
2. Include: Controls tested, Results, Exceptions, Remediation
3. Audit-ready format
4. Evidence attachments
5. Executive summary

**Exceptions**:
- None

**Error Messages**:
- None

**Related Requirements**: FR-TR-AUDIT-016

**Related Entities**: ComplianceReport, AuditLog

---

### BR-TR-AUDIT-017: Audit Trail Export

**Priority**: MEDIUM

**Description**:
Export audit trail for external auditors.

**Conditions**:
```
WHEN audit trail export requested
THEN generate export file
```

**Rules**:
1. Export formats: CSV, JSON, XML
2. Filter by: Date range, Entity type, User, Action
3. Include all audit fields
4. Encrypted export for sensitive data
5. Export history tracked

**Exceptions**:
- None

**Error Messages**:
- `ERR_AUDIT_017`: "Audit trail export failed: {reason}."

**Related Requirements**: FR-TR-AUDIT-017

**Related Entities**: AuditLog, AuditExport

---

### BR-TR-AUDIT-018: Audit Alerting

**Priority**: MEDIUM

**Description**:
Alert on audit events requiring attention.

**Conditions**:
```
IF audit event meets alert criteria
THEN send alert
```

**Rules**:
1. Alert triggers: Sensitive data change, bulk operation, failed access, unusual pattern
2. Alert recipients: Security team, DPO, HR leadership, Compliance
3. Alert channels: Email, SMS, Dashboard notification
4. Alert severity: INFO, WARNING, CRITICAL
5. Alert acknowledgment tracked

**Exceptions**:
- None

**Error Messages**:
- None

**Related Requirements**: FR-TR-AUDIT-018

**Related Entities**: AuditAlert, AuditLog

---

## Category: Audit Reporting

### BR-TR-AUDIT-019: Audit Summary Reports

**Priority**: MEDIUM

**Description**:
Generate summary reports of audit activity.

**Conditions**:
```
WHEN audit report requested
THEN generate summary
```

**Rules**:
1. Report types: Daily, Weekly, Monthly, On-demand
2. Metrics: Total changes, Changes by type, Changes by user, Access events
3. Visualizations: Charts, graphs, trends
4. Drill-down to detail
5. Scheduled delivery

**Exceptions**:
- None

**Error Messages**:
- None

**Related Requirements**: FR-TR-AUDIT-019

**Related Entities**: AuditReport, AuditLog

---

### BR-TR-AUDIT-020: Exception Reports

**Priority**: MEDIUM

**Description**:
Generate reports of audit exceptions.

**Conditions**:
```
WHEN exception detected
THEN include in exception report
```

**Rules**:
1. Exceptions: Changes without approval, Access without authorization, Policy violations
2. Exception details: User, Timestamp, Violation type, Severity
3. Investigation status tracked
4. Remediation actions documented
5. Escalation for unresolved exceptions

**Exceptions**:
- None

**Error Messages**:
- None

**Related Requirements**: FR-TR-AUDIT-020

**Related Entities**: ExceptionReport, AuditLog

---

### BR-TR-AUDIT-021: Trend Analysis

**Priority**: LOW

**Description**:
Analyze audit trends over time.

**Conditions**:
```
WHEN analyzing audit data
THEN identify trends
```

**Rules**:
1. Trends: Change volume, Access patterns, User activity, Error rates
2. Time periods: Daily, Weekly, Monthly, Quarterly, Annual
3. Anomaly detection
4. Predictive analytics
5. Trend visualizations

**Exceptions**:
- None

**Error Messages**:
- None

**Related Requirements**: FR-TR-AUDIT-021

**Related Entities**: AuditAnalytics, AuditLog

---

### BR-TR-AUDIT-022: Compliance Dashboards

**Priority**: MEDIUM

**Description**:
Provide real-time compliance dashboards.

**Conditions**:
```
WHEN dashboard accessed
THEN display compliance metrics
```

**Rules**:
1. Metrics: Compliance score, Open issues, Remediation status, Audit coverage
2. Real-time updates
3. Drill-down capability
4. Role-based views
5. Export to PDF/Excel

**Exceptions**:
- None

**Error Messages**:
- None

**Related Requirements**: FR-TR-AUDIT-022

**Related Entities**: ComplianceDashboard, AuditLog

---

### BR-TR-AUDIT-023: Audit Trail Search

**Priority**: HIGH

**Description**:
Enable search and filtering of audit trail.

**Conditions**:
```
WHEN searching audit trail
THEN apply filters and return results
```

**Rules**:
1. Search criteria: Date range, User, Entity type, Action, Field changed
2. Full-text search on change reason and comments
3. Advanced filters: AND/OR logic
4. Results sorted by timestamp (desc)
5. Export search results

**Exceptions**:
- None

**Error Messages**:
- None

**Related Requirements**: FR-TR-AUDIT-023

**Related Entities**: AuditLog

---

### BR-TR-AUDIT-024: Forensic Analysis

**Priority**: HIGH

**Description**:
Support forensic analysis of audit data.

**Conditions**:
```
WHEN investigating incident
THEN provide forensic tools
```

**Rules**:
1. Timeline reconstruction: All events for entity or user
2. Change correlation: Related changes across entities
3. User activity tracking: All actions by user
4. Data lineage: Track data from source to current state
5. Evidence preservation

**Exceptions**:
- None

**Error Messages**:
- None

**Related Requirements**: FR-TR-AUDIT-024

**Related Entities**: AuditLog, ForensicReport

---

### BR-TR-AUDIT-025: Audit Log Integrity Verification

**Priority**: HIGH

**Description**:
Verify integrity of audit logs (tamper detection).

**Conditions**:
```
WHEN verifying audit log integrity
THEN check for tampering
```

**Rules**:
1. Cryptographic hashing of audit records
2. Chain of custody maintained
3. Periodic integrity checks
4. Alert on tampering detection
5. Immutable storage (write-once)

**Exceptions**:
- None

**Error Messages**:
- `ERR_AUDIT_025`: "Audit log integrity violation detected."

**Related Requirements**: FR-TR-AUDIT-025

**Related Entities**: AuditLog, IntegrityCheck

---

## Summary: Audit Rules

**Total Rules**: 25  
**Priority Breakdown**:
- HIGH: 18 rules (72%)
- MEDIUM: 7 rules (28%)

**Categories**:
1. Change Tracking (8 rules)
2. Access Logging (5 rules)
3. Compliance Audit (5 rules)
4. Audit Reporting (7 rules)

**Key Highlights**:
- Complete audit trail (7-year retention)
- Before/after value capture
- Change reason documentation
- Sensitive data access logging
- SOX and GDPR compliance
- Real-time alerting
- Forensic analysis capabilities
- Tamper-proof audit logs

---

**Status**: âœ… Audit Rules Complete (25/25)
