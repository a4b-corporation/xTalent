# Data Specification - Deductions

**Version**: 1.0  
**Last Updated**: 2025-12-16  
**Module**: Total Rewards (TR) - Deductions  
**Status**: Draft

---

## Document Information

- **Purpose**: Define data validation rules and constraints for Deductions entities
- **Audience**: Backend Developers, Database Administrators, QA Engineers
- **Scope**: Deduction definitions, employee deductions, and transactions
- **Related Documents**:
  - [TR Ontology](../../00-ontology/tr-ontology.yaml) - Entity definitions
  - [API Specification](./02-api-specification.md) - API contracts
  - [Business Rules](./04-business-rules.md) - Business logic

---

## Table of Contents

1. [Deduction Definition Entities](#deduction-definition-entities)
2. [Employee Deduction Entities](#employee-deduction-entities)
3. [Deduction Transaction Entities](#deduction-transaction-entities)
4. [Common Validation Patterns](#common-validation-patterns)
5. [Enumeration Definitions](#enumeration-definitions)

---

# Deduction Definition Entities

## DeductionDefinition

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `code` | String | Yes | Unique, max 50 chars, pattern: `^[A-Z0-9_]+$` | Unique code |
| `name` | String | Yes | Max 200 chars | Display name |
| `description` | String | No | Max 500 chars | Optional description |
| `deductionType` | Enum | Yes | See DeductionType | Deduction type |
| `category` | Enum | Yes | See DeductionCategory | Category |
| `calculationType` | Enum | Yes | See CalculationType | Calculation type |
| `amount` | Decimal | Conditional | > 0 | Required if FIXED_AMOUNT |
| `percentage` | Decimal | Conditional | 0-100 | Required if PERCENTAGE |
| `formula` | String | Conditional | Max 1000 chars | Required if FORMULA |
| `priority` | Integer | Yes | >= 1, <= 100 | Deduction priority |
| `isRecurring` | Boolean | Yes | - | Default: true |
| `country` | String | Yes | ISO 3166-1 alpha-2 | Country code |
| `isActive` | Boolean | Yes | - | Default: true |
| `effectiveDate` | Date | Yes | >= today (unless retroactive) | Start date |
| `endDate` | Date | No | > effectiveDate | End date |
| `createdBy` | UUID | Yes | Must exist in User | Creator |
| `createdAt` | Timestamp | Yes | - | System-generated |
| `updatedAt` | Timestamp | Yes | >= createdAt | System-generated |

### Cross-Field Rules

**Rule 1: Calculation Type Requirements**
- If `calculationType` = FIXED_AMOUNT, then `amount` is required
- If `calculationType` = PERCENTAGE, then `percentage` is required
- If `calculationType` = FORMULA, then `formula` is required

**Rule 2: Deduction Type Rules**
- PRE_TAX: Deducted before tax calculation
- POST_TAX: Deducted after tax calculation
- COURT_ORDERED: Legal deductions (garnishments)

**Rule 3: Priority Order**
- Lower priority number = higher priority
- Court-ordered deductions typically have priority 1-10
- Voluntary deductions typically have priority 50-100

**Rule 4: Formula Validation**
- If `calculationType` = FORMULA, validate formula syntax
- Formula can reference: BASE_SALARY, GROSS_PAY, NET_PAY

### Business Validations

**Country-Specific Rules**
- Validate deduction complies with country regulations
- Check maximum deduction limits

**Category Validation**
- VOLUNTARY: Employee-elected deductions
- MANDATORY: Required by law or policy
- COURT_ORDERED: Legal garnishments

---

# Employee Deduction Entities

## EmployeeDeduction

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `employeeId` | UUID | Yes | Must exist in Worker | Employee |
| `deductionId` | UUID | Yes | Must exist in DeductionDefinition | Deduction |
| `amount` | Decimal | Conditional | > 0 | Required if FIXED_AMOUNT |
| `percentage` | Decimal | Conditional | 0-100 | Required if PERCENTAGE |
| `startDate` | Date | Yes | - | Deduction start |
| `endDate` | Date | No | > startDate | Deduction end |
| `status` | Enum | Yes | See DeductionStatus | Deduction status |
| `suspendedUntil` | Date | No | > today | Suspension end date |
| `reason` | String | No | Max 500 chars | Deduction reason |
| `totalDeducted` | Decimal | Yes | >= 0 | Total amount deducted |
| `createdAt` | Timestamp | Yes | - | System-generated |
| `updatedAt` | Timestamp | Yes | >= createdAt | System-generated |

### Cross-Field Rules

**Rule 1: Amount/Percentage Requirement**
- If deduction's calculationType = FIXED_AMOUNT, then `amount` is required
- If deduction's calculationType = PERCENTAGE, then `percentage` is required
- If deduction's calculationType = FORMULA, neither amount nor percentage needed

**Rule 2: Status Lifecycle**
- ACTIVE: Currently deducting
- SUSPENDED: Temporarily suspended
- COMPLETED: Deduction completed
- CANCELLED: Deduction cancelled

**Rule 3: Suspension Rules**
- If `status` = SUSPENDED, then `suspendedUntil` is required
- Automatically reactivate when suspendedUntil date passes

**Rule 4: End Date Validation**
- If `endDate` is set, must be > `startDate`
- When endDate passes, status changes to COMPLETED

### Business Validations

**Maximum Deduction Limits**
- Total deductions cannot exceed legal limits (e.g., 50% of net pay)
- Validate against country-specific regulations

**Duplicate Check**
- Employee cannot have duplicate active deductions of same type
- Check for existing active deduction before creating new one

---

# Deduction Transaction Entities

## DeductionTransaction

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `employeeDeductionId` | UUID | Yes | Must exist in EmployeeDeduction | Employee deduction |
| `employeeId` | UUID | Yes | Must exist in Worker | Employee |
| `payPeriodId` | UUID | Yes | Must exist in PayPeriod | Pay period |
| `transactionDate` | Date | Yes | - | Transaction date |
| `grossAmount` | Decimal | Yes | >= 0 | Gross pay amount |
| `deductionAmount` | Decimal | Yes | >= 0 | Deducted amount |
| `currency` | String | Yes | ISO 4217 | Currency code |
| `status` | Enum | Yes | See TransactionStatus | Transaction status |
| `processedAt` | Timestamp | No | - | Processing timestamp |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Deduction Calculation**
- Calculate `deductionAmount` based on deduction's calculation type
- FIXED_AMOUNT: Use fixed amount
- PERCENTAGE: `deductionAmount` = grossAmount * (percentage / 100)
- FORMULA: Evaluate formula with current pay data

**Rule 2: Status Transitions**
- PENDING → PROCESSED → PAID
- If `status` = PROCESSED, then `processedAt` is required

**Rule 3: Amount Validation**
- `deductionAmount` <= `grossAmount`
- Cannot deduct more than gross pay

### Business Validations

**Pay Period Validation**
- Transaction must be within valid pay period
- One transaction per employee deduction per pay period

**Total Deduction Tracking**
- Update EmployeeDeduction's `totalDeducted` after each transaction
- Track cumulative deductions

---

# Common Validation Patterns

## Date Validations

**Past Date Check**
```
startDate can be in past for retroactive deductions
```

**Date Range**
```
endDate > startDate
suspendedUntil > today
```

## Amount Validations

All amounts:
- Precision: 2 decimal places
- Rounding: HALF_UP
- Must be non-negative

## Percentage Validations

```
percentage >= 0 and <= 100
```

## Priority Validations

```
priority >= 1 and <= 100
Lower number = higher priority
```

---

# Enumeration Definitions

## DeductionType

```
PRE_TAX         - Pre-tax deduction
POST_TAX        - Post-tax deduction
COURT_ORDERED   - Court-ordered garnishment
```

## DeductionCategory

```
VOLUNTARY       - Voluntary deduction
MANDATORY       - Mandatory deduction
COURT_ORDERED   - Court-ordered deduction
```

## CalculationType

```
FIXED_AMOUNT    - Fixed amount per period
PERCENTAGE      - Percentage of gross/net pay
FORMULA         - Formula-based calculation
```

## DeductionStatus

```
ACTIVE          - Active deduction
SUSPENDED       - Temporarily suspended
COMPLETED       - Deduction completed
CANCELLED       - Deduction cancelled
```

## TransactionStatus

```
PENDING         - Pending processing
PROCESSED       - Processed
PAID            - Paid to recipient
```

---

## Document Status

**Status**: Complete - All Deductions entities documented  
**Coverage**:
- ✅ Deduction Definition Entities (1 entity)
- ✅ Employee Deduction Entities (1 entity)
- ✅ Deduction Transaction Entities (1 entity)

**Total Entities**: 3 entities with complete validation rules  
**Total Lines**: ~150 lines

**Last Updated**: 2025-12-16  
**Next**: 03.08-DS-tax-withholding.md
