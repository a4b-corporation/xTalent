# Data Specification - Taxable Bridge

**Version**: 1.0  
**Last Updated**: 2025-12-16  
**Module**: Total Rewards (TR) - Taxable Bridge  
**Status**: Draft

---

## Document Information

- **Purpose**: Define data validation rules and constraints for Taxable Bridge entities
- **Audience**: Backend Developers, Database Administrators, QA Engineers
- **Scope**: Taxable items and processing for payroll integration
- **Related Documents**:
  - [TR Ontology](../../00-ontology/tr-ontology.yaml) - Entity definitions
  - [API Specification](./02-api-specification.md) - API contracts
  - [Business Rules](./04-business-rules.md) - Business logic

---

## Table of Contents

1. [Taxable Item Entities](#taxable-item-entities)
2. [Processing Entities](#processing-entities)
3. [Common Validation Patterns](#common-validation-patterns)
4. [Enumeration Definitions](#enumeration-definitions)

---

# Taxable Item Entities

## TaxableItem

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `employeeId` | UUID | Yes | Must exist in Worker | Employee |
| `itemType` | Enum | Yes | See TaxableItemType | Item type |
| `sourceId` | UUID | Yes | - | Source entity ID |
| `sourceType` | String | Yes | Max 100 chars | Source entity type |
| `taxableAmount` | Decimal | Yes | > 0 | Taxable amount |
| `taxPeriod` | String | Yes | Format: YYYY-MM | Tax period |
| `taxYear` | Integer | Yes | >= 2000, <= 2100 | Tax year |
| `description` | String | Yes | Max 500 chars | Item description |
| `w2BoxMapping` | JSON | Conditional | - | W-2 box mapping (US) |
| `currency` | String | Yes | ISO 4217 | Currency code |
| `status` | Enum | Yes | See TaxableItemStatus | Item status |
| `processedAt` | Timestamp | No | - | Processing timestamp |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Source Reference**
- `sourceId` and `sourceType` identify the originating transaction
- Common source types:
  - EquityVestingEvent: Equity vesting
  - BonusAllocation: Bonus payment
  - PerkRedemption: Perk redemption
  - BenefitEnrollment: Imputed income from benefits

**Rule 2: Tax Period Format**
- `taxPeriod` must be valid YYYY-MM format
- Example: "2025-12"

**Rule 3: Tax Year Derivation**
- `taxYear` derived from `taxPeriod`
- Example: "2025-12" → taxYear = 2025

**Rule 4: W-2 Box Mapping (US)**
- If country = US, then `w2BoxMapping` is required
- Maps taxable amount to W-2 boxes
```json
{
  "box1": 100000000,  // Wages, tips, other compensation
  "box12": [
    {"code": "V", "amount": 100000000}  // Stock options
  ]
}
```

**Rule 5: Status Transitions**
- PENDING → PROCESSED → PAID
- If `status` = PROCESSED, then `processedAt` is required

### Business Validations

**Item Type Validation**
- EQUITY_VESTING: From equity vesting events
- BONUS: From bonus allocations
- PERK_REDEMPTION: From perk redemptions (if taxable)
- IMPUTED_INCOME: From benefits (e.g., life insurance over $50K)

**Tax Treatment**
- Verify correct tax treatment for item type
- Apply appropriate withholding rates

**Payroll Integration**
- Create taxable items for payroll processing
- Ensure items are included in correct pay period

---

# Processing Entities

## TaxableItemProcessing

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `taxPeriod` | String | Yes | Format: YYYY-MM | Tax period |
| `processingType` | Enum | Yes | See ProcessingType | Processing type |
| `employeeIds` | Array | Conditional | - | Employee IDs (if batch) |
| `status` | Enum | Yes | See ProcessingStatus | Processing status |
| `totalItems` | Integer | Yes | >= 0 | Total items |
| `processedItems` | Integer | Yes | >= 0, <= totalItems | Processed items |
| `failedItems` | Integer | Yes | >= 0, <= totalItems | Failed items |
| `totalTaxableAmount` | Decimal | Yes | >= 0 | Total taxable amount |
| `totalTaxWithheld` | Decimal | Yes | >= 0 | Total tax withheld |
| `currency` | String | Yes | ISO 4217 | Currency code |
| `errorLog` | String | No | - | Error log |
| `startedAt` | Timestamp | Yes | - | Start timestamp |
| `completedAt` | Timestamp | No | - | Completion timestamp |
| `createdBy` | UUID | Yes | Must exist in User | Creator |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Item Count Validation**
```
totalItems = processedItems + failedItems
```

**Rule 2: Processing Type Rules**
- INDIVIDUAL: Process single employee
- BATCH: Process multiple employees
- PERIOD_END: Process all items for period

**Rule 3: Employee IDs Requirement**
- If `processingType` = INDIVIDUAL or BATCH, then `employeeIds` is required
- If `processingType` = PERIOD_END, then `employeeIds` may be null

**Rule 4: Status Transitions**
- PENDING → PROCESSING → COMPLETED/FAILED
- If `status` = COMPLETED or FAILED, then `completedAt` is required

**Rule 5: Error Logging**
- If `failedItems` > 0, then `errorLog` should be populated
- Track which items failed and why

### Business Validations

**Processing Validation**
- Verify all pending items for period are processed
- Ensure no duplicate processing

**Tax Calculation**
- Calculate tax withholding for each item
- Update TaxableItem status after processing

**Payroll Integration**
- Send processed items to payroll system
- Track integration status

---

# Common Validation Patterns

## Date Validations

**Tax Period Format**
```
taxPeriod must match pattern: ^\d{4}-(0[1-9]|1[0-2])$
Examples: "2025-01", "2025-12"
```

**Tax Year Validation**
```
taxYear >= 2000 and <= 2100
```

## Amount Validations

All amounts:
- Precision: 2 decimal places
- Rounding: HALF_UP
- Must be non-negative

## Count Validations

```
processedItems + failedItems = totalItems
processedItems >= 0
failedItems >= 0
```

## Source Reference Validation

```
sourceId must reference existing entity
sourceType must be valid entity type
```

---

# Enumeration Definitions

## TaxableItemType

```
EQUITY_VESTING      - Equity vesting event
BONUS               - Bonus payment
PERK_REDEMPTION     - Perk redemption (if taxable)
IMPUTED_INCOME      - Imputed income from benefits
```

## TaxableItemStatus

```
PENDING         - Pending processing
PROCESSED       - Processed for tax
PAID            - Included in payroll
CANCELLED       - Cancelled
```

## ProcessingType

```
INDIVIDUAL      - Process single employee
BATCH           - Process multiple employees
PERIOD_END      - Process all items for period
```

## ProcessingStatus

```
PENDING         - Pending processing
PROCESSING      - Processing in progress
COMPLETED       - Processing completed
FAILED          - Processing failed
```

---

## Document Status

**Status**: Complete - All Taxable Bridge entities documented  
**Coverage**:
- ✅ Taxable Item Entities (1 entity)
- ✅ Processing Entities (1 entity)

**Total Entities**: 2 entities with complete validation rules  
**Total Lines**: ~100 lines

**Last Updated**: 2025-12-16  
**Next**: 03.10-DS-audit.md (Phase 4)
