# Data Specification - Tax Withholding

**Version**: 1.0  
**Last Updated**: 2025-12-16  
**Module**: Total Rewards (TR) - Tax Withholding  
**Status**: Draft

---

## Document Information

- **Purpose**: Define data validation rules and constraints for Tax Withholding entities
- **Audience**: Backend Developers, Database Administrators, QA Engineers
- **Scope**: Tax jurisdictions, elections, calculations, withholding, and reporting
- **Related Documents**:
  - [TR Ontology](../../00-ontology/tr-ontology.yaml) - Entity definitions
  - [API Specification](./02-api-specification.md) - API contracts
  - [Business Rules](./04-business-rules.md) - Business logic

---

## Table of Contents

1. [Tax Jurisdiction Entities](#tax-jurisdiction-entities)
2. [Tax Election Entities](#tax-election-entities)
3. [Tax Calculation Entities](#tax-calculation-entities)
4. [Tax Withholding Entities](#tax-withholding-entities)
5. [Tax Reporting Entities](#tax-reporting-entities)
6. [Common Validation Patterns](#common-validation-patterns)
7. [Enumeration Definitions](#enumeration-definitions)

---

# Tax Jurisdiction Entities

## TaxJurisdiction

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `code` | String | Yes | Unique, max 50 chars | Unique code |
| `name` | String | Yes | Max 200 chars | Jurisdiction name |
| `country` | String | Yes | ISO 3166-1 alpha-2 | Country code |
| `jurisdictionType` | Enum | Yes | See JurisdictionType | Jurisdiction type |
| `taxType` | Enum | Yes | See TaxType | Tax type |
| `progressiveTiers` | JSON | Conditional | - | Required if progressive |
| `flatRate` | Decimal | Conditional | 0-100 | Required if flat rate |
| `isActive` | Boolean | Yes | - | Default: true |
| `effectiveDate` | Date | Yes | >= today (unless retroactive) | Start date |
| `endDate` | Date | No | > effectiveDate | End date |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Tax Rate Structure**
- If progressive tax, then `progressiveTiers` is required
- If flat tax, then `flatRate` is required
- Cannot have both progressive tiers and flat rate

**Rule 2: Progressive Tiers Structure**
```json
[
  {"minIncome": 0, "maxIncome": 60000000, "rate": 5.0},
  {"minIncome": 60000001, "maxIncome": 120000000, "rate": 10.0}
]
```
- Tiers must not overlap
- Tiers must cover full income range

**Rule 3: Jurisdiction Type Rules**
- NATIONAL: Country-level tax (e.g., Vietnam PIT)
- STATE: State/province tax (e.g., California state tax)
- LOCAL: City/county tax

### Business Validations

**Country-Specific Validation**
- Validate tax structure matches country regulations
- VN: 7-tier progressive income tax
- US: Federal + state + local taxes
- SG: Progressive income tax

---

# Tax Election Entities

## TaxElection

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `employeeId` | UUID | Yes | Must exist in Worker | Employee |
| `taxYear` | Integer | Yes | >= 2000, <= 2100 | Tax year |
| `country` | String | Yes | ISO 3166-1 alpha-2 | Country code |
| `filingStatus` | Enum | Yes | See FilingStatus | Filing status |
| `dependents` | Integer | Yes | >= 0 | Number of dependents |
| `additionalWithholding` | Decimal | Yes | >= 0 | Additional withholding amount |
| `exemptFromWithholding` | Boolean | Yes | - | Default: false |
| `w4Data` | JSON | Conditional | - | W-4 form data (US) |
| `effectiveDate` | Date | Yes | - | Effective date |
| `createdAt` | Timestamp | Yes | - | System-generated |
| `updatedAt` | Timestamp | Yes | >= createdAt | System-generated |

### Cross-Field Rules

**Rule 1: Country-Specific Fields**
- If `country` = US, then `w4Data` is required
- W-4 data includes: allowances, extra withholding, exempt status

**Rule 2: Dependent Limits**
- `dependents` typically 0-10
- Validate against reasonable limits

**Rule 3: Exempt Status**
- If `exemptFromWithholding` = true, must meet legal requirements
- Typically for low-income employees

**Rule 4: Uniqueness**
- One active election per employee per tax year per country

### Business Validations

**Election Validation**
- Validate filing status is appropriate for employee
- Check dependent eligibility

---

# Tax Calculation Entities

## TaxCalculation

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `employeeId` | UUID | Yes | Must exist in Worker | Employee |
| `payPeriodId` | UUID | Yes | Must exist in PayPeriod | Pay period |
| `grossIncome` | Decimal | Yes | >= 0 | Gross income |
| `taxableIncome` | Decimal | Yes | >= 0, <= grossIncome | Taxable income |
| `totalTax` | Decimal | Yes | >= 0 | Total tax calculated |
| `effectiveRate` | Decimal | Yes | 0-100 | Effective tax rate % |
| `breakdown` | JSON | Yes | - | Tax breakdown by jurisdiction |
| `calculationDate` | Date | Yes | - | Calculation date |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Taxable Income**
- `taxableIncome` <= `grossIncome`
- Difference is pre-tax deductions

**Rule 2: Effective Rate Calculation**
```
effectiveRate = (totalTax / taxableIncome) * 100
```

**Rule 3: Breakdown Structure**
```json
[
  {
    "jurisdictionId": "uuid",
    "jurisdictionName": "Vietnam PIT",
    "taxableIncome": 45000000,
    "taxAmount": 4500000,
    "rate": 10.0
  }
]
```
- Sum of breakdown taxAmounts = totalTax

### Business Validations

**Calculation Accuracy**
- Verify tax calculation matches jurisdiction rules
- Apply correct progressive tiers or flat rate

**Deduction Application**
- Apply standard deductions
- Apply dependent deductions
- Calculate taxable income correctly

---

# Tax Withholding Entities

## TaxWithholding

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `employeeId` | UUID | Yes | Must exist in Worker | Employee |
| `taxCalculationId` | UUID | Yes | Must exist in TaxCalculation | Tax calculation |
| `payPeriodId` | UUID | Yes | Must exist in PayPeriod | Pay period |
| `jurisdictionId` | UUID | Yes | Must exist in TaxJurisdiction | Jurisdiction |
| `withheldAmount` | Decimal | Yes | >= 0 | Amount withheld |
| `currency` | String | Yes | ISO 4217 | Currency code |
| `withholdingDate` | Date | Yes | - | Withholding date |
| `status` | Enum | Yes | See WithholdingStatus | Status |
| `remittedAt` | Timestamp | No | - | Remittance timestamp |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Amount Validation**
- `withheldAmount` should match calculated tax for jurisdiction
- Cannot withhold more than calculated tax

**Rule 2: Status Transitions**
- WITHHELD → REMITTED
- If `status` = REMITTED, then `remittedAt` is required

**Rule 3: Currency Consistency**
- `currency` must match jurisdiction's country currency

### Business Validations

**Remittance Tracking**
- Track when taxes are remitted to authorities
- Ensure timely remittance

---

# Tax Reporting Entities

## TaxReport

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `reportType` | Enum | Yes | See ReportType | Report type |
| `taxYear` | Integer | Yes | >= 2000, <= 2100 | Tax year |
| `country` | String | Yes | ISO 3166-1 alpha-2 | Country code |
| `employeeIds` | Array | Conditional | - | Employee IDs (if applicable) |
| `reportData` | JSON | Yes | - | Report data |
| `fileFormat` | Enum | Yes | PDF, CSV, XML | File format |
| `filePath` | String | No | - | Generated file path |
| `status` | Enum | Yes | See ReportStatus | Report status |
| `generatedAt` | Timestamp | No | - | Generation timestamp |
| `createdBy` | UUID | Yes | Must exist in User | Creator |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Report Type Requirements**
- W2 (US): Annual wage and tax statement
- 1099 (US): Miscellaneous income
- PIT_ANNUAL (VN): Annual PIT report
- IR8A (SG): Annual return of employee's remuneration

**Rule 2: Employee IDs**
- If report type is individual (W2, IR8A), then `employeeIds` is required
- If report type is summary, then `employeeIds` may be null

**Rule 3: Status Transitions**
- PENDING → GENERATING → COMPLETED/FAILED
- If `status` = COMPLETED, then `generatedAt` and `filePath` are required

### Business Validations

**Report Accuracy**
- Validate report data against tax calculations
- Ensure all required fields are populated

**Compliance**
- Reports must meet regulatory requirements
- Include all required disclosures

---

# Common Validation Patterns

## Date Validations

**Tax Year Validation**
```
taxYear >= 2000 and <= 2100
```

**Effective Date**
```
effectiveDate typically January 1 of tax year
```

## Amount Validations

All amounts:
- Precision: 2 decimal places
- Rounding: HALF_UP
- Must be non-negative

## Rate Validations

Tax rates and percentages:
- Range: 0-100
- Precision: 2 decimal places
- Example: 5.00, 10.00, 35.00

## Progressive Tier Validations

```
Tiers must not overlap
Each tier: minIncome < maxIncome
Tiers must be sequential
```

---

# Enumeration Definitions

## JurisdictionType

```
NATIONAL        - National/federal tax
STATE           - State/province tax
LOCAL           - City/county tax
```

## TaxType

```
INCOME_TAX      - Income tax
SOCIAL_INSURANCE - Social insurance
MEDICARE        - Medicare tax
UNEMPLOYMENT    - Unemployment tax
```

## FilingStatus

```
SINGLE          - Single
MARRIED         - Married filing jointly
MARRIED_SEPARATE - Married filing separately
HEAD_OF_HOUSEHOLD - Head of household
```

## WithholdingStatus

```
WITHHELD        - Tax withheld
REMITTED        - Remitted to authority
```

## ReportType

```
W2              - W-2 form (US)
1099            - 1099 form (US)
PIT_ANNUAL      - Annual PIT report (VN)
IR8A            - IR8A form (SG)
```

## ReportStatus

```
PENDING         - Pending generation
GENERATING      - Generating report
COMPLETED       - Report completed
FAILED          - Generation failed
```

---

## Document Status

**Status**: Complete - All Tax Withholding entities documented  
**Coverage**:
- ✅ Tax Jurisdiction Entities (1 entity)
- ✅ Tax Election Entities (1 entity)
- ✅ Tax Calculation Entities (1 entity)
- ✅ Tax Withholding Entities (1 entity)
- ✅ Tax Reporting Entities (1 entity)

**Total Entities**: 5 entities with complete validation rules  
**Total Lines**: ~250 lines

**Last Updated**: 2025-12-16  
**Next**: 03.09-DS-taxable-bridge.md
