# Data Specification - Calculation

**Version**: 1.0  
**Last Updated**: 2025-12-16  
**Module**: Total Rewards (TR) - Calculation  
**Status**: Draft

---

## Document Information

- **Purpose**: Define data validation rules and constraints for Calculation entities
- **Audience**: Backend Developers, Database Administrators, QA Engineers
- **Scope**: Calculation engines, formulas, results, and versioning
- **Related Documents**:
  - [TR Ontology](../../00-ontology/tr-ontology.yaml) - Entity definitions
  - [API Specification](./02-api-specification.md) - API contracts
  - [Business Rules](./04-business-rules.md) - Business logic

---

## Table of Contents

1. [Calculation Engine Entities](#calculation-engine-entities)
2. [Calculation Result Entities](#calculation-result-entities)
3. [Common Validation Patterns](#common-validation-patterns)
4. [Enumeration Definitions](#enumeration-definitions)

---

# Calculation Engine Entities

## CalculationFormula

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `code` | String | Yes | Unique, max 50 chars, pattern: `^[A-Z0-9_]+$` | Unique code |
| `name` | String | Yes | Max 200 chars | Formula name |
| `description` | String | No | Max 500 chars | Optional description |
| `formulaType` | Enum | Yes | See FormulaType | Formula type |
| `expression` | String | Yes | Max 5000 chars | Formula expression |
| `variables` | JSON | Yes | - | Variable definitions |
| `validationRules` | JSON | No | - | Validation rules |
| `version` | Integer | Yes | >= 1 | Formula version |
| `isActive` | Boolean | Yes | - | Default: true |
| `effectiveDate` | Date | Yes | >= today (unless retroactive) | Start date |
| `endDate` | Date | No | > effectiveDate | End date |
| `createdBy` | UUID | Yes | Must exist in User | Creator |
| `createdAt` | Timestamp | Yes | - | System-generated |
| `updatedAt` | Timestamp | Yes | >= createdAt | System-generated |

### Cross-Field Rules

**Rule 1: Expression Syntax**
- Must be valid mathematical expression
- Supported operators: +, -, *, /, %, ^, ()
- Supported functions: SUM, AVG, MIN, MAX, ROUND, IF, LOOKUP

**Rule 2: Variables Structure**
```json
[
  {
    "name": "BASE_SALARY",
    "type": "DECIMAL",
    "required": true,
    "defaultValue": null
  }
]
```
- All variables in expression must be defined
- Variable names must be uppercase with underscores

**Rule 3: Formula Type Rules**
- COMPENSATION: Salary, bonus calculations
- PRORATION: Proration calculations
- TAX: Tax calculations
- BENEFIT: Benefit premium calculations
- CUSTOM: Custom formulas

**Rule 4: Version Management**
- New version created when formula changes
- Old version remains for historical calculations
- Only one active version per formula code

### Business Validations

**Expression Validation**
- Parse and validate expression syntax
- Check for circular references
- Verify all variables are defined

**Testing Requirements**
- Test formula with sample data before activation
- Validate results against expected outcomes

---

## CalculationEngine

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `engineName` | String | Yes | Max 200 chars | Engine name |
| `engineType` | Enum | Yes | See EngineType | Engine type |
| `formulaIds` | Array | Yes | - | Formula IDs used |
| `executionOrder` | JSON | Yes | - | Formula execution order |
| `inputSchema` | JSON | Yes | - | Input data schema |
| `outputSchema` | JSON | Yes | - | Output data schema |
| `isActive` | Boolean | Yes | - | Default: true |
| `createdAt` | Timestamp | Yes | - | System-generated |
| `updatedAt` | Timestamp | Yes | >= createdAt | System-generated |

### Cross-Field Rules

**Rule 1: Formula References**
- All `formulaIds` must exist in CalculationFormula
- All formulas must be active

**Rule 2: Execution Order**
```json
[
  {"step": 1, "formulaId": "uuid1", "outputVariable": "GROSS_PAY"},
  {"step": 2, "formulaId": "uuid2", "outputVariable": "TAXABLE_INCOME"}
]
```
- Steps must be sequential
- Output of one step can be input to next

**Rule 3: Schema Validation**
- Input schema defines required input variables
- Output schema defines expected output variables
- Schemas must be valid JSON Schema format

### Business Validations

**Dependency Resolution**
- Resolve formula dependencies
- Ensure no circular dependencies
- Execute in correct order

**Performance**
- Optimize formula execution
- Cache intermediate results where possible

---

# Calculation Result Entities

## CalculationResult

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `calculationType` | Enum | Yes | See CalculationType | Calculation type |
| `entityType` | String | Yes | Max 100 chars | Entity type |
| `entityId` | UUID | Yes | - | Entity ID |
| `formulaId` | UUID | Yes | Must exist in CalculationFormula | Formula used |
| `inputData` | JSON | Yes | - | Input data |
| `outputData` | JSON | Yes | - | Output data |
| `calculatedValue` | Decimal | Yes | - | Primary calculated value |
| `currency` | String | Conditional | ISO 4217 | Required if monetary |
| `calculationDate` | Date | Yes | - | Calculation date |
| `status` | Enum | Yes | See CalculationStatus | Calculation status |
| `errorMessage` | String | Conditional | Max 1000 chars | Required if FAILED |
| `executionTime` | Integer | Yes | >= 0 | Execution time in ms |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Input/Output Data**
- `inputData` must conform to formula's input schema
- `outputData` must conform to formula's output schema

**Rule 2: Status Validation**
- SUCCESS: `calculatedValue` and `outputData` are required
- FAILED: `errorMessage` is required
- PENDING: Calculation not yet executed

**Rule 3: Currency Requirement**
- If calculation involves monetary values, `currency` is required
- Use ISO 4217 currency codes

**Rule 4: Execution Time**
- Track execution time for performance monitoring
- Alert if execution time exceeds threshold

### Business Validations

**Result Validation**
- Validate calculated value is within expected range
- Check for anomalies (e.g., negative salary)

**Audit Trail**
- Store calculation results for audit
- Link to source data and formula version

**Recalculation**
- Support recalculation with different inputs
- Maintain history of all calculations

---

# Common Validation Patterns

## Expression Validation

**Syntax Check**
```
Valid: (BASE_SALARY * 12) + BONUS
Invalid: BASE_SALARY * * 12
```

**Variable Check**
- All variables in expression must be defined
- Variable names must match exactly (case-sensitive)

## JSON Schema Validation

**Input Schema Example**
```json
{
  "type": "object",
  "properties": {
    "baseSalary": {"type": "number", "minimum": 0},
    "bonus": {"type": "number", "minimum": 0}
  },
  "required": ["baseSalary"]
}
```

## Decimal Precision

All calculated values:
- Precision: 2 decimal places for currency
- Precision: 4 decimal places for rates/percentages
- Rounding: HALF_UP

## Performance Metrics

```
executionTime < 1000ms (1 second) for simple calculations
executionTime < 5000ms (5 seconds) for complex calculations
```

---

# Enumeration Definitions

## FormulaType

```
COMPENSATION    - Compensation calculations
PRORATION       - Proration calculations
TAX             - Tax calculations
BENEFIT         - Benefit calculations
CUSTOM          - Custom calculations
```

## EngineType

```
PAYROLL         - Payroll calculation engine
TAX             - Tax calculation engine
BENEFIT         - Benefit calculation engine
PRORATION       - Proration calculation engine
CUSTOM          - Custom calculation engine
```

## CalculationType

```
SALARY          - Salary calculation
BONUS           - Bonus calculation
TAX             - Tax calculation
PRORATION       - Proration calculation
BENEFIT_PREMIUM - Benefit premium calculation
TOTAL_COMP      - Total compensation calculation
```

## CalculationStatus

```
PENDING         - Pending calculation
SUCCESS         - Calculation successful
FAILED          - Calculation failed
RECALCULATING   - Recalculating
```

---

## Document Status

**Status**: Complete - All Calculation entities documented  
**Coverage**:
- âœ… Calculation Engine Entities (2 entities)
- âœ… Calculation Result Entities (1 entity)

**Total Entities**: 3 entities with complete validation rules  
**Total Lines**: ~150 lines

**Last Updated**: 2025-12-16  
**Completion**: This is the final data specification file. All 11 sub-modules complete!

---

## ðŸŽ‰ TR Data Specification Complete

**Total Coverage**:
- **11 Sub-modules**: All documented
- **70 Entities**: All with complete validation rules
- **~4,500 Lines**: Comprehensive specifications
- **Format**: Exact match with TA module

**Files Created**:
1. 03.01-DS-compensation.md (14 entities)
2. 03.02-DS-variable-pay.md (9 entities)
3. 03.03-DS-benefits.md (14 entities)
4. 03.04-DS-recognition.md (7 entities)
5. 03.05-DS-offer-management.md (5 entities)
6. 03.06-DS-tr-statement.md (4 entities)
7. 03.07-DS-deductions.md (3 entities)
8. 03.08-DS-tax-withholding.md (5 entities)
9. 03.09-DS-taxable-bridge.md (2 entities)
10. 03.10-DS-audit.md (4 entities)
11. 03.11-DS-calculation.md (3 entities)

**Next Steps**: Integration with API specification and business rules validation
