# Data Specification - Core Compensation

**Version**: 1.0  
**Last Updated**: 2025-12-16  
**Module**: Total Rewards (TR) - Core Compensation  
**Status**: Draft

---

## Document Information

- **Purpose**: Define data validation rules and constraints for Core Compensation entities
- **Audience**: Backend Developers, Database Administrators, QA Engineers
- **Scope**: Salary basis, pay components, grades, compensation plans, and cycles
- **Related Documents**:
  - [TR Ontology](../../00-ontology/tr-ontology.yaml) - Entity definitions
  - [API Specification](./02-api-specification.md) - API contracts
  - [Business Rules](./04-business-rules.md) - Business logic

---

## Table of Contents

1. [Salary Basis Entities](#salary-basis-entities)
2. [Pay Component Entities](#pay-component-entities)
3. [Grade Entities](#grade-entities)
4. [Compensation Plan Entities](#compensation-plan-entities)
5. [Common Validation Patterns](#common-validation-patterns)
6. [Enumeration Definitions](#enumeration-definitions)

---

## Validation Rule Template

Each entity follows this validation structure:

```yaml
Entity: EntityName
Fields:
  - name: fieldName
    type: dataType
    required: true/false
    constraints:
      - min: value
      - max: value
      - pattern: regex
      - enum: [values]
    default: value
    validation: description
Cross-Field Rules:
  - rule: description
  - condition: when
  - validation: what to check
```

---

# Salary Basis Entities

## SalaryBasis

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `code` | String | Yes | Unique, max 50 chars, pattern: `^[A-Z0-9_]+$` | Unique code |
| `name` | String | Yes | Max 200 chars | Display name |
| `description` | String | No | Max 500 chars | Optional description |
| `country` | String | Yes | ISO 3166-1 alpha-2 | Country code (VN, US, SG) |
| `frequency` | Enum | Yes | See PayFrequency | Payment frequency |
| `currency` | String | Yes | ISO 4217 | Currency code (VND, USD, SGD) |
| `isActive` | Boolean | Yes | - | Default: true |
| `effectiveDate` | Date | Yes | >= today (unless retroactive) | Start date |
| `endDate` | Date | No | > effectiveDate | End date |
| `createdBy` | UUID | Yes | Must exist in User | Creator |
| `createdAt` | Timestamp | Yes | - | System-generated |
| `updatedAt` | Timestamp | Yes | >= createdAt | System-generated |

### Cross-Field Rules

**Rule 1: Date Range Consistency**
- `endDate` must be > `effectiveDate` if provided
- Cannot have overlapping active periods for same country

**Rule 2: Code Uniqueness**
- `code` must be unique across all salary basis definitions
- Pattern: Uppercase letters, numbers, underscores only

**Rule 3: Country-Currency Alignment**
- If `country` = VN, then `currency` should be VND
- If `country` = US, then `currency` should be USD
- If `country` = SG, then `currency` should be SGD

**Rule 4: Component Requirements**
- Must have at least one component mapped (via SalaryBasisComponentMap)
- At least one component must be marked as required

### Business Validations

**Active Period Check**
- Only one active salary basis per country at any time
- Check: No overlapping effectiveDate/endDate ranges for same country

**Component Validation**
- All mapped components must be active
- Required components cannot be removed while basis is active

---

## SalaryBasisComponentMap

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `salaryBasisId` | UUID | Yes | Must exist in SalaryBasis | Valid salary basis |
| `componentId` | UUID | Yes | Must exist in PayComponentDefinition | Valid component |
| `isRequired` | Boolean | Yes | - | Default: false |
| `calculationOrder` | Integer | Yes | >= 1, <= 100 | Execution order |
| `isActive` | Boolean | Yes | - | Default: true |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Uniqueness**
- Composite unique key: (salaryBasisId, componentId)
- Cannot map same component twice to same basis

**Rule 2: Calculation Order**
- `calculationOrder` must be unique within same salaryBasisId
- Components execute in ascending order

**Rule 3: Required Component**
- At least one component per basis must have `isRequired` = true
- Cannot deactivate all required components

### Business Validations

**Component Compatibility**
- Component's country must match salary basis country
- Component must be active to be mapped

---

# Pay Component Entities

## PayComponentDefinition

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `code` | String | Yes | Unique, max 50 chars, pattern: `^[A-Z0-9_]+$` | Unique code |
| `name` | String | Yes | Max 200 chars | Display name |
| `description` | String | No | Max 500 chars | Optional description |
| `category` | Enum | Yes | See ComponentCategory | Component category |
| `type` | Enum | Yes | See ComponentType | FIXED, VARIABLE, CALCULATED |
| `taxTreatment` | Enum | Yes | See TaxTreatment | Tax treatment |
| `siTreatment` | Enum | Yes | See SITreatment | Social insurance treatment |
| `isRecurring` | Boolean | Yes | - | Default: true |
| `isProrated` | Boolean | Yes | - | Default: false |
| `prorationMethod` | Enum | Conditional | See ProrationMethod | Required if isProrated=true |
| `calculationFormula` | String | Conditional | Max 1000 chars | Required if type=CALCULATED |
| `country` | String | Yes | ISO 3166-1 alpha-2 | Country code |
| `isActive` | Boolean | Yes | - | Default: true |
| `effectiveDate` | Date | Yes | >= today (unless retroactive) | Start date |
| `endDate` | Date | No | > effectiveDate | End date |
| `createdBy` | UUID | Yes | Must exist in User | Creator |
| `createdAt` | Timestamp | Yes | - | System-generated |
| `updatedAt` | Timestamp | Yes | >= createdAt | System-generated |

### Cross-Field Rules

**Rule 1: Proration Requirements**
- If `isProrated` = true, then `prorationMethod` is required
- If `isProrated` = false, then `prorationMethod` must be null

**Rule 2: Calculation Formula**
- If `type` = CALCULATED, then `calculationFormula` is required
- If `type` = FIXED or VARIABLE, then `calculationFormula` must be null
- Formula must reference valid component codes or system variables

**Rule 3: Category-Type Alignment**
- If `category` = SALARY, then `type` typically FIXED
- If `category` = BONUS, then `type` typically VARIABLE
- If `category` = OVERTIME, then `type` typically CALCULATED

**Rule 4: Tax Treatment Rules**
- If `category` = DEDUCTION, then `taxTreatment` should be EXEMPT
- If `category` = SALARY or ALLOWANCE, then `taxTreatment` typically TAXABLE

### Business Validations

**Formula Validation**
- Formula syntax must be valid
- Referenced components must exist
- No circular dependencies in calculations

**Component Usage Check**
- Cannot deactivate if component is in use in active salary basis
- Cannot change type or category if component has transactions

---

## ComponentDependency

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `componentId` | UUID | Yes | Must exist in PayComponentDefinition | Dependent component |
| `dependsOnComponentId` | UUID | Yes | Must exist in PayComponentDefinition | Source component |
| `dependencyType` | Enum | Yes | CALCULATION, ELIGIBILITY, PRORATION | Dependency type |
| `isActive` | Boolean | Yes | - | Default: true |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: No Self-Dependency**
- `componentId` must be != `dependsOnComponentId`
- Component cannot depend on itself

**Rule 2: No Circular Dependencies**
- Check: Component A → B → C → A is invalid
- Validate dependency graph has no cycles

**Rule 3: Uniqueness**
- Composite unique key: (componentId, dependsOnComponentId, dependencyType)

### Business Validations

**Dependency Graph Validation**
- Dependency graph must be acyclic (DAG)
- All dependencies must be resolvable

---

## ProrationRule

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `code` | String | Yes | Unique, max 50 chars | Unique code |
| `name` | String | Yes | Max 200 chars | Display name |
| `prorationMethod` | Enum | Yes | CALENDAR_DAYS, WORKING_DAYS, NONE | Method |
| `roundingMode` | Enum | Yes | HALF_UP, HALF_DOWN, UP, DOWN | Rounding |
| `precision` | Integer | Yes | >= 0, <= 4 | Decimal places |
| `country` | String | Yes | ISO 3166-1 alpha-2 | Country code |
| `isActive` | Boolean | Yes | - | Default: true |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Precision Limits**
- `precision` typically 2 for most countries
- Maximum 4 decimal places allowed

**Rule 2: Country-Specific Rules**
- VN: CALENDAR_DAYS, precision 2
- US: WORKING_DAYS, precision 2
- SG: CALENDAR_DAYS, precision 2

---

# Grade Entities

## GradeVersion

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `code` | String | Yes | Unique, max 50 chars | Unique code |
| `name` | String | Yes | Max 200 chars | Display name |
| `description` | String | No | Max 500 chars | Optional description |
| `level` | Integer | Yes | >= 1, <= 20 | Grade level |
| `careerLadderId` | UUID | Yes | Must exist in CareerLadder | Career ladder |
| `minSalary` | Decimal | Yes | > 0 | Minimum salary |
| `midSalary` | Decimal | Yes | > minSalary | Midpoint salary |
| `maxSalary` | Decimal | Yes | > midSalary | Maximum salary |
| `currency` | String | Yes | ISO 4217 | Currency code |
| `spread` | Decimal | Yes | > 0, calculated | Salary spread % |
| `isActive` | Boolean | Yes | - | Default: true |
| `effectiveDate` | Date | Yes | >= today (unless retroactive) | Start date |
| `endDate` | Date | No | > effectiveDate | End date |
| `createdBy` | UUID | Yes | Must exist in User | Creator |
| `createdAt` | Timestamp | Yes | - | System-generated |
| `updatedAt` | Timestamp | Yes | >= createdAt | System-generated |

### Cross-Field Rules

**Rule 1: Salary Range Consistency**
- `minSalary` < `midSalary` < `maxSalary`
- All three must be in same currency

**Rule 2: Spread Calculation**
```
spread = ((maxSalary - minSalary) / midSalary) * 100
```
- Typically 40-80% for most grades

**Rule 3: Level Uniqueness**
- Within same careerLadderId, level must be unique for active grades
- Cannot have two active grades with same level in same ladder

**Rule 4: Version Control**
- When creating new version, previous version should be end-dated
- effectiveDate of new version = endDate + 1 day of previous version

### Business Validations

**Market Competitiveness**
- Salary ranges should align with market data
- Spread should be reasonable (typically 40-80%)

**Grade Progression**
- Higher levels should have higher salary ranges
- Ranges can overlap but midpoints should be distinct

---

## GradeLadder

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `code` | String | Yes | Unique, max 50 chars | Unique code |
| `name` | String | Yes | Max 200 chars | Display name |
| `description` | String | No | Max 500 chars | Optional description |
| `ladderType` | Enum | Yes | MANAGEMENT, TECHNICAL, SPECIALIST, EXECUTIVE | Ladder type |
| `country` | String | Yes | ISO 3166-1 alpha-2 | Country code |
| `isActive` | Boolean | Yes | - | Default: true |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Uniqueness**
- Composite unique key: (code, country)
- Each country can have multiple ladders

**Rule 2: Ladder Requirements**
- Must have at least 3 grades defined
- Grades must cover consecutive levels (no gaps)

---

## GradeLadderGrade

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `ladderId` | UUID | Yes | Must exist in GradeLadder | Career ladder |
| `gradeId` | UUID | Yes | Must exist in GradeVersion | Grade |
| `sequence` | Integer | Yes | >= 1 | Display order |
| `isActive` | Boolean | Yes | - | Default: true |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Uniqueness**
- Composite unique key: (ladderId, gradeId)
- Composite unique key: (ladderId, sequence)

**Rule 2: Sequence Continuity**
- Sequences should be continuous (1, 2, 3, ...)
- No gaps in sequence numbers

---

## GradeLadderStep

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `gradeId` | UUID | Yes | Must exist in GradeVersion | Grade |
| `stepNumber` | Integer | Yes | >= 1, <= 10 | Step number |
| `stepSalary` | Decimal | Yes | >= grade.minSalary, <= grade.maxSalary | Step salary |
| `isActive` | Boolean | Yes | - | Default: true |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Step Salary Range**
- `stepSalary` must be between grade's minSalary and maxSalary
- Steps should be evenly distributed across range

**Rule 2: Step Progression**
- Step 1 salary should be close to minSalary
- Last step salary should be close to maxSalary
- Steps should increase monotonically

**Rule 3: Uniqueness**
- Composite unique key: (gradeId, stepNumber)

---

## PayRange

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `gradeId` | UUID | Yes | Must exist in GradeVersion | Grade |
| `componentId` | UUID | Yes | Must exist in PayComponentDefinition | Component |
| `minAmount` | Decimal | Yes | >= 0 | Minimum amount |
| `maxAmount` | Decimal | Yes | > minAmount | Maximum amount |
| `currency` | String | Yes | ISO 4217 | Currency code |
| `isActive` | Boolean | Yes | - | Default: true |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Amount Range**
- `maxAmount` must be > `minAmount`
- Both must be in same currency as grade

**Rule 2: Currency Consistency**
- `currency` must match grade's currency

**Rule 3: Uniqueness**
- Composite unique key: (gradeId, componentId)

---

# Compensation Plan Entities

## CompensationPlan

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `code` | String | Yes | Unique, max 50 chars | Unique code |
| `name` | String | Yes | Max 200 chars | Display name |
| `description` | String | No | Max 500 chars | Optional description |
| `planType` | Enum | Yes | MERIT, PROMOTION, MARKET_ADJUSTMENT, EQUITY | Plan type |
| `country` | String | Yes | ISO 3166-1 alpha-2 | Country code |
| `budgetAmount` | Decimal | No | >= 0 | Total budget |
| `currency` | String | Yes | ISO 4217 | Currency code |
| `isActive` | Boolean | Yes | - | Default: true |
| `effectiveDate` | Date | Yes | >= today (unless retroactive) | Start date |
| `endDate` | Date | No | > effectiveDate | End date |
| `createdBy` | UUID | Yes | Must exist in User | Creator |
| `createdAt` | Timestamp | Yes | - | System-generated |
| `updatedAt` | Timestamp | Yes | >= createdAt | System-generated |

### Cross-Field Rules

**Rule 1: Budget Tracking**
- If `budgetAmount` is set, track allocations against budget
- Sum of all adjustments should not exceed budget

**Rule 2: Plan Type Rules**
- MERIT plans typically annual
- PROMOTION plans ad-hoc
- MARKET_ADJUSTMENT plans periodic

---

## CompensationCycle

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `planId` | UUID | Yes | Must exist in CompensationPlan | Compensation plan |
| `cycleYear` | Integer | Yes | >= 2000, <= 2100 | Cycle year |
| `cycleName` | String | Yes | Max 200 chars | Cycle name |
| `status` | Enum | Yes | See CycleStatus | Cycle status |
| `startDate` | Date | Yes | - | Cycle start |
| `endDate` | Date | Yes | > startDate | Cycle end |
| `budgetAmount` | Decimal | No | >= 0 | Cycle budget |
| `allocatedAmount` | Decimal | Yes | >= 0, <= budgetAmount | Allocated amount |
| `approvedBy` | UUID | No | Must exist if status=APPROVED | Approver |
| `approvedAt` | Timestamp | No | - | Approval timestamp |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Date Range**
- `endDate` must be > `startDate`
- Typically spans one year for annual cycles

**Rule 2: Budget Allocation**
- `allocatedAmount` <= `budgetAmount` (if budget set)
- Track allocations in real-time

**Rule 3: Status Transitions**
- Valid transitions:
  - DRAFT → ACTIVE (start cycle)
  - ACTIVE → CLOSED (end cycle)
  - ACTIVE → CANCELLED (cancel cycle)

---

## CompensationAdjustment

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `cycleId` | UUID | Yes | Must exist in CompensationCycle | Cycle |
| `employeeId` | UUID | Yes | Must exist in Worker | Employee |
| `adjustmentType` | Enum | Yes | MERIT, PROMOTION, MARKET, EQUITY | Adjustment type |
| `componentId` | UUID | Yes | Must exist in PayComponentDefinition | Component |
| `currentAmount` | Decimal | Yes | >= 0 | Current amount |
| `newAmount` | Decimal | Yes | >= 0 | New amount |
| `adjustmentAmount` | Decimal | Yes | Can be negative | Change amount |
| `adjustmentPercent` | Decimal | Yes | Can be negative | Change % |
| `effectiveDate` | Date | Yes | >= cycle.startDate | Effective date |
| `reason` | String | No | Max 500 chars | Adjustment reason |
| `status` | Enum | Yes | See AdjustmentStatus | Status |
| `approvedBy` | UUID | No | Must exist if approved | Approver |
| `approvedAt` | Timestamp | No | - | Approval timestamp |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Amount Calculations**
```
adjustmentAmount = newAmount - currentAmount
adjustmentPercent = (adjustmentAmount / currentAmount) * 100
```

**Rule 2: Effective Date**
- `effectiveDate` must be within cycle's date range
- Cannot be in the past (unless retroactive allowed)

**Rule 3: Status Transitions**
- DRAFT → PENDING → APPROVED/REJECTED → EFFECTIVE

### Business Validations

**Budget Check**
- Sum of all adjustments should not exceed cycle budget
- Check available budget before approval

**Grade Range Check**
- New amount should be within grade's pay range
- Warn if outside range (but allow with justification)

---

## EmployeeCompensationSnapshot

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `employeeId` | UUID | Yes | Must exist in Worker | Employee |
| `snapshotDate` | Date | Yes | - | Snapshot date |
| `salaryBasisId` | UUID | Yes | Must exist in SalaryBasis | Salary basis |
| `gradeId` | UUID | No | Must exist in GradeVersion | Grade |
| `totalCompensation` | Decimal | Yes | >= 0 | Total comp |
| `currency` | String | Yes | ISO 4217 | Currency |
| `components` | JSON | Yes | - | Component breakdown |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Snapshot Immutability**
- Snapshots are immutable once created
- Create new snapshot for changes

**Rule 2: Component Breakdown**
- `components` JSON must include all active components
- Sum of components should equal totalCompensation

---

# Common Validation Patterns

## Date Validations

**Past Date Check**
```
date >= today (unless retroactive allowed)
```

**Date Range Check**
```
endDate > startDate
```

**Effective Date Overlap**
```
No overlapping effectiveDate/endDate ranges for same entity
```

## Decimal Precision

All decimal fields (amounts, percentages):
- Precision: 2 decimal places
- Rounding: HALF_UP
- Example: 45000000.00, 15.50, 8.25

## String Validations

**Code Fields**
- Pattern: `^[A-Z0-9_]+$`
- Max length: 50 characters
- Unique within entity type

**Name Fields**
- Max length: 200 characters
- Required, non-empty

**Description Fields**
- Max length: 500 characters
- Optional

## UUID Validations

All UUID fields:
- Format: RFC 4122
- Example: `550e8400-e29b-41d4-a716-446655440000`
- Must reference existing entity (foreign key)

## Currency Validations

**Currency Codes**
- ISO 4217 format
- Supported: VND, USD, SGD
- Must match country context

**Amount Formatting**
- VND: No decimal places (whole numbers)
- USD/SGD: 2 decimal places

---

# Enumeration Definitions

## PayFrequency

```
HOURLY          - Hourly rate
DAILY           - Daily rate
WEEKLY          - Weekly payment
BI_WEEKLY       - Every two weeks
SEMI_MONTHLY    - Twice per month
MONTHLY         - Monthly payment
ANNUAL          - Annual salary
```

## ComponentCategory

```
SALARY          - Base salary
ALLOWANCE       - Allowances
BONUS           - Bonuses
EQUITY          - Equity compensation
DEDUCTION       - Deductions
OVERTIME        - Overtime pay
```

## ComponentType

```
FIXED           - Fixed amount
VARIABLE        - Variable amount
CALCULATED      - Calculated from formula
```

## TaxTreatment

```
FULLY_TAXABLE       - Fully taxable
PARTIALLY_EXEMPT    - Partially tax-exempt
FULLY_EXEMPT        - Fully tax-exempt
```

## SITreatment

```
SUBJECT_TO_SI       - Subject to social insurance
EXEMPT_FROM_SI      - Exempt from social insurance
```

## ProrationMethod

```
CALENDAR_DAYS       - Based on calendar days
WORKING_DAYS        - Based on working days
NONE                - No proration
```

## CycleStatus

```
DRAFT           - Draft cycle
ACTIVE          - Active cycle
CLOSED          - Closed cycle
CANCELLED       - Cancelled cycle
```

## AdjustmentStatus

```
DRAFT           - Draft adjustment
PENDING         - Pending approval
APPROVED        - Approved
REJECTED        - Rejected
EFFECTIVE       - Effective (applied)
```

---

## Document Status

**Status**: Complete - All Core Compensation entities documented  
**Coverage**:
- ✅ Salary Basis Entities (5 entities)
- ✅ Pay Component Entities (3 entities)
- ✅ Grade Entities (5 entities)
- ✅ Compensation Plan Entities (4 entities)

**Total Entities**: 14 entities with complete validation rules  
**Total Lines**: ~750 lines

**Last Updated**: 2025-12-16  
**Next**: 03.02-DS-variable-pay.md
