# Data Specification - Audit

**Version**: 1.0  
**Last Updated**: 2025-12-16  
**Module**: Total Rewards (TR) - Audit  
**Status**: Draft

---

## Document Information

- **Purpose**: Define data validation rules and constraints for Audit entities
- **Audience**: Backend Developers, Database Administrators, QA Engineers
- **Scope**: Audit logs, change tracking, compliance reporting, and data retention
- **Related Documents**:
  - [TR Ontology](../../00-ontology/tr-ontology.yaml) - Entity definitions
  - [API Specification](./02-api-specification.md) - API contracts
  - [Business Rules](./04-business-rules.md) - Business logic

---

## Table of Contents

1. [Audit Log Entities](#audit-log-entities)
2. [Change Tracking Entities](#change-tracking-entities)
3. [Compliance Entities](#compliance-entities)
4. [Common Validation Patterns](#common-validation-patterns)
5. [Enumeration Definitions](#enumeration-definitions)

---

# Audit Log Entities

## AuditLog

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `entityType` | String | Yes | Max 100 chars | Entity type name |
| `entityId` | UUID | Yes | - | Entity ID |
| `action` | Enum | Yes | See AuditAction | Action performed |
| `userId` | UUID | Yes | Must exist in User | User who performed action |
| `timestamp` | Timestamp | Yes | - | Action timestamp |
| `ipAddress` | String | No | Valid IP format | Client IP address |
| `userAgent` | String | No | Max 500 chars | Client user agent |
| `previousValue` | JSON | Conditional | - | Required if UPDATE |
| `newValue` | JSON | Conditional | - | Required if UPDATE/CREATE |
| `changeDescription` | String | No | Max 1000 chars | Human-readable description |
| `severity` | Enum | Yes | See AuditSeverity | Audit severity level |
| `category` | Enum | Yes | See AuditCategory | Audit category |
| `metadata` | JSON | No | - | Additional context |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Action-Specific Requirements**
- If `action` = CREATE, then `newValue` is required
- If `action` = UPDATE, then both `previousValue` and `newValue` are required
- If `action` = DELETE, then `previousValue` is required
- If `action` = VIEW, then values may be null

**Rule 2: Timestamp Validation**
- `timestamp` should be close to `createdAt` (within seconds)
- Used for action time vs log creation time

**Rule 3: IP Address Format**
- IPv4: `xxx.xxx.xxx.xxx`
- IPv6: Valid IPv6 format
- Can be null for system actions

**Rule 4: Severity Assignment**
- CREATE/UPDATE/DELETE of sensitive data: HIGH
- Configuration changes: MEDIUM
- READ operations: LOW
- System actions: INFO

### Business Validations

**Immutability**
- Audit logs are immutable once created
- No updates or deletes allowed

**Retention Policy**
- Retain audit logs for minimum 7 years (compliance)
- Archive old logs to cold storage

**Sensitive Data Masking**
- Mask PII in audit logs (SSN, salary, etc.)
- Store masked version in `previousValue`/`newValue`

---

## AuditTrail

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `entityType` | String | Yes | Max 100 chars | Entity type name |
| `entityId` | UUID | Yes | - | Entity ID |
| `versionNumber` | Integer | Yes | >= 1 | Version number |
| `changeType` | Enum | Yes | See ChangeType | Type of change |
| `changedBy` | UUID | Yes | Must exist in User | User who made change |
| `changedAt` | Timestamp | Yes | - | Change timestamp |
| `fieldChanges` | JSON | Yes | - | Detailed field changes |
| `reason` | String | No | Max 500 chars | Change reason |
| `approvedBy` | UUID | No | Must exist if approved | Approver |
| `approvedAt` | Timestamp | No | - | Approval timestamp |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Version Increment**
- `versionNumber` increments with each change
- First version = 1
- Sequential, no gaps

**Rule 2: Field Changes Structure**
```json
[
  {
    "field": "salary",
    "oldValue": "100000000",
    "newValue": "120000000",
    "changeType": "UPDATE"
  }
]
```

**Rule 3: Approval Requirements**
- If change requires approval, then `approvedBy` and `approvedAt` are required
- Approval timestamp must be >= change timestamp

### Business Validations

**Change Tracking**
- Track all material changes to TR entities
- Compensation, benefits, equity changes always tracked

**Compliance Reporting**
- Generate audit reports for compliance
- Support SOX, GDPR, local regulations

---

# Change Tracking Entities

## DataChangeLog

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `tableName` | String | Yes | Max 100 chars | Database table name |
| `recordId` | UUID | Yes | - | Record ID |
| `operation` | Enum | Yes | INSERT, UPDATE, DELETE | Database operation |
| `columnName` | String | Conditional | Max 100 chars | Required if UPDATE |
| `oldValue` | String | Conditional | Max 5000 chars | Required if UPDATE/DELETE |
| `newValue` | String | Conditional | Max 5000 chars | Required if INSERT/UPDATE |
| `changedBy` | UUID | Yes | Must exist in User | User who made change |
| `changedAt` | Timestamp | Yes | - | Change timestamp |
| `transactionId` | String | No | Max 100 chars | Database transaction ID |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Operation-Specific Requirements**
- INSERT: `newValue` required, `oldValue` null
- UPDATE: Both `oldValue` and `newValue` required, `columnName` required
- DELETE: `oldValue` required, `newValue` null

**Rule 2: Value Storage**
- Store values as strings for consistency
- Preserve original data type information in metadata

**Rule 3: Transaction Grouping**
- Multiple changes in same transaction share `transactionId`
- Used for rollback scenarios

### Business Validations

**Database-Level Tracking**
- Capture all DML operations on TR tables
- Use database triggers or CDC (Change Data Capture)

**Performance Considerations**
- Batch insert change logs to avoid performance impact
- Async processing where possible

---

# Compliance Entities

## ComplianceReport

### Field Validations

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | - | System-generated |
| `reportType` | Enum | Yes | See ReportType | Report type |
| `reportPeriod` | String | Yes | Format: YYYY-MM or YYYY-Q1 | Reporting period |
| `country` | String | Yes | ISO 3166-1 alpha-2 | Country code |
| `generatedBy` | UUID | Yes | Must exist in User | Generator |
| `generatedAt` | Timestamp | Yes | - | Generation timestamp |
| `reportData` | JSON | Yes | - | Report data |
| `fileFormat` | Enum | Yes | PDF, CSV, XML, JSON | File format |
| `filePath` | String | No | - | Generated file path |
| `status` | Enum | Yes | See ReportStatus | Report status |
| `submittedAt` | Timestamp | No | - | Submission timestamp |
| `submittedBy` | UUID | No | Must exist if submitted | Submitter |
| `createdAt` | Timestamp | Yes | - | System-generated |

### Cross-Field Rules

**Rule 1: Report Period Format**
- Monthly: `YYYY-MM` (e.g., "2025-12")
- Quarterly: `YYYY-Q1`, `YYYY-Q2`, `YYYY-Q3`, `YYYY-Q4`
- Annual: `YYYY`

**Rule 2: Status Transitions**
- DRAFT → GENERATED → REVIEWED → SUBMITTED
- If `status` = SUBMITTED, then `submittedAt` and `submittedBy` are required

**Rule 3: Report Type Rules**
- SOX_COMPLIANCE: Sarbanes-Oxley compliance
- GDPR_DATA_ACCESS: GDPR data access report
- PAYROLL_AUDIT: Payroll audit report
- BENEFIT_COMPLIANCE: Benefits compliance report

### Business Validations

**Regulatory Requirements**
- Generate reports per regulatory schedule
- Ensure data accuracy and completeness

**Audit Trail**
- Maintain audit trail of all compliance reports
- Track who generated, reviewed, submitted

**Data Retention**
- Retain compliance reports for required period
- Typically 7-10 years depending on regulation

---

# Common Validation Patterns

## Timestamp Validations

**Chronological Order**
```
changedAt <= createdAt
approvedAt >= changedAt
```

**Timestamp Precision**
- Store timestamps with millisecond precision
- Use UTC timezone

## JSON Structure Validations

**Field Changes**
```json
{
  "field": "string",
  "oldValue": "any",
  "newValue": "any",
  "changeType": "enum"
}
```

**Metadata**
- Flexible structure
- Common fields: source, reason, context

## Immutability

```
Audit logs cannot be updated or deleted
Only INSERT operations allowed
```

---

# Enumeration Definitions

## AuditAction

```
CREATE          - Record created
UPDATE          - Record updated
DELETE          - Record deleted
VIEW            - Record viewed
EXPORT          - Data exported
IMPORT          - Data imported
APPROVE         - Approval granted
REJECT          - Approval rejected
```

## AuditSeverity

```
INFO            - Informational
LOW             - Low severity
MEDIUM          - Medium severity
HIGH            - High severity
CRITICAL        - Critical severity
```

## AuditCategory

```
COMPENSATION    - Compensation changes
BENEFITS        - Benefits changes
EQUITY          - Equity changes
TAX             - Tax-related changes
SECURITY        - Security events
COMPLIANCE      - Compliance events
SYSTEM          - System events
```

## ChangeType

```
CREATED         - Entity created
MODIFIED        - Entity modified
DELETED         - Entity deleted
APPROVED        - Change approved
REJECTED        - Change rejected
```

## ReportType

```
SOX_COMPLIANCE      - SOX compliance report
GDPR_DATA_ACCESS    - GDPR data access report
PAYROLL_AUDIT       - Payroll audit report
BENEFIT_COMPLIANCE  - Benefits compliance report
TAX_AUDIT           - Tax audit report
```

## ReportStatus

```
DRAFT           - Draft report
GENERATED       - Report generated
REVIEWED        - Report reviewed
SUBMITTED       - Report submitted
```

---

## Document Status

**Status**: Complete - All Audit entities documented  
**Coverage**:
- ✅ Audit Log Entities (1 entity)
- ✅ Change Tracking Entities (2 entities)
- ✅ Compliance Entities (1 entity)

**Total Entities**: 4 entities with complete validation rules  
**Total Lines**: ~200 lines

**Last Updated**: 2025-12-16  
**Next**: 03.11-DS-calculation.md (Final)
